class e{constructor(e={}){this.maxMemorySize=e.maxMemorySize||104857600,this.maxCacheEntries=e.maxCacheEntries||50,this.persistenceEnabled=!1!==e.persistenceEnabled,this.compressionEnabled=!1!==e.compressionEnabled,this.ttl=e.ttl||864e5,this.memoryCache=new Map,this.accessOrder=new Map,this.memorySizeUsed=0,this.persistentCache=null,this.initializePersistence(),this.metrics={hits:0,misses:0,evictions:0,compressionSavings:0,averageCompressionRatio:0,persistenceHits:0,persistenceMisses:0},this.cleanupInterval=setInterval(()=>{this.performMaintenance()},3e5)}async initializePersistence(){if(this.persistenceEnabled&&"undefined"!=typeof indexedDB)try{this.persistentCache=await this.openIndexedDB()}catch(e){this.persistenceEnabled=!1}}openIndexedDB(){return new Promise((e,t)=>{const s=indexedDB.open("WaveformCache",1);s.onerror=()=>t(s.error),s.onsuccess=()=>{const t=s.result;e(t)},s.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("waveforms")){const e=t.createObjectStore("waveforms",{keyPath:"key"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("size","size",{unique:!1})}}})}generateCacheKey(e,t={}){const s={source:this.getSourceIdentifier(e),sampleRate:t.sampleRate||1e3,quality:t.quality||"medium",analysisMethod:t.analysisMethod||"auto",duration:t.duration||0};return this.hashObject(s)}async get(e){const t=this.getFromMemory(e);if(t)return this.metrics.hits++,t;if(this.persistenceEnabled&&this.persistentCache){const t=await this.getFromPersistent(e);if(t)return this.metrics.persistenceHits++,this.metrics.hits++,this.setInMemory(e,t),t;this.metrics.persistenceMisses++}return this.metrics.misses++,null}async set(e,t,s={}){const r={key:e,data:t,metadata:{...s,timestamp:Date.now(),accessCount:1,size:this.calculateDataSize(t)}};if(this.compressionEnabled){const e=await this.compressData(r);if(e.size<r.metadata.size){const t=r.metadata.size-e.size;this.metrics.compressionSavings+=t,this.updateCompressionRatio(r.metadata.size,e.size),r.compressed=!0,r.data=e.data,r.metadata.size=e.size}}this.setInMemory(e,r),this.persistenceEnabled&&this.persistentCache&&await this.setInPersistent(e,r)}getFromMemory(e){const t=this.memoryCache.get(e);if(!t)return null;if(Date.now()-t.metadata.timestamp>this.ttl)return this.memoryCache.delete(e),this.accessOrder.delete(e),this.memorySizeUsed-=t.metadata.size,null;if(this.accessOrder.set(e,Date.now()),t.metadata.accessCount++,t.compressed){const e=this.decompressData(t);return{...t,data:e,compressed:!1}}return t}setInMemory(e,t){for(;this.memorySizeUsed+t.metadata.size>this.maxMemorySize||this.memoryCache.size>=this.maxCacheEntries;)this.evictLRU();if(this.memoryCache.has(e)){const t=this.memoryCache.get(e);this.memorySizeUsed-=t.metadata.size}this.memoryCache.set(e,t),this.accessOrder.set(e,Date.now()),this.memorySizeUsed+=t.metadata.size}async getFromPersistent(e){if(!this.persistentCache)return null;try{const t=this.persistentCache.transaction(["waveforms"],"readonly"),s=t.objectStore("waveforms").get(e);return new Promise((t,r)=>{s.onsuccess=()=>{const r=s.result;if(r){if(Date.now()-r.timestamp>this.ttl)return this.deleteFromPersistent(e),void t(null);if(r.compressed){const e=this.decompressData(r);t({...r,data:e,compressed:!1})}else t(r)}else t(null)},s.onerror=()=>r(s.error)})}catch(t){return null}}async setInPersistent(e,t){if(this.persistentCache)try{const s=this.persistentCache.transaction(["waveforms"],"readwrite"),r=s.objectStore("waveforms"),i={key:e,data:t.data,metadata:t.metadata,compressed:t.compressed||!1,timestamp:t.metadata.timestamp,size:t.metadata.size};return r.put(i),new Promise((e,t)=>{s.oncomplete=()=>e(),s.onerror=()=>t(s.error)})}catch(s){}}async deleteFromPersistent(e){if(this.persistentCache)try{const t=this.persistentCache.transaction(["waveforms"],"readwrite");t.objectStore("waveforms").delete(e)}catch(t){}}evictLRU(){if(0===this.accessOrder.size)return;let e=null,t=Date.now();for(const[s,r]of this.accessOrder)r<t&&(t=r,e=s);if(e){const t=this.memoryCache.get(e);t&&(this.memorySizeUsed-=t.metadata.size),this.memoryCache.delete(e),this.accessOrder.delete(e),this.metrics.evictions++}}async compressData(e){try{const t=JSON.stringify(e.data);if("undefined"!=typeof CompressionStream){const e=new CompressionStream("gzip"),s=e.writable.getWriter(),r=e.readable.getReader();s.write((new TextEncoder).encode(t)),s.close();const i=[];let a=!1;for(;!a;){const{value:e,done:t}=await r.read();a=t,e&&i.push(e)}const n=new Uint8Array(i.reduce((e,t)=>e+t.length,0));let o=0;for(const t of i)n.set(t,o),o+=t.length;return{data:n,size:n.length,originalSize:t.length}}{const e=this.simpleCompress(t);return{data:e,size:e.length,originalSize:t.length}}}catch(t){return{data:e.data,size:e.metadata.size,originalSize:e.metadata.size}}}decompressData(e){try{return e.data instanceof Uint8Array?this.simpleDecompress((new TextDecoder).decode(e.data)):"string"==typeof e.data?this.simpleDecompress(e.data):e.data}catch(t){return e.data}}simpleCompress(e){let t="",s=1,r=e[0];for(let i=1;i<e.length;i++)e[i]===r&&s<255?s++:(t+=String.fromCharCode(s)+r,r=e[i],s=1);return t+=String.fromCharCode(s)+r,t}simpleDecompress(e){try{return JSON.parse(e)}catch{let t="";for(let s=0;s<e.length;s+=2){const r=e.charCodeAt(s);t+=e[s+1].repeat(r)}return JSON.parse(t)}}calculateDataSize(e){return e instanceof ArrayBuffer?e.byteLength:e instanceof Float32Array||e instanceof Uint8Array?e.length*e.BYTES_PER_ELEMENT:"string"==typeof e?2*e.length:2*JSON.stringify(e).length}getSourceIdentifier(e){return"string"==typeof e?e:e&&e.videoId?`youtube:${e.videoId}`:e&&e.src?e.src:"unknown"}hashObject(e){const t=JSON.stringify(e,Object.keys(e).sort());let s=0;for(let r=0;r<t.length;r++){s=(s<<5)-s+t.charCodeAt(r),s&=s}return`waveform_${Math.abs(s).toString(36)}`}updateCompressionRatio(e,t){const s=t/e,r=this.metrics.hits+this.metrics.misses;this.metrics.averageCompressionRatio=(this.metrics.averageCompressionRatio*(r-1)+s)/r}async performMaintenance(){const e=Date.now(),t=[];for(const[s,r]of this.memoryCache)e-r.metadata.timestamp>this.ttl&&t.push(s);for(const s of t){const e=this.memoryCache.get(s);e&&(this.memorySizeUsed-=e.metadata.size),this.memoryCache.delete(s),this.accessOrder.delete(s)}this.persistenceEnabled&&this.persistentCache&&await this.cleanExpiredPersistent(),this.memorySizeUsed>.8*this.maxMemorySize&&this.optimizeMemoryUsage()}async cleanExpiredPersistent(){try{const e=this.persistentCache.transaction(["waveforms"],"readwrite"),t=e.objectStore("waveforms").index("timestamp"),s=Date.now()-this.ttl,r=IDBKeyRange.upperBound(s);t.openCursor(r).onsuccess=e=>{const t=e.target.result;t&&(t.delete(),t.continue())}}catch(e){}}optimizeMemoryUsage(){const e=Array.from(this.memoryCache.entries()).map(([e,t])=>({key:e,entry:t,score:t.metadata.accessCount*(Date.now()-t.metadata.timestamp)}));e.sort((e,t)=>e.score-t.score);const t=Math.floor(.25*e.length);for(let s=0;s<t;s++){const{key:t,entry:r}=e[s];this.memorySizeUsed-=r.metadata.size,this.memoryCache.delete(t),this.accessOrder.delete(t),this.metrics.evictions++}}getStats(){const e=this.metrics.hits/(this.metrics.hits+this.metrics.misses)||0,t=this.metrics.persistenceHits/this.metrics.persistenceMisses||0;return{memoryCache:{entries:this.memoryCache.size,sizeUsed:this.memorySizeUsed,maxSize:this.maxMemorySize,utilizationPercent:this.memorySizeUsed/this.maxMemorySize*100},performance:{hitRate:100*e,persistentHitRate:100*t,totalHits:this.metrics.hits,totalMisses:this.metrics.misses,evictions:this.metrics.evictions},compression:{enabled:this.compressionEnabled,totalSavings:this.metrics.compressionSavings,averageRatio:this.metrics.averageCompressionRatio},persistence:{enabled:this.persistenceEnabled,hits:this.metrics.persistenceHits,misses:this.metrics.persistenceMisses}}}async clear(){if(this.memoryCache.clear(),this.accessOrder.clear(),this.memorySizeUsed=0,this.persistenceEnabled&&this.persistentCache)try{const e=this.persistentCache.transaction(["waveforms"],"readwrite");e.objectStore("waveforms").clear()}catch(e){}this.metrics={hits:0,misses:0,evictions:0,compressionSavings:0,averageCompressionRatio:0,persistenceHits:0,persistenceMisses:0}}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clear(),this.persistentCache&&(this.persistentCache.close(),this.persistentCache=null)}}class t{constructor(e={}){this.maxMemoryThreshold=e.maxMemoryThreshold||157286400,this.warningThreshold=e.warningThreshold||104857600,this.cleanupInterval=e.cleanupInterval||3e4,this.aggressiveCleanupThreshold=e.aggressiveCleanupThreshold||209715200,this.allocatedBuffers=new Map,this.bufferPool=new Map,this.memoryUsage={current:0,peak:0,allocated:0,pooled:0},this.cleanupStrategies=new Map,this.initializeCleanupStrategies(),this.performanceMetrics={cleanupCount:0,memoryReclaimed:0,bufferReuses:0,gcTriggers:0,averageCleanupTime:0},this.cleanupTimer=setInterval(()=>{this.performAutomaticCleanup()},this.cleanupInterval),this.memoryPressureObserver=null,this.initializeMemoryPressureMonitoring()}initializeCleanupStrategies(){this.cleanupStrategies.set("buffer-pool",{priority:1,execute:()=>this.cleanupBufferPool(),description:"Clean unused buffers from pool"}),this.cleanupStrategies.set("old-allocations",{priority:2,execute:()=>this.cleanupOldAllocations(),description:"Remove old allocated buffers"}),this.cleanupStrategies.set("large-buffers",{priority:3,execute:()=>this.cleanupLargeBuffers(),description:"Clean up large unused buffers"}),this.cleanupStrategies.set("force-gc",{priority:4,execute:()=>this.forceGarbageCollection(),description:"Force garbage collection"}),this.cleanupStrategies.set("emergency-cleanup",{priority:5,execute:()=>this.emergencyCleanup(),description:"Emergency memory cleanup"})}initializeMemoryPressureMonitoring(){if("undefined"!=typeof PerformanceObserver)try{this.memoryPressureObserver=new PerformanceObserver(e=>{const t=e.getEntries();for(const s of t)"measure"===s.entryType&&s.name.includes("memory")&&this.handleMemoryPressure(s)}),this.memoryPressureObserver.observe({entryTypes:["measure"]})}catch(e){}setInterval(()=>{this.checkMemoryPressure()},5e3)}allocateBuffer(e,t="waveform",s={}){const r=this.generateBufferId(),i=this.getPooledBuffer(e,t);if(i)return this.allocatedBuffers.set(r,{buffer:i,size:e,type:t,metadata:{...s,allocatedAt:Date.now(),reused:!0}}),this.performanceMetrics.bufferReuses++,{bufferId:r,buffer:i};let a;try{switch(t){case"waveform":case"float32":default:a=new Float32Array(e);break;case"uint8":a=new Uint8Array(e);break;case"int16":a=new Int16Array(e);break;case"arraybuffer":a=new ArrayBuffer(e)}const i=a.byteLength||a.length*a.BYTES_PER_ELEMENT;return this.allocatedBuffers.set(r,{buffer:a,size:i,type:t,metadata:{...s,allocatedAt:Date.now(),reused:!1}}),this.memoryUsage.current+=i,this.memoryUsage.allocated+=i,this.memoryUsage.peak=Math.max(this.memoryUsage.peak,this.memoryUsage.current),this.memoryUsage.current>this.warningThreshold&&this.scheduleCleanup("memory-warning"),{bufferId:r,buffer:a}}catch(n){if(this.memoryUsage.current>.8*this.maxMemoryThreshold){this.emergencyCleanup();try{a=new Float32Array(e);const i=a.byteLength||a.length*a.BYTES_PER_ELEMENT;return this.allocatedBuffers.set(r,{buffer:a,size:i,type:t,metadata:{...s,allocatedAt:Date.now(),reused:!1,emergencyRetry:!0}}),this.memoryUsage.current+=i,this.memoryUsage.allocated+=i,{bufferId:r,buffer:a}}catch(o){throw new Error(`Buffer allocation failed after emergency cleanup: ${o.message}`)}}throw n}}deallocateBuffer(e,t={}){const s=this.allocatedBuffers.get(e);if(!s)return!1;const{buffer:r,size:i,type:a}=s,{poolForReuse:n=!0,reason:o="manual"}=t;return this.allocatedBuffers.delete(e),this.memoryUsage.current-=i,n&&this.shouldPoolBuffer(r,i,a)&&this.addToBufferPool(r,i,a),!0}getPooledBuffer(e,t){const s=`${t}_${e}`,r=this.bufferPool.get(s);if(r&&r.length>0){const t=r.pop();return t.fill?t.fill(0):t instanceof ArrayBuffer&&new Uint8Array(t).fill(0),this.memoryUsage.pooled-=e,t}return null}addToBufferPool(e,t,s){const r=`${s}_${t}`;this.bufferPool.has(r)||this.bufferPool.set(r,[]);const i=this.bufferPool.get(r),a=Math.max(2,Math.floor(this.maxMemoryThreshold/t/10));i.length<a&&(i.push(e),this.memoryUsage.pooled+=t)}shouldPoolBuffer(e,t,s){if(t>10485760)return!1;if(this.memoryUsage.current>this.warningThreshold)return!1;return["waveform","float32","uint8","int16"].includes(s)}performAutomaticCleanup(){const e=this.getCurrentMemoryUsage();e>this.aggressiveCleanupThreshold?this.performCleanup(["emergency-cleanup","force-gc","large-buffers"]):e>this.maxMemoryThreshold?this.performCleanup(["large-buffers","old-allocations","buffer-pool"]):e>this.warningThreshold&&this.performCleanup(["buffer-pool","old-allocations"])}async performCleanup(e=[]){const t=performance.now();this.getCurrentMemoryUsage();const s=e.map(e=>({name:e,...this.cleanupStrategies.get(e)})).filter(e=>e.execute).sort((e,t)=>e.priority-t.priority);let r=0;for(const n of s)try{const e=this.getCurrentMemoryUsage();await n.execute();const t=this.getCurrentMemoryUsage(),s=e-t;if(s>0&&(r+=s),t<this.warningThreshold)break}catch(a){}const i=performance.now()-t;return this.updateCleanupMetrics(i,r),{strategiesUsed:s.map(e=>e.name),memoryReclaimed:r,cleanupTime:i,finalMemoryUsage:this.getCurrentMemoryUsage()}}scheduleCleanup(e="scheduled",t=0){setTimeout(()=>{this.performAutomaticCleanup()},t)}cleanupBufferPool(){let e=0;for(const[t,s]of this.bufferPool){const[r,i]=t.split("_"),a=parseInt(i),n=Math.max(1,Math.floor(s.length/2)),o=s.splice(n);e+=o.length*a,this.memoryUsage.pooled-=o.length*a}return e}cleanupOldAllocations(){let e=0;const t=Date.now(),s=[];for(const[r,i]of this.allocatedBuffers){t-i.metadata.allocatedAt>6e5&&!i.metadata.pinned&&(s.push(r),e+=i.size)}for(const r of s)this.deallocateBuffer(r,{poolForReuse:!1,reason:"age-cleanup"});return e}cleanupLargeBuffers(){let e=0;const t=[],s=Array.from(this.allocatedBuffers.entries()).sort(([,e],[,t])=>t.size-e.size);for(const[r,i]of s)if(i.size>5242880&&!i.metadata.pinned&&(t.push(r),e+=i.size,e>.2*this.maxMemoryThreshold))break;for(const r of t)this.deallocateBuffer(r,{poolForReuse:!1,reason:"size-cleanup"});return e}forceGarbageCollection(){if("function"==typeof gc)try{return gc(),this.performanceMetrics.gcTriggers++,!0}catch(e){}try{const e=[];for(let t=0;t<100;t++)e.push(new Float32Array(1024))}catch(e){}return!1}emergencyCleanup(){let e=0;const t=[];for(const[s,r]of this.allocatedBuffers)r.metadata.pinned||(t.push(s),e+=r.size);for(const s of t)this.deallocateBuffer(s,{poolForReuse:!1,reason:"emergency"});return this.bufferPool.clear(),this.memoryUsage.pooled=0,this.forceGarbageCollection(),e}pinBuffer(e,t="user-request"){const s=this.allocatedBuffers.get(e);return!!s&&(s.metadata.pinned=!0,s.metadata.pinnedReason=t,s.metadata.pinnedAt=Date.now(),!0)}unpinBuffer(e){const t=this.allocatedBuffers.get(e);return!!t&&(t.metadata.pinned=!1,delete t.metadata.pinnedReason,delete t.metadata.pinnedAt,!0)}getCurrentMemoryUsage(){return"undefined"!=typeof performance&&performance.memory?performance.memory.usedJSHeapSize:this.memoryUsage.current+this.memoryUsage.pooled}checkMemoryPressure(){const e=this.getCurrentMemoryUsage();this.calculateMemoryPressure(e)>.8&&this.performAutomaticCleanup()}calculateMemoryPressure(e){return Math.min(1,e/this.maxMemoryThreshold)}handleMemoryPressure(e){this.performAutomaticCleanup()}updateCleanupMetrics(e,t){this.performanceMetrics.cleanupCount++,this.performanceMetrics.memoryReclaimed+=t;const s=this.performanceMetrics.averageCleanupTime,r=this.performanceMetrics.cleanupCount;this.performanceMetrics.averageCleanupTime=(s*(r-1)+e)/r}generateBufferId(){return`buffer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}formatBytes(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}getMemoryStats(){const e=this.getCurrentMemoryUsage(),t=this.calculateMemoryPressure(e);return{usage:{current:e,peak:this.memoryUsage.peak,allocated:this.memoryUsage.allocated,pooled:this.memoryUsage.pooled,formatted:{current:this.formatBytes(e),peak:this.formatBytes(this.memoryUsage.peak),allocated:this.formatBytes(this.memoryUsage.allocated),pooled:this.formatBytes(this.memoryUsage.pooled)}},thresholds:{warning:this.warningThreshold,max:this.maxMemoryThreshold,aggressive:this.aggressiveCleanupThreshold,formatted:{warning:this.formatBytes(this.warningThreshold),max:this.formatBytes(this.maxMemoryThreshold),aggressive:this.formatBytes(this.aggressiveCleanupThreshold)}},pressure:{level:t,status:t>.8?"high":t>.6?"medium":"low"},allocations:{count:this.allocatedBuffers.size,pooledBuffers:Array.from(this.bufferPool.values()).reduce((e,t)=>e+t.length,0),pinnedBuffers:Array.from(this.allocatedBuffers.values()).filter(e=>e.metadata.pinned).length},performance:this.performanceMetrics}}destroy(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),this.memoryPressureObserver&&(this.memoryPressureObserver.disconnect(),this.memoryPressureObserver=null),this.emergencyCleanup(),this.allocatedBuffers.clear(),this.bufferPool.clear(),this.cleanupStrategies.clear()}}class s{constructor(e={}){this.options={targetFPS:e.targetFPS||60,minFPS:e.minFPS||30,performanceWindow:e.performanceWindow||5e3,degradationThreshold:e.degradationThreshold||.7,recoveryThreshold:e.recoveryThreshold||.9,maxDegradationLevel:e.maxDegradationLevel||3,...e},this.metrics={fps:{current:0,average:0,min:1/0,max:0,samples:[]},renderTime:{current:0,average:0,min:1/0,max:0,samples:[]},memoryUsage:{current:0,peak:0,trend:"stable"},cpuUsage:{estimated:0,trend:"stable"}},this.currentQualityLevel="high",this.degradationLevel=0,this.isMonitoring=!1,this.adaptiveSettings=this.getDefaultAdaptiveSettings(),this.qualityChangeCallbacks=new Set,this.performanceWarningCallbacks=new Set,this.monitoringInterval=null,this.metricsCollectionInterval=null,this.lastFrameTime=0,this.frameCount=0,this.renderStartTime=0,this.deviceCapabilities=null,this.detectDeviceCapabilities()}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.lastFrameTime=performance.now(),this.metricsCollectionInterval=setInterval(()=>{this.collectMetrics()},1e3),this.monitoringInterval=setInterval(()=>{this.analyzePerformance()},this.options.performanceWindow))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.metricsCollectionInterval&&(clearInterval(this.metricsCollectionInterval),this.metricsCollectionInterval=null),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null))}frameRenderStart(){this.renderStartTime=performance.now()}frameRenderEnd(){const e=performance.now(),t=e-this.renderStartTime,s=e-this.lastFrameTime,r=s>0?1e3/s:0;this.updateFPSMetrics(r),this.updateRenderTimeMetrics(t),this.lastFrameTime=e,this.frameCount++,r<this.options.minFPS&&this.handleLowPerformance("fps",r),t>33&&this.handleLowPerformance("renderTime",t)}updateFPSMetrics(e){this.metrics.fps.current=e,this.metrics.fps.min=Math.min(this.metrics.fps.min,e),this.metrics.fps.max=Math.max(this.metrics.fps.max,e),this.metrics.fps.samples.push(e),this.metrics.fps.samples.length>60&&this.metrics.fps.samples.shift(),this.metrics.fps.average=this.metrics.fps.samples.reduce((e,t)=>e+t,0)/this.metrics.fps.samples.length}updateRenderTimeMetrics(e){this.metrics.renderTime.current=e,this.metrics.renderTime.min=Math.min(this.metrics.renderTime.min,e),this.metrics.renderTime.max=Math.max(this.metrics.renderTime.max,e),this.metrics.renderTime.samples.push(e),this.metrics.renderTime.samples.length>60&&this.metrics.renderTime.samples.shift(),this.metrics.renderTime.average=this.metrics.renderTime.samples.reduce((e,t)=>e+t,0)/this.metrics.renderTime.samples.length}collectMetrics(){if("undefined"!=typeof performance&&performance.memory){const e=performance.memory.usedJSHeapSize;this.metrics.memoryUsage.current=e,this.metrics.memoryUsage.peak=Math.max(this.metrics.memoryUsage.peak,e),this.updateMemoryTrend(e)}this.estimateCPUUsage()}updateMemoryTrend(e){if(!this.lastMemoryReading)return void(this.lastMemoryReading=e);const t=e-this.lastMemoryReading,s=Math.abs(t)/this.lastMemoryReading;this.metrics.memoryUsage.trend=s>.05?t>0?"increasing":"decreasing":"stable",this.lastMemoryReading=e}estimateCPUUsage(){const e=1e3/this.options.targetFPS,t=this.metrics.renderTime.average,s=Math.min(1,t/e);if(this.metrics.cpuUsage.estimated=s,!this.lastCPUReading)return void(this.lastCPUReading=s);const r=s-this.lastCPUReading;Math.abs(r)>.1?this.metrics.cpuUsage.trend=r>0?"increasing":"decreasing":this.metrics.cpuUsage.trend="stable",this.lastCPUReading=s}analyzePerformance(){const e=this.calculatePerformanceScore(),t=e<this.options.degradationThreshold,s=e>this.options.recoveryThreshold;t&&this.degradationLevel<this.options.maxDegradationLevel?this.degradeQuality():s&&this.degradationLevel>0&&this.improveQuality(),this.checkCriticalPerformance()}calculatePerformanceScore(){return.4*Math.min(1,this.metrics.fps.average/this.options.targetFPS)+.3*Math.min(1,1e3/this.options.targetFPS/this.metrics.renderTime.average)+.2*this.calculateMemoryScore()+.1*(1-this.metrics.cpuUsage.estimated)}calculateMemoryScore(){if(!this.deviceCapabilities||!this.deviceCapabilities.memoryLimit)return 1;const e=this.metrics.memoryUsage.current/this.deviceCapabilities.memoryLimit;return Math.max(0,1-e)}degradeQuality(){this.degradationLevel++;const e=this.getAdaptiveSettings(this.degradationLevel);this.applyAdaptiveSettings(e);const t=this.getQualityLevelName(this.degradationLevel);this.notifyQualityChange(t,"degraded",{reason:"performance",score:this.calculatePerformanceScore(),level:this.degradationLevel})}improveQuality(){this.degradationLevel--;const e=this.getAdaptiveSettings(this.degradationLevel);this.applyAdaptiveSettings(e);const t=this.getQualityLevelName(this.degradationLevel);this.notifyQualityChange(t,"improved",{reason:"performance-recovery",score:this.calculatePerformanceScore(),level:this.degradationLevel})}getAdaptiveSettings(e){const t=this.getDefaultAdaptiveSettings();switch(e){case 0:default:return t;case 1:return{...t,renderQuality:"medium",waveformResolution:.8,enableAntialiasing:!0,maxBatchSize:800};case 2:return{...t,renderQuality:"medium",waveformResolution:.6,enableAntialiasing:!1,maxBatchSize:600,enableViewportCulling:!0,chopRenderingDetail:"medium"};case 3:return{...t,renderQuality:"low",waveformResolution:.4,enableAntialiasing:!1,maxBatchSize:400,enableViewportCulling:!0,chopRenderingDetail:"low",disableAnimations:!0,simplifiedRendering:!0}}}getDefaultAdaptiveSettings(){return{renderQuality:"high",waveformResolution:1,enableAntialiasing:!0,maxBatchSize:1e3,enableViewportCulling:!0,chopRenderingDetail:"high",disableAnimations:!1,simplifiedRendering:!1,targetFPS:this.options.targetFPS}}applyAdaptiveSettings(e){this.adaptiveSettings={...e},this.currentQualityLevel=this.getQualityLevelName(this.degradationLevel)}getQualityLevelName(e){const t=["high","medium-high","medium","low"];return t[Math.min(e,t.length-1)]}handleLowPerformance(e,t){this.notifyPerformanceWarning({metric:e,value:t,threshold:"fps"===e?this.options.minFPS:33,timestamp:Date.now(),currentQuality:this.currentQualityLevel,degradationLevel:this.degradationLevel})}checkCriticalPerformance(){const e=[];if(this.metrics.fps.average<.5*this.options.minFPS&&e.push({type:"critical-fps",value:this.metrics.fps.average,threshold:.5*this.options.minFPS}),this.deviceCapabilities&&this.deviceCapabilities.memoryLimit){const t=this.metrics.memoryUsage.current/this.deviceCapabilities.memoryLimit;t>.9&&e.push({type:"critical-memory",value:t,threshold:.9})}this.metrics.renderTime.average>100&&e.push({type:"critical-render-time",value:this.metrics.renderTime.average,threshold:100}),e.length>0&&this.handleCriticalPerformance(e)}handleCriticalPerformance(e){this.degradationLevel=this.options.maxDegradationLevel;const t=this.getEmergencySettings();this.applyAdaptiveSettings(t),this.notifyPerformanceWarning({type:"critical",issues:e,emergencyMode:!0,timestamp:Date.now()})}getEmergencySettings(){return{renderQuality:"low",waveformResolution:.2,enableAntialiasing:!1,maxBatchSize:200,enableViewportCulling:!0,chopRenderingDetail:"minimal",disableAnimations:!0,simplifiedRendering:!0,emergencyMode:!0,targetFPS:Math.max(15,.5*this.options.minFPS)}}detectDeviceCapabilities(){this.deviceCapabilities={memoryLimit:this.detectMemoryLimit(),cpuCores:navigator.hardwareConcurrency||4,webglSupport:this.detectWebGLSupport(),performanceAPISupport:"undefined"!=typeof performance&&!!performance.memory,deviceType:this.detectDeviceType(),connectionType:this.detectConnectionType()}}detectMemoryLimit(){if("undefined"!=typeof performance&&performance.memory)return performance.memory.jsHeapSizeLimit;switch(this.detectDeviceType()){case"mobile":return 104857600;case"tablet":default:return 209715200;case"desktop":return 524288e3}}detectWebGLSupport(){try{if("undefined"==typeof document||"undefined"==typeof HTMLCanvasElement)return!1;const e=document.createElement("canvas");return!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}detectDeviceType(){const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}detectConnectionType(){return navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null}onQualityChange(e){return this.qualityChangeCallbacks.add(e),()=>this.qualityChangeCallbacks.delete(e)}onPerformanceWarning(e){return this.performanceWarningCallbacks.add(e),()=>this.performanceWarningCallbacks.delete(e)}notifyQualityChange(e,t,s){const r={newQuality:e,changeType:t,details:s,settings:this.adaptiveSettings,timestamp:Date.now()};this.qualityChangeCallbacks.forEach(e=>{try{e(r)}catch(t){}})}notifyPerformanceWarning(e){this.performanceWarningCallbacks.forEach(t=>{try{t(e)}catch(s){}})}getMetrics(){return{...this.metrics,performanceScore:this.calculatePerformanceScore(),qualityLevel:this.currentQualityLevel,degradationLevel:this.degradationLevel,adaptiveSettings:this.adaptiveSettings,deviceCapabilities:this.deviceCapabilities}}getAdaptiveSettings(){return{...this.adaptiveSettings}}forceQualityLevel(e){const t={high:0,"medium-high":1,medium:2,low:3}[e]||0;this.degradationLevel=t;const s=this.getAdaptiveSettings(t);this.applyAdaptiveSettings(s),this.notifyQualityChange(e,"forced",{reason:"user-override",level:t})}resetQuality(){this.degradationLevel=0;const e=this.getDefaultAdaptiveSettings();this.applyAdaptiveSettings(e),this.notifyQualityChange("high","reset",{reason:"user-reset"})}destroy(){this.stopMonitoring(),this.qualityChangeCallbacks.clear(),this.performanceWarningCallbacks.clear()}}export{e as W,t as a,s as b};
