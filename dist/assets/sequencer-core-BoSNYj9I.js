class e{constructor(){this.pendingUpdates=new Set,this.rafId=null,this.isRendering=!1,this.renderCache=new Map,this.visibilityObserver=null,this.visibleElements=new Set,this.performanceMetrics={frameTime:0,droppedFrames:0,renderCalls:0,cacheHits:0},this.initializeVisibilityObserver()}initializeVisibilityObserver(){this.visibilityObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?this.visibleElements.add(e.target):this.visibleElements.delete(e.target)})},{rootMargin:"50px",threshold:0})}scheduleUpdate(e,t=null){t&&this.renderCache.has(t)?this.performanceMetrics.cacheHits++:(this.pendingUpdates.add(e),t&&this.renderCache.set(t,!0),this.rafId||(this.rafId=requestAnimationFrame(()=>this.executeRender())))}executeRender(){if(this.isRendering)return;this.isRendering=!0;const e=performance.now();try{this.pendingUpdates.forEach(e=>{try{e()}catch(t){}}),this.pendingUpdates.clear(),this.renderCache.clear(),this.performanceMetrics.frameTime=performance.now()-e,this.performanceMetrics.renderCalls++,this.performanceMetrics.frameTime>16.67&&this.performanceMetrics.droppedFrames++}finally{this.isRendering=!1,this.rafId=null}}createOptimizedStepIndicator(e,t,r){const s=document.createElement("div");s.className="sequencer-step",s.dataset.step=e,s.style.transform="translateZ(0)",s.style.willChange="transform, opacity";return Object.assign(s.style,{width:"20px",height:"20px",borderRadius:"4px",transition:"none",cursor:"pointer"}),this.updateStepIndicator(s,t,r),s}updateStepIndicator(e,t,r){const s=`step-${e.dataset.step}-${t}-${r}`;this.scheduleUpdate(()=>{if(!this.visibleElements.has(e))return;let s,a,n;t?(s="#3b82f6",a="1",n="translateZ(0) scale(1.1)"):r?(s="#10b981",a="0.8",n="translateZ(0) scale(1)"):(s="#374151",a="0.6",n="translateZ(0) scale(1)"),e.style.backgroundColor=s,e.style.opacity=a,e.style.transform=n},s)}createVirtualScrollContainer(e,t,r=50){const s=document.createElement("div");s.style.position="relative",s.style.overflow="auto",s.style.height="300px";const a=document.createElement("div");a.style.height=e.length*r+"px",s.appendChild(a);const n=new Map,i=()=>{const i=s.scrollTop,o=s.clientHeight,h=Math.floor(i/r),c=Math.min(e.length-1,Math.ceil((i+o)/r));n.forEach((e,t)=>{(t<h||t>c)&&(e.remove(),n.delete(t))});for(let s=h;s<=c;s++)if(!n.has(s)){const i=t(e[s],s);i.style.position="absolute",i.style.top=s*r+"px",i.style.height=`${r}px`,i.style.width="100%",a.appendChild(i),n.set(s,i)}};let o;return s.addEventListener("scroll",()=>{o&&clearTimeout(o),o=setTimeout(i,16)}),i(),s}optimizeElement(e){e.style.transform="translateZ(0)",e.style.backfaceVisibility="hidden",e.style.perspective="1000px",e.style.willChange="transform, opacity",this.visibilityObserver.observe(e)}createOptimizedAnimation(e,t,r=300){const s=e.animate(t,{duration:r,easing:"cubic-bezier(0.4, 0, 0.2, 1)",fill:"forwards"});return s.addEventListener("finish",()=>{s.cancel()}),s}batchDOMReads(e){const t=[];return this.scheduleUpdate(()=>{e.forEach(e=>{try{t.push(e())}catch(r){t.push(null)}})}),t}batchDOMWrites(e){this.scheduleUpdate(()=>{e.forEach(e=>{try{e()}catch(t){}})})}getPerformanceMetrics(){return{...this.performanceMetrics}}resetPerformanceMetrics(){this.performanceMetrics={frameTime:0,droppedFrames:0,renderCalls:0,cacheHits:0}}cleanup(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.pendingUpdates.clear(),this.renderCache.clear(),this.visibleElements.clear()}}class t{constructor(){this.audioContext=null,this.schedulerNode=null,this.isPlaying=!1,this.isPaused=!1,this.currentStep=0,this.bpm=160,this.stepResolution=16,this.stepCallbacks=[],this.stateChangeCallbacks=[],this.youtubePlayer=null,this.isInitialized=!1,this.lookAhead=25,this.scheduleAheadTime=.1,this.nextStepTime=0,this.timerID=null,this.scheduledSteps=new Map,this.performanceMetrics={jitter:0,drift:0,cpuUsage:0,lastMeasurement:0},this.offscreenCanvas=null,this.schedulerWorker=null}async initialize(e){try{if(!e)throw new Error("YouTube player is required");return this.youtubePlayer=e,await this.initializeAudioContext(),await this.initializeScheduler(),this.initializePerformanceMonitoring(),this.isInitialized=!0,!0}catch(t){return!1}}async initializeAudioContext(){this.audioContext=new(window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive",sampleRate:44100}),"suspended"===this.audioContext.state&&await this.audioContext.resume();const e=this.audioContext.createGain();e.gain.value=0,e.connect(this.audioContext.destination);const t=this.audioContext.createOscillator();t.frequency.value=440,t.connect(e),t.start()}async initializeScheduler(){const e=new Blob(['\n      let timerID = null;\n      let interval = 25; // 25ms for ultra-precise timing\n      \n      self.onmessage = function(e) {\n        if (e.data === "start") {\n          timerID = setInterval(() => {\n            self.postMessage("tick");\n          }, interval);\n        } else if (e.data === "stop") {\n          if (timerID) {\n            clearInterval(timerID);\n            timerID = null;\n          }\n        } else if (e.data.type === "setInterval") {\n          interval = e.data.interval;\n          if (timerID) {\n            clearInterval(timerID);\n            timerID = setInterval(() => {\n              self.postMessage("tick");\n            }, interval);\n          }\n        }\n      };\n    '],{type:"application/javascript"});this.schedulerWorker=new Worker(URL.createObjectURL(e)),this.schedulerWorker.onmessage=e=>{"tick"===e.data&&this.scheduler()}}initializePerformanceMonitoring(){setInterval(()=>{this.updatePerformanceMetrics()},1e3)}scheduler(){if(!this.isPlaying||!this.audioContext)return;const e=this.audioContext.currentTime;for(;this.nextStepTime<e+this.scheduleAheadTime;)this.scheduleStep(this.nextStepTime),this.nextStepTime+=this.getStepDuration()/1e3}scheduleStep(e){const t=this.currentStep,r=1e3*(e-this.audioContext.currentTime);setTimeout(()=>{this.isPlaying&&this.executeStep(t)},Math.max(0,r)),this.currentStep=(this.currentStep+1)%this.stepResolution}executeStep(e){const t=performance.now();for(let s=0;s<this.stepCallbacks.length;s++)try{this.stepCallbacks[s](e,t)}catch(r){}}start(){if(!this.isInitialized)throw new Error("Engine must be initialized before starting");this.isPlaying||(this.isPaused||(this.currentStep=0),this.isPlaying=!0,this.isPaused=!1,this.nextStepTime=this.audioContext.currentTime,this.schedulerWorker.postMessage("start"),this.notifyStateChange())}stop(){(this.isPlaying||this.isPaused)&&(this.isPlaying=!1,this.isPaused=!1,this.currentStep=0,this.schedulerWorker.postMessage("stop"),this.scheduledSteps.clear(),this.notifyStateChange())}pause(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this.schedulerWorker.postMessage("stop"),this.notifyStateChange())}resume(){this.isPaused&&(this.isPlaying=!0,this.isPaused=!1,this.nextStepTime=this.audioContext.currentTime,this.schedulerWorker.postMessage("start"),this.notifyStateChange())}setBPM(e){if(e<60||e>200)throw new Error("BPM must be between 60 and 200");this.bpm=e;const t=Math.max(10,this.getStepDuration()/4);this.schedulerWorker.postMessage({type:"setInterval",interval:t}),this.notifyStateChange()}getStepDuration(){return 60/this.bpm/this.stepResolution*4*1e3}async jumpToTimestamp(e,t=!0){if(!this.youtubePlayer)return!1;try{const r=1===this.youtubePlayer.getPlayerState();return this.youtubePlayer.seekTo(e,!0),await new Promise(e=>setTimeout(e,5)),t&&r&&this.youtubePlayer.playVideo(),!0}catch(r){return!1}}updatePerformanceMetrics(){const e=performance.now();if(this.performanceMetrics.lastMeasurement>0){const t=e-this.performanceMetrics.lastMeasurement,r=1e3;this.performanceMetrics.jitter=Math.abs(t-r),this.performanceMetrics.cpuUsage=Math.min(100,2*this.performanceMetrics.jitter)}this.performanceMetrics.lastMeasurement=e}getPerformanceMetrics(){return{...this.performanceMetrics}}addStepCallback(e){"function"==typeof e&&this.stepCallbacks.push(e)}removeStepCallback(e){const t=this.stepCallbacks.indexOf(e);t>-1&&this.stepCallbacks.splice(t,1)}addStateChangeCallback(e){"function"==typeof e&&this.stateChangeCallbacks.push(e)}removeStateChangeCallback(e){const t=this.stateChangeCallbacks.indexOf(e);t>-1&&this.stateChangeCallbacks.splice(t,1)}notifyStateChange(){const e=this.getState();this.stateChangeCallbacks.forEach(t=>{try{t(e)}catch(r){}})}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentStep:this.currentStep,bpm:this.bpm,stepResolution:this.stepResolution,performanceMetrics:this.getPerformanceMetrics()}}cleanup(){this.stop(),this.schedulerWorker&&(this.schedulerWorker.terminate(),this.schedulerWorker=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.stepCallbacks=[],this.stateChangeCallbacks=[],this.isInitialized=!1}}const r=new class{constructor(){this.validationRules={pattern:{requiredFields:["id","name","bpm","currentBank","banks"],bpmRange:{min:60,max:200},maxBanks:4,maxNameLength:100},bank:{requiredFields:["bankId","name","tracks"],tracksPerBank:16,maxNameLength:50},track:{requiredFields:["trackIndex","steps"],stepsPerTrack:16}},this.errorCounts={validationErrors:0,sanitizationAttempts:0,recoveryAttempts:0}}validateAndSanitize(e,t={}){const{strict:r=!1,autoFix:s=!0,throwOnError:a=!1}=t,n={isValid:!1,sanitizedPattern:null,errors:[],warnings:[],fixes:[]};try{const t=this.validateStructure(e);if(n.errors.push(...t.errors),n.warnings.push(...t.warnings),t.errors.length>0&&r){if(n.isValid=!1,a)throw new Error(`Pattern validation failed: ${t.errors.join(", ")}`);return n}let i=e;if(s&&(t.errors.length>0||t.warnings.length>0)){const t=this.sanitizePattern(e);i=t.pattern,n.fixes.push(...t.fixes),n.warnings.push(...t.warnings),this.errorCounts.sanitizationAttempts++}const o=this.validateStructure(i);if(0===o.errors.length)n.isValid=!0,n.sanitizedPattern=i;else if(n.errors.push(...o.errors),a)throw new Error(`Pattern validation failed after sanitization: ${o.errors.join(", ")}`);return n}catch(i){if(this.errorCounts.validationErrors++,n.errors.push(`Validation exception: ${i.message}`),a)throw i;return n}}validateStructure(e){const t=[],r=[];if(!e||"object"!=typeof e)return t.push("Pattern must be a valid object"),{errors:t,warnings:r};const s=this.validationRules.pattern.requiredFields.filter(t=>!(t in e));return s.length>0&&t.push(`Missing required fields: ${s.join(", ")}`),!e.id||"string"==typeof e.id&&0!==e.id.trim().length||t.push("Pattern ID must be a non-empty string"),e.name&&("string"!=typeof e.name?t.push("Pattern name must be a string"):e.name.length>this.validationRules.pattern.maxNameLength&&r.push(`Pattern name exceeds maximum length (${this.validationRules.pattern.maxNameLength})`)),void 0!==e.bpm&&("number"!=typeof e.bpm||isNaN(e.bpm)?t.push("BPM must be a valid number"):(e.bpm<this.validationRules.pattern.bpmRange.min||e.bpm>this.validationRules.pattern.bpmRange.max)&&t.push(`BPM must be between ${this.validationRules.pattern.bpmRange.min} and ${this.validationRules.pattern.bpmRange.max}`)),void 0!==e.currentBank&&("number"!=typeof e.currentBank||e.currentBank<0)&&t.push("Current bank must be a non-negative number"),e.banks&&(Array.isArray(e.banks)?(0===e.banks.length?t.push("Pattern must have at least one bank"):e.banks.length>this.validationRules.pattern.maxBanks&&r.push(`Pattern has more than ${this.validationRules.pattern.maxBanks} banks`),e.banks.forEach((e,s)=>{const a=this.validateBank(e,s);t.push(...a.errors.map(e=>`Bank ${s}: ${e}`)),r.push(...a.warnings.map(e=>`Bank ${s}: ${e}`))}),e.currentBank>=e.banks.length&&t.push("Current bank index exceeds available banks")):t.push("Banks must be an array")),e.metadata&&("object"!=typeof e.metadata?r.push("Metadata should be an object"):(e.metadata.created&&!this.isValidISODate(e.metadata.created)&&r.push("Invalid created date in metadata"),e.metadata.modified&&!this.isValidISODate(e.metadata.modified)&&r.push("Invalid modified date in metadata"))),{errors:t,warnings:r}}validateBank(e,t){const r=[],s=[];if(!e||"object"!=typeof e)return r.push("Bank must be a valid object"),{errors:r,warnings:s};const a=this.validationRules.bank.requiredFields.filter(t=>!(t in e));return a.length>0&&r.push(`Missing required fields: ${a.join(", ")}`),void 0!==e.bankId&&("number"==typeof e.bankId&&e.bankId===t||r.push(`Bank ID should match index (expected ${t}, got ${e.bankId})`)),e.name&&("string"!=typeof e.name?r.push("Bank name must be a string"):e.name.length>this.validationRules.bank.maxNameLength&&s.push(`Bank name exceeds maximum length (${this.validationRules.bank.maxNameLength})`)),e.tracks&&(Array.isArray(e.tracks)?(e.tracks.length!==this.validationRules.bank.tracksPerBank&&r.push(`Bank must have exactly ${this.validationRules.bank.tracksPerBank} tracks`),e.tracks.forEach((e,t)=>{const a=this.validateTrack(e,t);r.push(...a.errors.map(e=>`Track ${t}: ${e}`)),s.push(...a.warnings.map(e=>`Track ${t}: ${e}`))})):r.push("Tracks must be an array")),{errors:r,warnings:s}}validateTrack(e,t){const r=[],s=[];if(!e||"object"!=typeof e)return r.push("Track must be a valid object"),{errors:r,warnings:s};const a=this.validationRules.track.requiredFields.filter(t=>!(t in e));return a.length>0&&r.push(`Missing required fields: ${a.join(", ")}`),void 0!==e.trackIndex&&("number"==typeof e.trackIndex&&e.trackIndex===t||r.push(`Track index should match position (expected ${t}, got ${e.trackIndex})`)),void 0!==e.chopId&&null!==e.chopId&&("string"!=typeof e.chopId||0===e.chopId.trim().length?s.push("Chop ID should be a non-empty string or null"):/^[A-D]\d{1,2}$/.test(e.chopId)||s.push(`Chop ID format may be invalid: ${e.chopId}`)),e.steps&&(Array.isArray(e.steps)?(e.steps.length!==this.validationRules.track.stepsPerTrack&&r.push(`Track must have exactly ${this.validationRules.track.stepsPerTrack} steps`),e.steps.forEach((e,t)=>{"boolean"!=typeof e&&r.push(`Step ${t} must be a boolean value`)})):r.push("Steps must be an array")),{errors:r,warnings:s}}sanitizePattern(e){const t=[],r=[],s=JSON.parse(JSON.stringify(e));try{if(s.id&&"string"==typeof s.id||(s.id=this.generatePatternId(),t.push("Generated new pattern ID")),s.name&&"string"==typeof s.name?s.name.length>this.validationRules.pattern.maxNameLength&&(s.name=s.name.substring(0,this.validationRules.pattern.maxNameLength),t.push("Truncated pattern name to maximum length")):(s.name="Untitled Pattern",t.push("Set default pattern name")),"number"!=typeof s.bpm||isNaN(s.bpm))s.bpm=120,t.push("Set default BPM to 120");else{const{min:e,max:r}=this.validationRules.pattern.bpmRange;s.bpm<e?(s.bpm=e,t.push(`Adjusted BPM to minimum value (${e})`)):s.bpm>r&&(s.bpm=r,t.push(`Adjusted BPM to maximum value (${r})`))}("number"!=typeof s.currentBank||s.currentBank<0)&&(s.currentBank=0,t.push("Reset current bank to 0")),Array.isArray(s.banks)?(0===s.banks.length&&(s.banks=this.createDefaultBanks(),t.push("Added default banks (was empty)")),s.banks.forEach((e,a)=>{const n=this.sanitizeBank(e,a);s.banks[a]=n.bank,t.push(...n.fixes.map(e=>`Bank ${a}: ${e}`)),r.push(...n.warnings.map(e=>`Bank ${a}: ${e}`))}),s.currentBank>=s.banks.length&&(s.currentBank=0,t.push("Reset current bank index to valid range"))):(s.banks=this.createDefaultBanks(),t.push("Created default banks structure")),s.metadata&&"object"==typeof s.metadata||(s.metadata={},t.push("Added metadata object"));const e=(new Date).toISOString();return s.metadata.created&&this.isValidISODate(s.metadata.created)||(s.metadata.created=e,t.push("Set creation date")),s.metadata.modified=e,t.push("Updated modification date"),{pattern:s,fixes:t,warnings:r}}catch(a){return r.push(`Sanitization error: ${a.message}`),{pattern:s,fixes:t,warnings:r}}}sanitizeBank(e,t){const r=[],s=[],a={...e};if("number"==typeof a.bankId&&a.bankId===t||(a.bankId=t,r.push("Fixed bank ID")),a.name&&"string"==typeof a.name?a.name.length>this.validationRules.bank.maxNameLength&&(a.name=a.name.substring(0,this.validationRules.bank.maxNameLength),r.push("Truncated bank name")):(a.name=`Bank ${String.fromCharCode(65+t)}`,r.push("Set default bank name")),Array.isArray(a.tracks)){for(;a.tracks.length<this.validationRules.bank.tracksPerBank;)a.tracks.push(this.createDefaultTrack(a.tracks.length)),r.push("Added missing track "+(a.tracks.length-1));a.tracks.length>this.validationRules.bank.tracksPerBank&&(a.tracks=a.tracks.slice(0,this.validationRules.bank.tracksPerBank),r.push("Removed excess tracks")),a.tracks.forEach((e,t)=>{const n=this.sanitizeTrack(e,t);a.tracks[t]=n.track,r.push(...n.fixes.map(e=>`Track ${t}: ${e}`)),s.push(...n.warnings.map(e=>`Track ${t}: ${e}`))})}else a.tracks=this.createDefaultTracks(),r.push("Created default tracks");return{bank:a,fixes:r,warnings:s}}sanitizeTrack(e,t){const r=[],s=[],a={...e};if("number"==typeof a.trackIndex&&a.trackIndex===t||(a.trackIndex=t,r.push("Fixed track index")),void 0!==a.chopId&&null!==a.chopId&&("string"!=typeof a.chopId||0===a.chopId.trim().length?(a.chopId=null,r.push("Cleared invalid chop ID")):/^[A-D]\d{1,2}$/.test(a.chopId)||s.push(`Chop ID format may be invalid: ${a.chopId}`)),Array.isArray(a.steps)){for(;a.steps.length<this.validationRules.track.stepsPerTrack;)a.steps.push(!1),r.push("Added missing step "+(a.steps.length-1));a.steps.length>this.validationRules.track.stepsPerTrack&&(a.steps=a.steps.slice(0,this.validationRules.track.stepsPerTrack),r.push("Removed excess steps")),a.steps.forEach((e,t)=>{"boolean"!=typeof e&&(a.steps[t]=Boolean(e),r.push(`Fixed step ${t} to boolean`))})}else a.steps=new Array(this.validationRules.track.stepsPerTrack).fill(!1),r.push("Created default steps array");return{track:a,fixes:r,warnings:s}}createDefaultBanks(){const e=[];for(let t=0;t<2;t++)e.push({bankId:t,name:`Bank ${String.fromCharCode(65+t)}`,tracks:this.createDefaultTracks()});return e}createDefaultTracks(){const e=[];for(let t=0;t<this.validationRules.bank.tracksPerBank;t++)e.push(this.createDefaultTrack(t));return e}createDefaultTrack(e){return{trackIndex:e,chopId:null,steps:new Array(this.validationRules.track.stepsPerTrack).fill(!1)}}generatePatternId(){return`sampler_pattern_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}isValidISODate(e){if("string"!=typeof e)return!1;const t=new Date(e);return t instanceof Date&&!isNaN(t.getTime())&&t.toISOString()===e}getStats(){return{...this.errorCounts}}resetStats(){this.errorCounts={validationErrors:0,sanitizationAttempts:0,recoveryAttempts:0}}};class s{constructor(){this.currentPattern=null,this.currentBank=0,this.maxBanks=4,this.tracksPerBank=16,this.stepsPerTrack=16,this.chopAssignments=new Map}createPattern(e="New Pattern",t=140){try{const s={id:this.generatePatternId(),name:e,bpm:t,currentBank:0,banks:this.createDefaultBanks(),metadata:{created:(new Date).toISOString(),modified:(new Date).toISOString()}},a=r.validateAndSanitize(s,{autoFix:!0,strict:!1,throwOnError:!1});if(a.isValid)this.currentPattern=a.sanitizedPattern||s;else{if(!a.sanitizedPattern)throw new Error("Failed to create valid pattern");this.currentPattern=a.sanitizedPattern}return this.currentBank=0,this.chopAssignments.clear(),{success:!0,pattern:this.currentPattern,fixes:a.fixes||[],warnings:a.warnings||[]}}catch(s){return{success:!1,error:s.message,pattern:null}}}createDefaultBanks(){const e=[];for(let t=0;t<2;t++){const r=String.fromCharCode(65+t);e.push({bankId:t,name:`Bank ${r}`,tracks:this.createDefaultTracks()})}return e}createDefaultTracks(){const e=[];for(let t=0;t<this.tracksPerBank;t++)e.push({trackIndex:t,chopId:null,steps:new Array(this.stepsPerTrack).fill(!1)});return e}toggleStep(e,t){if(!this.currentPattern)throw new Error("No pattern is currently loaded");if(e<0||e>=this.tracksPerBank)throw new Error("Track index must be between 0 and "+(this.tracksPerBank-1));if(t<0||t>=this.stepsPerTrack)throw new Error("Step index must be between 0 and "+(this.stepsPerTrack-1));const r=this.getCurrentBankData();if(!r)throw new Error("Current bank data not found");const s=r.tracks[e];if(!s)throw new Error(`Track ${e} not found in current bank`);s.steps[t]=!s.steps[t],this.currentPattern.metadata.modified=(new Date).toISOString()}setStep(e,t,r){if(!this.currentPattern)throw new Error("No pattern is currently loaded");if(e<0||e>=this.tracksPerBank)throw new Error("Track index must be between 0 and "+(this.tracksPerBank-1));if(t<0||t>=this.stepsPerTrack)throw new Error("Step index must be between 0 and "+(this.stepsPerTrack-1));const s=this.getCurrentBankData();if(!s)throw new Error("Current bank data not found");const a=s.tracks[e];if(!a)throw new Error(`Track ${e} not found in current bank`);a.steps[t]=r,this.currentPattern.metadata.modified=(new Date).toISOString()}getStep(e,t){if(!this.currentPattern)return!1;const r=this.getCurrentBankData();if(!r)return!1;const s=r.tracks[e];return!(!s||t<0||t>=s.steps.length)&&s.steps[t]}switchBank(e){if(!this.currentPattern)throw new Error("No pattern is currently loaded");if(e<0||e>=this.currentPattern.banks.length)throw new Error("Bank index must be between 0 and "+(this.currentPattern.banks.length-1));this.currentBank=e,this.currentPattern.currentBank=e,this.currentPattern.metadata.modified=(new Date).toISOString()}getCurrentBankData(){return this.currentPattern&&this.currentPattern.banks&&this.currentPattern.banks[this.currentBank]||null}assignChopToTrack(e,t){if(!this.currentPattern)throw new Error("No pattern is currently loaded");if(t<0||t>=this.tracksPerBank)throw new Error("Track index must be between 0 and "+(this.tracksPerBank-1));const r=this.getCurrentBankData();if(!r)throw new Error("Current bank data not found");const s=r.tracks[t];if(!s)throw new Error(`Track ${t} not found in current bank`);s.chopId&&this.chopAssignments.delete(s.chopId),s.chopId=e,e&&this.chopAssignments.set(e,t),this.currentPattern.metadata.modified=(new Date).toISOString()}autoAssignChops(e){if(!this.currentPattern||!Array.isArray(e))return;this.chopAssignments.clear();const t=this.groupChopsByBank(e);Object.entries(t).forEach(([e,t])=>{const r=e.charCodeAt(0)-65;if(r>=0&&r<this.currentPattern.banks.length){const e=this.currentPattern.banks[r];t.forEach((t,r)=>{if(r<this.tracksPerBank){e.tracks[r].chopId=t.padId,this.chopAssignments.set(t.padId,r)}})}}),this.currentPattern.metadata.modified=(new Date).toISOString()}groupChopsByBank(e){const t={};return e.forEach(e=>{if(e.padId&&"string"==typeof e.padId){const r=e.padId.charAt(0).toUpperCase();t[r]||(t[r]=[]),t[r].push(e)}}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>(parseInt(e.padId.slice(1))||0)-(parseInt(t.padId.slice(1))||0))}),t}getChopForTrack(e){const t=this.getCurrentBankData();if(!t)return null;const r=t.tracks[e];return r?r.chopId:null}getTrackForChop(e){return this.chopAssignments.get(e)||null}getActiveStepsForStep(e){const t=this.getCurrentBankData();if(!t)return[];const r=[];return t.tracks.forEach((t,s)=>{t.steps[e]&&t.chopId&&r.push({trackIndex:s,chopId:t.chopId})}),r}clearCurrentBank(){const e=this.getCurrentBankData();e&&(e.tracks.forEach(e=>{e.steps.fill(!1)}),this.currentPattern.metadata.modified=(new Date).toISOString())}clearAllBanks(){this.currentPattern&&(this.currentPattern.banks.forEach(e=>{e.tracks.forEach(e=>{e.steps.fill(!1)})}),this.currentPattern.metadata.modified=(new Date).toISOString())}getCurrentPattern(){return this.currentPattern}setCurrentPattern(e,t={}){const{autoFix:s=!0,strict:a=!1,throwOnError:n=!1}=t;if(!e)return this.currentPattern=null,this.currentBank=0,this.chopAssignments.clear(),{success:!0,pattern:null};try{const t=r.validateAndSanitize(e,{autoFix:s,strict:a,throwOnError:n});if(!t.isValid){const e=`Pattern validation failed: ${t.errors.join(", ")}`;if(n)throw new Error(e);return{success:!1,errors:t.errors,warnings:t.warnings,pattern:null}}return this.currentPattern=t.sanitizedPattern,this.currentBank=this.currentPattern.currentBank||0,this.rebuildChopAssignments(),t.fixes.length,t.warnings.length,{success:!0,pattern:this.currentPattern,fixes:t.fixes,warnings:t.warnings}}catch(i){if(n)throw i;return{success:!1,errors:[i.message],pattern:null}}}rebuildChopAssignments(){this.chopAssignments.clear(),this.currentPattern&&this.currentPattern.banks.forEach(e=>{e.tracks.forEach((e,t)=>{e.chopId&&this.chopAssignments.set(e.chopId,t)})})}validatePattern(e){if(!e||"object"!=typeof e)return!1;if(!e.id||"string"!=typeof e.id)return!1;if(!e.name||"string"!=typeof e.name)return!1;if("number"!=typeof e.bpm||e.bpm<60||e.bpm>200)return!1;if("number"!=typeof e.currentBank||e.currentBank<0)return!1;if(!Array.isArray(e.banks)||0===e.banks.length)return!1;for(const t of e.banks)if(!this.validateBank(t))return!1;return!0}validateBank(e){if(!e||"object"!=typeof e)return!1;if("number"!=typeof e.bankId||e.bankId<0)return!1;if(!e.name||"string"!=typeof e.name)return!1;if(!Array.isArray(e.tracks)||e.tracks.length!==this.tracksPerBank)return!1;for(const t of e.tracks)if(!this.validateTrack(t))return!1;return!0}validateTrack(e){if(!e||"object"!=typeof e)return!1;if("number"!=typeof e.trackIndex||e.trackIndex<0)return!1;if(!Array.isArray(e.steps)||e.steps.length!==this.stepsPerTrack)return!1;for(const t of e.steps)if("boolean"!=typeof t)return!1;return!0}generatePatternId(){return`sampler_pattern_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getPatternStats(){if(!this.currentPattern)return{totalSteps:0,activeSteps:0,assignedTracks:0,totalTracks:0};let e=0,t=0,r=0,s=0;return this.currentPattern.banks.forEach(a=>{a.tracks.forEach(a=>{s++,e+=a.steps.length,a.chopId&&r++,a.steps.forEach(e=>{e&&t++})})}),{totalSteps:e,activeSteps:t,assignedTracks:r,totalTracks:s}}destroy(){this.currentPattern=null,this.chopAssignments.clear(),this.currentBank=0}}class a{constructor(){this.youtubePlayer=null,this.isConnected=!1,this.isDegraded=!1,this.degradationReason=null,this.errorLog=[],this.lastSeekTime=0,this.isSeekInProgress=!1,this.errorCallbacks=[],this.degradationCallbacks=[],this.stats={totalSeeks:0,successfulSeeks:0,failedSeeks:0,averageSeekLatency:0,degradationEvents:0,recoveryEvents:0},this.degradationConfig={maxConsecutiveFailures:50,failureTimeWindow:12e4,autoRecoveryInterval:1e4},this.recentFailures=[],this.autoRecoveryTimer=null}connect(e){if(!e)return!1;return["seekTo","getCurrentTime","getPlayerState"].filter(t=>"function"!=typeof e[t]).length,this.youtubePlayer=e,this.isConnected=!0,this.isDegraded&&this.exitDegradedMode("New player connection established"),!0}disconnect(){this.youtubePlayer=null,this.isConnected=!1,this.isSeekInProgress=!1}async jumpToTimestamp(e,t=!0,r=!0){if(this.isDegraded)return!1;if("number"!=typeof e||isNaN(e)||e<0)return!1;if(!this.isConnected||!this.youtubePlayer)return!1;if(!t)return!0;this.isSeekInProgress;const s=performance.now();this.isSeekInProgress=!0,this.stats.totalSeeks++;try{const t=this.youtubePlayer.getPlayerState();if(-1===t)return this.handleSeekFailure("Cannot seek: player not ready"),!1;const a=1===t;this.youtubePlayer.seekTo(e,!0),this.lastSeekTime=e,r&&(await new Promise(e=>setTimeout(e,10)),a&&1!==this.youtubePlayer.getPlayerState()?this.youtubePlayer.playVideo():a||1!==this.youtubePlayer.getPlayerState()||this.youtubePlayer.pauseVideo());const n=performance.now()-s;return this.updateSeekLatency(n),this.stats.successfulSeeks++,this.clearRecentFailures(),!0}catch(a){return this.handleSeekFailure(`Seek failed: ${a.message}`),!1}finally{this.isSeekInProgress=!1}}fastSeekForChop(e){if("number"!=typeof e||isNaN(e)||e<0)return!1;if(!this.isConnected||!this.youtubePlayer)return!1;try{return this.youtubePlayer.seekTo(e,!0),this.lastSeekTime=e,this.stats.totalSeeks++,this.stats.successfulSeeks++,!0}catch(t){throw t}}handleSeekFailure(e){this.logError(e),this.stats.failedSeeks++,this.recentFailures.push({timestamp:Date.now(),error:e});const t=Date.now();this.recentFailures=this.recentFailures.filter(e=>t-e.timestamp<this.degradationConfig.failureTimeWindow),this.recentFailures.length>=this.degradationConfig.maxConsecutiveFailures&&this.enterDegradedMode("Too many consecutive seek failures")}enterDegradedMode(e){this.isDegraded||(this.isDegraded=!0,this.degradationReason=e,this.stats.degradationEvents++,this.degradationCallbacks.forEach(t=>{try{t({type:"degradation",reason:e,timestamp:Date.now()})}catch(r){}}),this.scheduleAutoRecovery())}exitDegradedMode(e="Manual recovery"){this.isDegraded&&(this.isDegraded=!1,this.degradationReason=null,this.stats.recoveryEvents++,this.clearRecentFailures(),this.autoRecoveryTimer&&(clearTimeout(this.autoRecoveryTimer),this.autoRecoveryTimer=null),this.degradationCallbacks.forEach(t=>{try{t({type:"recovery",reason:e,timestamp:Date.now()})}catch(r){}}))}scheduleAutoRecovery(){this.autoRecoveryTimer&&clearTimeout(this.autoRecoveryTimer),this.autoRecoveryTimer=setTimeout(async()=>{await this.attemptRecovery()?this.exitDegradedMode("Automatic recovery successful"):this.scheduleAutoRecovery()},this.degradationConfig.autoRecoveryInterval)}clearRecentFailures(){this.recentFailures=[]}getCurrentTime(){if(!this.isConnected||!this.youtubePlayer)return 0;try{return this.youtubePlayer.getCurrentTime()||0}catch(e){return this.logError(`Failed to get current time: ${e.message}`),0}}getPlayerState(){if(!this.isConnected||!this.youtubePlayer)return-1;try{return this.youtubePlayer.getPlayerState()}catch(e){return this.logError(`Failed to get player state: ${e.message}`),-1}}getDetailedPlayerState(){if(!this.isConnected||!this.youtubePlayer)return{state:-1,currentTime:0,duration:0,isPlaying:!1,isPaused:!1,isBuffering:!1,isReady:!1};try{const e=this.youtubePlayer.getPlayerState(),t=this.youtubePlayer.getCurrentTime()||0;return{state:e,currentTime:t,duration:this.youtubePlayer.getDuration()||0,isPlaying:1===e,isPaused:2===e,isBuffering:3===e,isReady:-1!==e,isEnded:0===e}}catch(e){return this.logError(`Failed to get detailed player state: ${e.message}`),{state:-1,currentTime:0,duration:0,isPlaying:!1,isPaused:!1,isBuffering:!1,isReady:!1,isEnded:!1}}}async synchronizeState(e){if(!this.isConnected||!this.youtubePlayer)return this.logError("Cannot synchronize: YouTube player not connected"),!1;try{const t=this.getDetailedPlayerState();let r=!0;if("number"==typeof e.currentTime){if(Math.abs(t.currentTime-e.currentTime)>.5){await this.jumpToTimestamp(e.currentTime,!0,void 0!==e.isPlaying?e.isPlaying:t.isPlaying)||(r=!1)}}if("boolean"==typeof e.isPlaying){await new Promise(e=>setTimeout(e,100));const t=this.getDetailedPlayerState();e.isPlaying&&!t.isPlaying?this.youtubePlayer.playVideo():!e.isPlaying&&t.isPlaying&&this.youtubePlayer.pauseVideo()}return r}catch(t){return this.logError(`State synchronization failed: ${t.message}`),!1}}isPlayerReady(){if(!this.isConnected||!this.youtubePlayer)return!1;try{return-1!==this.youtubePlayer.getPlayerState()}catch(e){return!1}}getStatus(){return{isConnected:this.isConnected,isPlayerReady:this.isPlayerReady(),isSeekInProgress:this.isSeekInProgress,isDegraded:this.isDegraded,degradationReason:this.degradationReason,lastSeekTime:this.lastSeekTime,errorCount:this.errorLog.length,recentFailures:this.recentFailures.length,stats:{...this.stats}}}getRecentErrors(e=10){return this.errorLog.slice(-e)}clearErrors(){this.errorLog=[]}onError(e){"function"==typeof e&&this.errorCallbacks.push(e)}removeErrorCallback(e){const t=this.errorCallbacks.indexOf(e);t>-1&&this.errorCallbacks.splice(t,1)}forceRecovery(){if(!this.isDegraded)return!0;if(this.clearRecentFailures(),this.youtubePlayer&&"function"==typeof this.youtubePlayer.getCurrentTime)try{return this.youtubePlayer.getCurrentTime(),this.exitDegradedMode("Manual recovery - player test successful"),!0}catch(e){return this.exitDegradedMode("Manual recovery - forced exit despite test failure"),!0}return this.exitDegradedMode("Manual recovery - forced exit"),!0}forceExitDegradedMode(){this.isDegraded&&(this.clearRecentFailures(),this.exitDegradedMode("Forced exit for sequencer playback"))}onDegradation(e){"function"==typeof e&&this.degradationCallbacks.push(e)}removeDegradationCallback(e){const t=this.degradationCallbacks.indexOf(e);t>-1&&this.degradationCallbacks.splice(t,1)}async forceRecovery(){return!!(await this.attemptRecovery())&&(this.exitDegradedMode("Forced recovery"),!0)}async testConnection(){if(!this.isConnected||!this.youtubePlayer)return!1;try{this.getCurrentTime(),this.getPlayerState();return!0}catch(e){return this.logError(`Connection test failed: ${e.message}`),!1}}async attemptRecovery(){if(!this.youtubePlayer)return this.logError("Cannot recover: no YouTube player instance"),!1;try{this.isSeekInProgress=!1;return!!(await this.testConnection())||(this.logError("YouTube player recovery failed: connection test failed"),!1)}catch(e){return this.logError(`Recovery attempt failed: ${e.message}`),!1}}async handlePlayerError(e){this.logError(`Player error occurred: ${e.message}`);switch(this.classifyPlayerError(e)){case"seek_error":case"state_error":case"timing_error":default:return await this.attemptRecovery();case"network_error":return await this.attemptNetworkRecovery();case"permission_error":case"unavailable_error":return!1}}classifyPlayerError(e){const t=e.message.toLowerCase();return t.includes("seek")||t.includes("timestamp")?"seek_error":t.includes("state")||t.includes("player state")?"state_error":t.includes("timing")||t.includes("sync")?"timing_error":t.includes("network")||t.includes("connection")||t.includes("timeout")?"network_error":t.includes("permission")||t.includes("forbidden")||t.includes("unauthorized")?"permission_error":t.includes("unavailable")||t.includes("private")||t.includes("deleted")?"unavailable_error":"unknown_error"}async attemptNetworkRecovery(){try{if(await new Promise(e=>setTimeout(e,2e3)),!navigator.onLine)return this.logError("Device is offline, cannot recover network connection"),!1;return!!(await this.testConnection())||(this.logError("Network recovery failed: player still unresponsive"),!1)}catch(e){return this.logError(`Network recovery attempt failed: ${e.message}`),!1}}getErrorRecoverySuggestions(e){const t={userAction:"Try refreshing the page",technicalAction:"Reconnect YouTube player",canRetry:!0};return e.includes("not connected")||e.includes("not ready")?(t.userAction="Wait for video to load completely",t.technicalAction="Reinitialize player connection"):e.includes("seek")||e.includes("timestamp")?(t.userAction="Try playing the video first",t.technicalAction="Verify video is seekable"):e.includes("state")?(t.userAction="Check if video is still available",t.technicalAction="Refresh player state"):(e.includes("network")||e.includes("timeout"))&&(t.userAction="Check your internet connection",t.technicalAction="Retry with network recovery",t.canRetry=!0),t}getPerformanceStats(){const e=this.stats.totalSeeks>0?this.stats.successfulSeeks/this.stats.totalSeeks*100:0;return{...this.stats,successRate:e.toFixed(2),errorRate:(100-e).toFixed(2)}}resetStats(){this.stats={totalSeeks:0,successfulSeeks:0,failedSeeks:0,averageSeekLatency:0}}logError(e){const t={timestamp:(new Date).toISOString(),message:e};this.errorLog.push(t),this.errorLog.length>50&&(this.errorLog=this.errorLog.slice(-50)),this.errorCallbacks.forEach(e=>{try{e(t)}catch(r){}})}updateSeekLatency(e){const t=this.stats.averageSeekLatency*(this.stats.successfulSeeks-1);this.stats.averageSeekLatency=(t+e)/this.stats.successfulSeeks}destroy(){this.autoRecoveryTimer&&(clearTimeout(this.autoRecoveryTimer),this.autoRecoveryTimer=null),this.disconnect(),this.errorCallbacks=[],this.degradationCallbacks=[],this.errorLog=[],this.recentFailures=[],this.resetStats(),this.isDegraded=!1,this.degradationReason=null}}class n{constructor(e){this.patternManager=e,this.currentChops=[],this.chopListeners=new Map,this.onChopAssignmentChange=null}setChopAssignmentChangeCallback(e){this.onChopAssignmentChange=e}updateChops(e){if(!Array.isArray(e))return;const t=[...this.currentChops];this.currentChops=[...e];const r=this.detectChopChanges(t,e);r.added.length>0&&this.handleNewChops(r.added),r.removed.length>0&&this.handleRemovedChops(r.removed),r.modified.length>0&&this.handleModifiedChops(r.modified),0===t.length&&e.length>0&&this.patternManager.autoAssignChops(this.currentChops),this.notifyChopAssignmentChange()}detectChopChanges(e,t){const r={added:[],removed:[],modified:[]},s=new Map(e.map(e=>[e.padId,e])),a=new Map(t.map(e=>[e.padId,e]));for(const n of t)s.has(n.padId)||r.added.push(n);for(const n of e)a.has(n.padId)||r.removed.push(n);for(const n of t){const e=s.get(n.padId);e&&this.hasChopChanged(e,n)&&r.modified.push({previous:e,current:n})}return r}hasChopChanged(e,t){return e.startTime!==t.startTime||e.endTime!==t.endTime||e.color!==t.color}handleNewChops(e){this.patternManager.getCurrentPattern()&&this.patternManager.autoAssignChops(this.currentChops)}handleRemovedChops(e){this.patternManager.getCurrentPattern()&&e.forEach(e=>{this.patternManager.getCurrentPattern().banks.forEach((t,r)=>{t.tracks.forEach((t,s)=>{if(t.chopId===e.padId){const e=this.patternManager.currentBank;this.patternManager.switchBank(r),this.patternManager.assignChopToTrack(null,s),this.patternManager.switchBank(e)}})})})}handleModifiedChops(e){e.forEach(({previous:e,current:t})=>{})}groupChopsByBank(e){const t={};return e.forEach(e=>{if(!e||"object"!=typeof e||!e.padId||"string"!=typeof e.padId)return;const r=e.padId.charAt(0).toUpperCase();t[r]||(t[r]=[]),t[r].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>(parseInt(e.padId.slice(1))||0)-(parseInt(t.padId.slice(1))||0))}),t}assignChopsToBank(e,t){const r=this.patternManager.getCurrentPattern();if(!r||!r.banks[t])return;const s=r.banks[t];e.forEach((e,r)=>{if(r<s.tracks.length){const r=parseInt(e.padId.slice(1))||0,a=Math.min(r,s.tracks.length-1),n=this.patternManager.currentBank;if(this.patternManager.switchBank(t),s.tracks[a].chopId){const t=this.findNextAvailableTrack(s);-1!==t&&this.patternManager.assignChopToTrack(e.padId,t)}else this.patternManager.assignChopToTrack(e.padId,a);this.patternManager.switchBank(n)}})}findNextAvailableTrack(e){for(let t=0;t<e.tracks.length;t++)if(!e.tracks[t].chopId)return t;return-1}getChopForTrack(e){const t=this.patternManager.getChopForTrack(e);return t&&this.currentChops.find(e=>e.padId===t)||null}getChopsForCurrentBank(){if(!this.patternManager.getCurrentPattern())return[];const e=this.patternManager.getCurrentBankData();if(!e)return[];const t=[];return e.tracks.forEach(e=>{if(e.chopId){const r=this.currentChops.find(t=>t.padId===e.chopId);r&&t.push(r)}}),t}getCurrentBankAssignments(){const e=this.patternManager.getCurrentBankData();return e?e.tracks.map((e,t)=>({trackIndex:t,chopId:e.chopId,chop:e.chopId?this.currentChops.find(t=>t.padId===e.chopId):null})):[]}reassignAllChops(){this.patternManager.getCurrentPattern()&&(this.clearAllAssignments(),this.patternManager.autoAssignChops(this.currentChops),this.notifyChopAssignmentChange())}clearAllAssignments(){const e=this.patternManager.getCurrentPattern();e&&e.banks.forEach(e=>{e.tracks.forEach((e,t)=>{e.chopId&&this.patternManager.assignChopToTrack(null,t)})})}notifyChopAssignmentChange(){if(this.onChopAssignmentChange){const e=this.getCurrentBankAssignments();this.onChopAssignmentChange(e)}}getIntegrationStats(){const e=this.patternManager.getCurrentPattern();if(!e)return{totalChops:this.currentChops.length,assignedChops:0,unassignedChops:this.currentChops.length,totalTracks:0,assignedTracks:0};let t=0,r=0;const s=new Set;return e.banks.forEach(e=>{e.tracks.forEach(e=>{t++,e.chopId&&(r++,s.add(e.chopId))})}),{totalChops:this.currentChops.length,assignedChops:s.size,unassignedChops:this.currentChops.length-s.size,totalTracks:t,assignedTracks:r}}handleChopDeletion(e){this.currentChops=this.currentChops.filter(t=>t.padId!==e);const t=this.patternManager.getTrackForChop(e);null!==t&&this.patternManager.assignChopToTrack(null,t),this.notifyChopAssignmentChange()}handleChopCreation(e){const t=this.currentChops.findIndex(t=>t.padId===e.padId);-1===t?this.currentChops.push(e):this.currentChops[t]=e,this.handleNewChops([e])}handleChopModification(e){const t=this.currentChops.findIndex(t=>t.padId===e.padId);if(-1!==t){const r=this.currentChops[t];this.currentChops[t]=e,this.handleModifiedChops([{previous:r,current:e}])}}destroy(){this.currentChops=[],this.chopListeners.clear(),this.onChopAssignmentChange=null}}class i{constructor(){this.engine=new t,this.patternManager=new s,this.youtubeInterface=new a,this.chopIntegration=new n(this.patternManager),this.renderer=new e,this.isInitialized=!1,this.chopsData=new Map,this.stepCallbacks=[],this.stateChangeCallbacks=[],this.errorCallbacks=[],this.performanceConfig={maxConcurrentChops:8,audioLookahead:25,renderThrottle:16,memoryCleanupInterval:3e4},this.activeChops=new Set,this.lastCleanupTime=0,this.setupEngineCallbacks(),this.setupPerformanceOptimizations()}async initialize(e,t=[]){try{if(!(await this.engine.initialize(e)))throw new Error("Failed to initialize high-performance engine");if(!this.youtubeInterface.connect(e))throw new Error("Failed to connect YouTube player interface");if(!this.patternManager.createPattern("Default Pattern").success)throw new Error("Failed to create default pattern");return this.loadChopsData(t),this.optimizeChopsForPerformance(),this.chopIntegration.setChopAssignmentChangeCallback(e=>{this.renderer.scheduleUpdate(()=>{this.notifyStateChange(this.engine.getState())},"chop-assignments")}),this.chopIntegration.updateChops(t),this.isInitialized=!0,!0}catch(r){return this.notifyError(r),!1}}setupEngineCallbacks(){this.engine.addStepCallback((e,t)=>{this.handleOptimizedStep(e,t)}),this.engine.addStateChangeCallback(e=>{this.renderer.scheduleUpdate(()=>{this.notifyStateChange(e)},`state-${e.currentStep}-${e.isPlaying}`)})}setupPerformanceOptimizations(){setInterval(()=>{this.performMemoryCleanup()},this.performanceConfig.memoryCleanupInterval),setInterval(()=>{this.monitorPerformance()},5e3)}handleOptimizedStep(e,t){try{const r=this.patternManager.getCurrentPattern();if(!r)return;const s=this.getTriggeredChopsForStep(e,r),a=this.performanceConfig.maxConcurrentChops-this.activeChops.size;s.slice(0,a).forEach(e=>{this.executeChopPlayback(e,t)}),this.renderer.scheduleUpdate(()=>{this.stepCallbacks.forEach(r=>{try{r(e,t)}catch(s){}})},`step-${e}`)}catch(r){}}executeChopPlayback(e,t){const r=this.chopsData.get(e);if(r)try{this.activeChops.add(e),this.engine.jumpToTimestamp(r.startTime,!0),setTimeout(()=>{this.activeChops.delete(e)},1e3*r.duration||1e3)}catch(s){this.activeChops.delete(e)}}getTriggeredChopsForStep(e,t){const r=[];return t.tracks?(t.tracks.forEach(t=>{if(t.steps&&t.steps[e]&&t.steps[e].active){const e=this.chopIntegration.getChopAssignments()[t.id];e&&r.push(e)}}),r):r}loadChopsData(e){this.chopsData.clear(),e.forEach(e=>{if(e&&e.id){const t={...e,duration:e.endTime-e.startTime,isOptimized:!0,preloadTime:Date.now()};this.chopsData.set(e.id,t)}})}optimizeChopsForPerformance(){const e=new Map;this.chopsData.forEach((t,r)=>{e.set(r,0)});Array.from(e.entries()).sort((e,t)=>t[1]-e[1]).slice(0,this.performanceConfig.maxConcurrentChops).forEach(([e])=>{const t=this.chopsData.get(e);t&&(t.isPreWarmed=!0)})}performMemoryCleanup(){const e=Date.now();this.activeChops.forEach(t=>{const r=this.chopsData.get(t);r&&e-r.preloadTime>6e4&&this.activeChops.delete(t)}),this.renderer.resetPerformanceMetrics(),this.lastCleanupTime=e}monitorPerformance(){const e=this.engine.getPerformanceMetrics(),t=this.renderer.getPerformanceMetrics();e.jitter>10?this.performanceConfig.maxConcurrentChops=Math.max(4,this.performanceConfig.maxConcurrentChops-1):e.jitter<2&&(this.performanceConfig.maxConcurrentChops=Math.min(8,this.performanceConfig.maxConcurrentChops+1)),e.jitter>20||t.droppedFrames}start(){if(!this.isInitialized)throw new Error("Service must be initialized before starting");this.engine.start()}stop(){this.engine.stop(),this.activeChops.clear()}pause(){this.engine.pause()}resume(){this.engine.resume()}setBPM(e){if(e<60||e>200)throw new Error("BPM must be between 60 and 200");this.engine.setBPM(e)}getBPM(){return this.engine.bpm}getState(){const e=this.engine.getState(),t=this.renderer.getPerformanceMetrics();return{...e,activeChops:this.activeChops.size,performanceConfig:this.performanceConfig,renderMetrics:t}}addStepCallback(e){"function"==typeof e&&this.stepCallbacks.push(e)}removeStepCallback(e){const t=this.stepCallbacks.indexOf(e);t>-1&&this.stepCallbacks.splice(t,1)}addStateChangeCallback(e){"function"==typeof e&&this.stateChangeCallbacks.push(e)}removeStateChangeCallback(e){const t=this.stateChangeCallbacks.indexOf(e);t>-1&&this.stateChangeCallbacks.splice(t,1)}addErrorCallback(e){"function"==typeof e&&this.errorCallbacks.push(e)}notifyStateChange(e){this.stateChangeCallbacks.forEach(t=>{try{t(e)}catch(r){}})}notifyError(e){this.errorCallbacks.forEach(t=>{try{t(e)}catch(r){}})}getPerformanceMetrics(){return{engine:this.engine.getPerformanceMetrics(),renderer:this.renderer.getPerformanceMetrics(),service:{activeChops:this.activeChops.size,totalChops:this.chopsData.size,lastCleanup:this.lastCleanupTime,config:this.performanceConfig}}}cleanup(){this.stop(),this.engine.cleanup(),this.renderer.cleanup(),this.chopsData.clear(),this.activeChops.clear(),this.stepCallbacks=[],this.stateChangeCallbacks=[],this.errorCallbacks=[],this.isInitialized=!1}}export{e as H,i as O};
