import{C as e}from"./waveform-core-ygTHjRxL.js";import{W as t,a as r,b as a}from"./waveform-performance-BxG7lKLN.js";class i{constructor(e={}){this.options={enableFrequencyColorCoding:!0,enableAmplitudeColorCoding:!0,enableStructureDetection:!0,enableAccessibilityMode:!1,enableHighContrastMode:!1,colorScheme:"default",...e},this.frequencyColorSchemes={default:{bass:{r:220,g:38,b:127},lowMid:{r:239,g:68,b:68},mid:{r:245,g:158,b:11},highMid:{r:34,g:197,b:94},treble:{r:59,g:130,b:246}},"high-contrast":{bass:{r:255,g:255,b:255},lowMid:{r:255,g:255,b:0},mid:{r:255,g:0,b:255},highMid:{r:0,g:255,b:255},treble:{r:0,g:0,b:0}},"colorblind-friendly":{bass:{r:0,g:114,b:178},lowMid:{r:230,g:159,b:0},mid:{r:0,g:158,b:115},highMid:{r:204,g:121,b:167},treble:{r:86,g:180,b:233}}},this.amplitudeColorMap={silent:{alpha:.1,brightness:.3},quiet:{alpha:.3,brightness:.5},moderate:{alpha:.6,brightness:.7},loud:{alpha:.8,brightness:.9},peak:{alpha:1,brightness:1}},this.structurePatterns={verse:{color:{r:100,g:149,b:237},pattern:"solid",description:"Verse section"},chorus:{color:{r:255,g:215,b:0},pattern:"gradient",description:"Chorus section"},bridge:{color:{r:147,g:112,b:219},pattern:"dashed",description:"Bridge section"},intro:{color:{r:60,g:179,b:113},pattern:"dotted",description:"Intro section"},outro:{color:{r:205,g:92,b:92},pattern:"dotted",description:"Outro section"},break:{color:{r:255,g:140,b:0},pattern:"sparse",description:"Break/Drop section"}},this.accessibilityPatterns={bass:{pattern:"vertical-lines",density:"high"},lowMid:{pattern:"diagonal-lines",density:"medium"},mid:{pattern:"dots",density:"medium"},highMid:{pattern:"horizontal-lines",density:"low"},treble:{pattern:"cross-hatch",density:"sparse"}},this.cache=new Map}applyFrequencyColorCoding(e,t){if(!this.options.enableFrequencyColorCoding||!t)return this.getDefaultWaveformColors();const r=`freq-${e.duration}-${this.options.colorScheme}`;if(this.cache.has(r))return this.cache.get(r);const a=this.frequencyColorSchemes[this.options.colorScheme]||this.frequencyColorSchemes.default,i=[],n=Math.floor(t.length/100);for(let o=0;o<100;o++){const r=o*n,s=Math.min((o+1)*n,t.length),l=this.analyzeFrequencyContent(t.slice(r,s)),c=this.getDominantFrequencyColor(l,a);i.push({startTime:o/100*e.duration,endTime:(o+1)/100*e.duration,color:c,frequencyProfile:l})}return this.cache.set(r,i),i}applyAmplitudeColorCoding(e){if(!this.options.enableAmplitudeColorCoding)return null;const{samples:t}=e;if(!t)return null;const r=[],a=Math.floor(t.length/200);for(let i=0;i<200;i++){const n=i*a,o=Math.min((i+1)*a,t.length),s=this.calculateRMS(t.slice(n,o)),l=this.categorizeAmplitude(s);r.push({startTime:n/t.length*e.duration,endTime:o/t.length*e.duration,amplitude:s,level:l,colorModifier:this.amplitudeColorMap[l]})}return r}detectSongStructure(e,t={}){if(!this.options.enableStructureDetection)return[];const r=`structure-${e.duration}-${JSON.stringify(t)}`;if(this.cache.has(r))return this.cache.get(r);const{samples:a,duration:i}=e;if(!a||!i)return[];const n=[],o=this.analyzeEnergyProfile(a,i);return this.identifyStructuralSections(o,i,t).forEach(e=>{const t=this.structurePatterns[e.type]||this.structurePatterns.verse;n.push({...e,visualPattern:t,accessibilityLabel:t.description})}),this.cache.set(r,n),n}applyHighContrastMode(e){return this.options.enableHighContrastMode?e.map(e=>({...e,color:this.convertToHighContrast(e.color),strokeWidth:Math.max(e.strokeWidth||1,2),shadowBlur:4,shadowColor:"rgba(0, 0, 0, 0.8)"})):e}generateAccessibilityPatterns(e){if(!this.options.enableAccessibilityMode)return null;const t=[],r=Math.floor(e.length/50);for(let a=0;a<50;a++){const i=a*r,n=Math.min((a+1)*r,e.length),o=this.analyzeFrequencyContent(e.slice(i,n)),s=this.getDominantFrequency(o),l=this.accessibilityPatterns[s];t.push({startTime:a/50*(e.length/44100),endTime:(a+1)/50*(e.length/44100),pattern:l.pattern,density:l.density,frequencyType:s})}return t}createVisualSettings(){return{frequencyColorCoding:{enabled:this.options.enableFrequencyColorCoding,colorScheme:this.options.colorScheme,intensity:.8,blendMode:"normal"},amplitudeColorCoding:{enabled:this.options.enableAmplitudeColorCoding,sensitivity:.7,dynamicRange:!0},structureDetection:{enabled:this.options.enableStructureDetection,sensitivity:.6,showLabels:!0,showPatterns:!0},accessibility:{highContrastMode:this.options.enableHighContrastMode,alternativePatterns:this.options.enableAccessibilityMode,textSize:"medium",reducedMotion:!1},enhancements:{gradientFill:!0,shadowEffects:!1,animatedElements:!0,particleEffects:!1}}}updateVisualSettings(e,t){const r={...this.options};if(Object.assign(this.options,{enableFrequencyColorCoding:e.frequencyColorCoding?.enabled??this.options.enableFrequencyColorCoding,enableAmplitudeColorCoding:e.amplitudeColorCoding?.enabled??this.options.enableAmplitudeColorCoding,enableStructureDetection:e.structureDetection?.enabled??this.options.enableStructureDetection,enableHighContrastMode:e.accessibility?.highContrastMode??this.options.enableHighContrastMode,enableAccessibilityMode:e.accessibility?.alternativePatterns??this.options.enableAccessibilityMode,colorScheme:e.frequencyColorCoding?.colorScheme??this.options.colorScheme}),this.cache.clear(),t&&"function"==typeof t)try{t(this.options,r)}catch(a){Object.assign(this.options,r)}return this.options}analyzeFrequencyContent(e){return{bassEnergy:this.calculateBandEnergy(e,0,10),lowMidEnergy:this.calculateBandEnergy(e,10,20),midEnergy:this.calculateBandEnergy(e,20,80),highMidEnergy:this.calculateBandEnergy(e,80,160),trebleEnergy:this.calculateBandEnergy(e,160,255)}}calculateBandEnergy(e,t,r){let a=0;for(let i=t;i<=Math.min(r,e.length-1);i++)a+=e[i]*e[i];return Math.sqrt(a/(r-t+1))}getDominantFrequencyColor(e,t){const{bassEnergy:r,lowMidEnergy:a,midEnergy:i,highMidEnergy:n,trebleEnergy:o}=e,s={bassEnergy:r,lowMidEnergy:a,midEnergy:i,highMidEnergy:n,trebleEnergy:o},l=Object.keys(s).reduce((e,t)=>s[e]>s[t]?e:t),c={bassEnergy:t.bass,lowMidEnergy:t.lowMid,midEnergy:t.mid,highMidEnergy:t.highMid,trebleEnergy:t.treble}[l],h=s[l]/255;return{r:Math.round(c.r*h),g:Math.round(c.g*h),b:Math.round(c.b*h),a:Math.min(.8,h)}}getDominantFrequency(e){const{bassEnergy:t,lowMidEnergy:r,midEnergy:a,highMidEnergy:i,trebleEnergy:n}=e,o={bass:t,lowMid:r,mid:a,highMid:i,treble:n};return Object.keys(o).reduce((e,t)=>o[e]>o[t]?e:t)}calculateRMS(e){if(!e||0===e.length)return 0;let t=0;for(let r=0;r<e.length;r++)t+=e[r]*e[r];return Math.sqrt(t/e.length)}categorizeAmplitude(e){return e<.01?"silent":e<.1?"quiet":e<.5?"moderate":e<.8?"loud":"peak"}analyzeEnergyProfile(e,t){const r=Math.floor(e.length/100),a=[];for(let i=0;i<100;i++){const n=i*r,o=Math.min((i+1)*r,e.length),s=e.slice(n,o),l=this.calculateRMS(s),c=this.calculateSpectralCentroid(s);a.push({time:i/100*t,energy:l,spectralCentroid:c,variance:this.calculateVariance(s)})}return a}identifyStructuralSections(e,t,r){const a=[];let i=null;return e.forEach((r,n)=>{const o=this.classifySection(r,e,n);i&&i.type===o||(i&&(i.endTime=r.time,a.push(i)),i={type:o,startTime:r.time,endTime:t,confidence:.7})}),i&&a.push(i),a}classifySection(e,t,r){const{energy:a,spectralCentroid:i,variance:n}=e;return r<5?"intro":r>t.length-5?"outro":a>.7&&i>.6?"chorus":a<.3&&n<.2?"break":i<.4&&n>.5?"bridge":"verse"}calculateSpectralCentroid(e){let t=0,r=0;for(let a=0;a<e.length;a++){const i=Math.abs(e[a]);t+=a*i,r+=i}return r>0?t/r/e.length:0}calculateVariance(e){if(0===e.length)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,r=e.reduce((e,r)=>e+Math.pow(r-t,2),0)/e.length;return Math.sqrt(r)}convertToHighContrast(e){const{r:t,g:r,b:a,a:i}=e;return.299*t+.587*r+.114*a>128?{r:255,g:255,b:255,a:i||1}:{r:0,g:0,b:0,a:i||1}}getDefaultWaveformColors(){return[{startTime:0,endTime:1/0,color:{r:6,g:182,b:212,a:.8}}]}destroy(){this.cache.clear()}}const n=Object.freeze(Object.defineProperty({__proto__:null,VisualEnhancementEngine:i},Symbol.toStringTag,{value:"Module"}));class o extends e{constructor(e,t={}){super(e,t),this.visualEnhancementEngine=new i({enableFrequencyColorCoding:!1!==t.enableFrequencyColorCoding,enableAmplitudeColorCoding:!1!==t.enableAmplitudeColorCoding,enableStructureDetection:!1!==t.enableStructureDetection,enableAccessibilityMode:t.enableAccessibilityMode||!1,enableHighContrastMode:t.enableHighContrastMode||!1,colorScheme:t.colorScheme||"default"}),this.frequencyColorData=null,this.amplitudeColorData=null,this.structureData=null,this.accessibilityPatterns=null,this.patternCache=new Map,this.animationState={time:0,pulsePhase:0,particleSystem:null},this.initializeEnhancedFeatures()}initializeEnhancedFeatures(){this.layerManager.createLayer("frequency-overlay",1.5,{alpha:!0}),this.layerManager.createLayer("structure-overlay",2.5,{alpha:!0}),this.layerManager.createLayer("accessibility-patterns",3.5,{alpha:!0}),this.layerManager.createLayer("enhancements",5.5,{alpha:!0}),this.initializeAccessibilityPatterns(),this.startEnhancementAnimationLoop()}renderWaveform(e,t={}){super.renderWaveform(e,t),this.visualEnhancementEngine&&this.renderVisualEnhancements(e,t)}renderVisualEnhancements(e,t={}){const r=this.viewportManager.getViewportBounds(),{width:a,height:i}=this.layerManager.getDimensions();this.generateEnhancedVisualData(e,t),this.frequencyColorData&&this.visualEnhancementEngine.options.enableFrequencyColorCoding&&this.renderFrequencyColorOverlay(r,a,i),this.amplitudeColorData&&this.visualEnhancementEngine.options.enableAmplitudeColorCoding&&this.renderAmplitudeColorOverlay(r,a,i),this.structureData&&this.visualEnhancementEngine.options.enableStructureDetection&&this.renderStructureOverlay(r,a,i),this.accessibilityPatterns&&this.visualEnhancementEngine.options.enableAccessibilityMode&&this.renderAccessibilityPatterns(r,a,i),this.visualEnhancementEngine.options.enableHighContrastMode&&this.applyHighContrastMode()}generateEnhancedVisualData(e,t={}){const{frequencyData:r}=t;r&&(this.frequencyColorData=this.visualEnhancementEngine.applyFrequencyColorCoding(e,r)),this.amplitudeColorData=this.visualEnhancementEngine.applyAmplitudeColorCoding(e),this.structureData=this.visualEnhancementEngine.detectSongStructure(e,t.metadata||{}),r&&(this.accessibilityPatterns=this.visualEnhancementEngine.generateAccessibilityPatterns(r))}renderFrequencyColorOverlay(e,t,r){const a=this.layerManager.getLayer("frequency-overlay");if(!a||!this.frequencyColorData)return;const{ctx:i}=a;this.layerManager.clearLayer("frequency-overlay"),this.frequencyColorData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const a=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),n=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-a;if(n<=0)return;const o=this.createFrequencyGradient(i,a,r,t.color,t.frequencyProfile);i.globalCompositeOperation="multiply",i.fillStyle=o,i.fillRect(a,0,n,r),i.globalCompositeOperation="source-over"}),this.layerManager.markLayerClean("frequency-overlay")}createFrequencyGradient(e,t,r,a,i){const n=e.createLinearGradient(t,0,t,r),{bassEnergy:o,lowMidEnergy:s,midEnergy:l,highMidEnergy:c,trebleEnergy:h}=i,u=o+s+l+c+h;if(0===u)return n.addColorStop(0,`rgba(${a.r}, ${a.g}, ${a.b}, 0.1)`),n.addColorStop(1,`rgba(${a.r}, ${a.g}, ${a.b}, 0.1)`),n;let d=0;const m=o/u;m>.1&&(n.addColorStop(d,`rgba(220, 38, 127, ${m*a.a})`),d+=m);const g=s/u;g>.1&&(n.addColorStop(Math.min(d,1),`rgba(239, 68, 68, ${g*a.a})`),d+=g);const y=l/u;y>.1&&(n.addColorStop(Math.min(d,1),`rgba(245, 158, 11, ${y*a.a})`),d+=y);const p=c/u;p>.1&&(n.addColorStop(Math.min(d,1),`rgba(34, 197, 94, ${p*a.a})`),d+=p);const b=h/u;return b>.1&&n.addColorStop(1,`rgba(59, 130, 246, ${b*a.a})`),n}renderAmplitudeColorOverlay(e,t,r){const a=this.layerManager.getLayer("frequency-overlay");if(!a||!this.amplitudeColorData)return;const{ctx:i}=a;this.amplitudeColorData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const a=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),n=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-a;if(n<=0)return;const{alpha:o,brightness:s}=t.colorModifier;i.globalCompositeOperation="overlay",i.globalAlpha=o;const l=this.getAmplitudeLevelColor(t.level,s);i.fillStyle=l,i.fillRect(a,0,n,r),i.globalAlpha=1,i.globalCompositeOperation="source-over"})}getAmplitudeLevelColor(e,t){const r={silent:{r:64,g:64,b:64},quiet:{r:100,g:149,b:237},moderate:{r:34,g:197,b:94},loud:{r:245,g:158,b:11},peak:{r:239,g:68,b:68}},a=r[e]||r.moderate;return`rgba(${Math.round(a.r*t)}, ${Math.round(a.g*t)}, ${Math.round(a.b*t)}, 0.3)`}renderStructureOverlay(e,t,r){const a=this.layerManager.getLayer("structure-overlay");if(!a||!this.structureData)return;const{ctx:i}=a;this.layerManager.clearLayer("structure-overlay"),this.structureData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const a=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),n=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-a;n<=0||(this.renderStructureSection(i,t,a,n,r),this.visualEnhancementEngine.options.structureDetection?.showLabels&&this.renderStructureLabel(i,t,a,n,r))}),this.layerManager.markLayerClean("structure-overlay")}renderStructureSection(e,t,r,a,i){const{visualPattern:n}=t,{color:o,pattern:s}=n,l=`rgba(${o.r}, ${o.g}, ${o.b}, 0.1)`;switch(s){case"solid":default:e.fillStyle=l,e.fillRect(r,0,a,i);break;case"gradient":const t=e.createLinearGradient(r,0,r+a,0);t.addColorStop(0,l),t.addColorStop(.5,`rgba(${o.r}, ${o.g}, ${o.b}, 0.2)`),t.addColorStop(1,l),e.fillStyle=t,e.fillRect(r,0,a,i);break;case"dashed":e.strokeStyle=`rgba(${o.r}, ${o.g}, ${o.b}, 0.4)`,e.lineWidth=2,e.setLineDash([8,4]),e.strokeRect(r,10,a,i-20),e.setLineDash([]);break;case"dotted":e.fillStyle=`rgba(${o.r}, ${o.g}, ${o.b}, 0.3)`;for(let n=r;n<r+a;n+=12)for(let t=10;t<i-10;t+=12)e.beginPath(),e.arc(n,t,2,0,2*Math.PI),e.fill();break;case"sparse":e.fillStyle=l,e.fillRect(r,.4*i,a,.2*i)}}renderStructureLabel(e,t,r,a,i){if(a<60)return;const n=r+a/2,o=t.type.toUpperCase();e.font="bold 12px monospace",e.textAlign="center",e.textBaseline="middle";const s=e.measureText(o).width;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(n-s/2-6,17,s+12,16);const{color:l}=t.visualPattern;e.strokeStyle=`rgba(${l.r}, ${l.g}, ${l.b}, 0.8)`,e.lineWidth=1,e.strokeRect(n-s/2-6,17,s+12,16),e.fillStyle=`rgba(${l.r}, ${l.g}, ${l.b}, 1)`,e.fillText(o,n,25)}renderAccessibilityPatterns(e,t,r){const a=this.layerManager.getLayer("accessibility-patterns");if(!a||!this.accessibilityPatterns)return;const{ctx:i}=a;this.layerManager.clearLayer("accessibility-patterns"),this.accessibilityPatterns.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const a=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),n=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-a;n<=0||this.renderAccessibilityPattern(i,t,a,n,r)}),this.layerManager.markLayerClean("accessibility-patterns")}renderAccessibilityPattern(e,t,r,a,i){const{pattern:n,density:o,frequencyType:s}=t;e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1;const l={high:4,medium:8,low:16,sparse:32}[o]||8;switch(n){case"vertical-lines":for(let t=r;t<r+a;t+=l)e.beginPath(),e.moveTo(t,0),e.lineTo(t,i),e.stroke();break;case"horizontal-lines":for(let t=0;t<i;t+=l)e.beginPath(),e.moveTo(r,t),e.lineTo(r+a,t),e.stroke();break;case"diagonal-lines":for(let t=-i;t<a+i;t+=l)e.beginPath(),e.moveTo(r+t,0),e.lineTo(r+t+i,i),e.stroke();break;case"dots":e.fillStyle="rgba(255, 255, 255, 0.6)";for(let t=r;t<r+a;t+=l)for(let r=l/2;r<i;r+=l)e.beginPath(),e.arc(t,r,1,0,2*Math.PI),e.fill();break;case"cross-hatch":for(let t=r;t<r+a;t+=l)e.beginPath(),e.moveTo(t,0),e.lineTo(t,i),e.stroke();for(let t=0;t<i;t+=l)e.beginPath(),e.moveTo(r,t),e.lineTo(r+a,t),e.stroke()}}applyHighContrastMode(){["waveform","chops","frequency-overlay","structure-overlay"].forEach(e=>{const t=this.layerManager.getLayer(e);if(t&&t.canvas){const{ctx:e}=t;e.filter="contrast(200%) brightness(150%)",e.filter="none"}})}initializeAccessibilityPatterns(){const e=["high","medium","low","sparse"];["vertical-lines","horizontal-lines","diagonal-lines","dots","cross-hatch"].forEach(t=>{e.forEach(e=>{const r=`${t}-${e}`;this.patternCache.set(r,this.generatePatternData(t,e))})})}generatePatternData(e,t){return{pattern:e,density:t,spacing:{high:4,medium:8,low:16,sparse:32}[t]||8}}startEnhancementAnimationLoop(){const e=t=>{this.animationState.time=t,this.animationState.pulsePhase=t/1e3%(2*Math.PI),this.visualEnhancementEngine.options.enhancements?.animatedElements&&this.updateAnimatedElements(),requestAnimationFrame(e)};requestAnimationFrame(e)}updateAnimatedElements(){this.animationState.pulsePhase%(Math.PI/4)<.1&&this.layerManager.markLayerDirty("enhancements")}updateVisualSettings(e){this.visualEnhancementEngine&&this.visualEnhancementEngine.updateVisualSettings(e,()=>{this.frequencyColorData=null,this.amplitudeColorData=null,this.structureData=null,this.accessibilityPatterns=null,this.layerManager.markLayerDirty("frequency-overlay"),this.layerManager.markLayerDirty("structure-overlay"),this.layerManager.markLayerDirty("accessibility-patterns")})}getVisualEnhancementEngine(){return this.visualEnhancementEngine}destroy(){super.destroy(),this.visualEnhancementEngine&&this.visualEnhancementEngine.destroy(),this.patternCache.clear()}}class s{constructor(e={}){this.options={enableWebWorkers:!1!==e.enableWebWorkers,enableCaching:!1!==e.enableCaching,enableMemoryManagement:!1!==e.enableMemoryManagement,enablePerformanceMonitoring:!1!==e.enablePerformanceMonitoring,workerPoolSize:e.workerPoolSize||2,...e},this.cache=null,this.memoryManager=null,this.performanceMonitor=null,this.workerPool=[],this.workerQueue=[],this.isInitialized=!1,this.activeWorkerTasks=new Map,this.taskIdCounter=0,this.metrics={workerTasks:{completed:0,failed:0,averageTime:0,queueLength:0},cachePerformance:{hits:0,misses:0,hitRate:0},memoryOptimization:{cleanupCount:0,memoryReclaimed:0,currentUsage:0},overallPerformance:{score:1,qualityLevel:"high",degradationLevel:0}},this.initialize()}async initialize(){if(!this.isInitialized)try{this.options.enableCaching&&(this.cache=new t({maxMemorySize:this.options.cacheMaxMemory||104857600,maxCacheEntries:this.options.cacheMaxEntries||50,persistenceEnabled:!1!==this.options.cachePersistence,compressionEnabled:!1!==this.options.cacheCompression}),await this.cache.initializePersistence()),this.options.enableMemoryManagement&&(this.memoryManager=new r({maxMemoryThreshold:this.options.memoryMaxThreshold||157286400,warningThreshold:this.options.memoryWarningThreshold||104857600,cleanupInterval:this.options.memoryCleanupInterval||3e4})),this.options.enablePerformanceMonitoring&&(this.performanceMonitor=new a({targetFPS:this.options.targetFPS||60,minFPS:this.options.minFPS||30,degradationThreshold:this.options.degradationThreshold||.7,recoveryThreshold:this.options.recoveryThreshold||.9}),this.setupPerformanceCallbacks(),this.performanceMonitor.startMonitoring()),this.options.enableWebWorkers&&await this.initializeWorkerPool(),this.isInitialized=!0}catch(e){throw e}}async initializeWorkerPool(){try{let t;try{t=new URL("/assets/WaveformWorker-Cx3X8jrY.js",import.meta.url)}catch(e){t="../workers/WaveformWorker.js"}for(let r=0;r<this.options.workerPoolSize;r++)try{const e=new Worker(t,{type:"module"});e.onmessage=t=>{this.handleWorkerMessage(e,t)},e.onerror=t=>{this.handleWorkerError(e,t)},this.workerPool.push({worker:e,id:r,busy:!1,currentTask:null})}catch(e){}}catch(e){}}setupPerformanceCallbacks(){this.performanceMonitor&&(this.performanceMonitor.onQualityChange(e=>{this.handleQualityChange(e)}),this.performanceMonitor.onPerformanceWarning(e=>{this.handlePerformanceWarning(e)}))}async generateOptimizedWaveform(e,t={}){const r=performance.now();try{this.performanceMonitor&&this.performanceMonitor.frameRenderStart();let a=null;if(this.cache){const r=this.cache.generateCacheKey(e,t);if(a=await this.cache.get(r),a)return this.updateCacheMetrics(!0),a;this.updateCacheMetrics(!1)}const i=this.getAdaptiveSettings(),n={...t,...i,quality:i.renderQuality||t.quality||"medium"};if(a=this.options.enableWebWorkers&&this.workerPool.length>0?await this.generateWaveformWithWorker(e,n):await this.generateWaveformDirect(e,n),this.cache&&a){const i=this.cache.generateCacheKey(e,t);await this.cache.set(i,a,{generationTime:performance.now()-r,quality:n.quality,method:this.options.enableWebWorkers?"worker":"direct"})}return this.performanceMonitor&&this.performanceMonitor.frameRenderEnd(),a}catch(a){if("low"!==t.quality)return this.generateOptimizedWaveform(e,{...t,quality:"low",fallback:!0});throw a}}async generateWaveformWithWorker(e,t){return new Promise((r,a)=>{const i={id:this.generateTaskId(),type:"ANALYZE_WAVEFORM",data:{audioBuffer:e.buffer||e,options:t},resolve:r,reject:a,startTime:performance.now()},n=this.getAvailableWorker();n?this.assignTaskToWorker(i,n):(this.workerQueue.push(i),this.updateWorkerMetrics())})}async generateWaveformDirect(e,t){const r=e.buffer||e;if(!r||!r.length)throw new Error("Invalid audio buffer");const a=t.targetSampleRate||1e3,i=t.quality||"medium";let n=null,o=null;if(this.memoryManager){const e=this.memoryManager.allocateBuffer(Math.floor(r.length*a/44100),"waveform",{source:"direct-generation",quality:i});n=e.bufferId,o=e.buffer}else o=new Float32Array(Math.floor(r.length*a/44100));try{const e=r.length/o.length;for(let t=0;t<o.length;t++){const a=Math.floor(t*e);if("high"===i){let i=0;const n=Math.max(1,Math.floor(e));for(let e=0;e<n&&a+e<r.length;e++){const t=r[a+e]||0;i+=t*t}o[t]=Math.sqrt(i/n)}else o[t]=Math.abs(r[a]||0)}return{samples:o,sampleRate:a,duration:o.length/a,channels:1,metadata:{analysisMethod:"direct-optimized",quality:i,generatedAt:Date.now(),bufferId:n}}}catch(s){throw n&&this.memoryManager&&this.memoryManager.deallocateBuffer(n,{poolForReuse:!1}),s}}getAvailableWorker(){return this.workerPool.find(e=>!e.busy)}assignTaskToWorker(e,t){t.busy=!0,t.currentTask=e,this.activeWorkerTasks.set(e.id,{task:e,workerInfo:t}),t.worker.postMessage({type:e.type,taskId:e.id,data:e.data})}handleWorkerMessage(e,t){const{type:r,taskId:a,data:i,error:n}=t.data,o=this.activeWorkerTasks.get(a);if(!o)return;const{task:s,workerInfo:l}=o;switch(r){case"RESULT":this.handleWorkerResult(s,i),this.completeWorkerTask(a,l);break;case"ERROR":this.handleWorkerError(s,n),this.completeWorkerTask(a,l);break;case"PROGRESS":this.handleWorkerProgress(s,i);break;case"PERFORMANCE_METRICS":this.handleWorkerPerformanceMetrics(i)}}handleWorkerResult(e,t){const r=performance.now()-e.startTime;this.updateWorkerTaskMetrics(r,!0),e.resolve(t)}handleWorkerError(e,t){const r=performance.now()-e.startTime;this.updateWorkerTaskMetrics(r,!1),e.reject(new Error(t||"Worker task failed"))}handleWorkerProgress(e,t){}handleWorkerPerformanceMetrics(e){this.metrics.workerTasks={...this.metrics.workerTasks,...e}}completeWorkerTask(e,t){if(t.busy=!1,t.currentTask=null,this.activeWorkerTasks.delete(e),this.workerQueue.length>0){const e=this.workerQueue.shift();this.assignTaskToWorker(e,t)}this.updateWorkerMetrics()}handleQualityChange(e){this.metrics.overallPerformance.qualityLevel=e.newQuality,this.metrics.overallPerformance.degradationLevel=e.details.level||0,"low"===e.newQuality&&this.cache&&this.cache.optimizeMemoryUsage()}handlePerformanceWarning(e){"critical"===e.type&&this.triggerEmergencyOptimizations()}triggerEmergencyOptimizations(){if(this.memoryManager&&this.memoryManager.emergencyCleanup(),this.cache&&this.cache.clear(),this.workerPool.length>1){this.workerPool.splice(1).forEach(e=>{e.worker.terminate()})}}getAdaptiveSettings(){return this.performanceMonitor?this.performanceMonitor.getAdaptiveSettings():{renderQuality:"medium",waveformResolution:1,enableAntialiasing:!0,maxBatchSize:1e3}}updateCacheMetrics(e){e?this.metrics.cachePerformance.hits++:this.metrics.cachePerformance.misses++;const t=this.metrics.cachePerformance.hits+this.metrics.cachePerformance.misses;this.metrics.cachePerformance.hitRate=this.metrics.cachePerformance.hits/t}updateWorkerTaskMetrics(e,t){if(t){this.metrics.workerTasks.completed++;const t=this.metrics.workerTasks.averageTime,r=this.metrics.workerTasks.completed;this.metrics.workerTasks.averageTime=(t*(r-1)+e)/r}else this.metrics.workerTasks.failed++}updateWorkerMetrics(){this.metrics.workerTasks.queueLength=this.workerQueue.length}generateTaskId(){return`task_${++this.taskIdCounter}_${Date.now()}`}getPerformanceMetrics(){const e={...this.metrics};return this.cache&&(e.cache=this.cache.getStats()),this.memoryManager&&(e.memory=this.memoryManager.getMemoryStats()),this.performanceMonitor&&(e.performance=this.performanceMonitor.getMetrics(),e.overallPerformance.score=e.performance.performanceScore),e}setQualityLevel(e){this.performanceMonitor&&this.performanceMonitor.forceQualityLevel(e)}async clearCaches(){this.cache&&await this.cache.clear(),this.memoryManager&&this.memoryManager.emergencyCleanup()}optimizeForLowEndDevice(){if(this.setQualityLevel("low"),this.workerPool.length>1){this.workerPool.splice(1).forEach(e=>{e.worker.terminate()})}this.cache&&(this.cache.maxMemorySize=52428800,this.cache.maxCacheEntries=25),this.memoryManager&&(this.memoryManager.maxMemoryThreshold=104857600,this.memoryManager.warningThreshold=78643200)}destroy(){this.performanceMonitor&&(this.performanceMonitor.destroy(),this.performanceMonitor=null),this.memoryManager&&(this.memoryManager.destroy(),this.memoryManager=null),this.cache&&(this.cache.destroy(),this.cache=null),this.workerPool.forEach(e=>{e.worker.terminate()}),this.workerPool=[],this.activeWorkerTasks.clear(),this.workerQueue=[],this.isInitialized=!1}}export{o as E,n as V,s as W};
