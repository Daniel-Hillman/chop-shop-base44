import{r as e,j as t,m as r}from"./index-CbF_sqjB.js";import{CanvasRenderer as i}from"./CanvasRenderer-B1XfccUk.js";import{VisualEnhancementEngine as a}from"./VisualEnhancementEngine-Bv-cAWMG.js";import{InteractionManager as s}from"./InteractionManager-Bm6YdUAt.js";class n extends i{constructor(e,t={}){super(e,t),this.visualEnhancementEngine=new a({enableFrequencyColorCoding:!1!==t.enableFrequencyColorCoding,enableAmplitudeColorCoding:!1!==t.enableAmplitudeColorCoding,enableStructureDetection:!1!==t.enableStructureDetection,enableAccessibilityMode:t.enableAccessibilityMode||!1,enableHighContrastMode:t.enableHighContrastMode||!1,colorScheme:t.colorScheme||"default"}),this.frequencyColorData=null,this.amplitudeColorData=null,this.structureData=null,this.accessibilityPatterns=null,this.patternCache=new Map,this.animationState={time:0,pulsePhase:0,particleSystem:null},this.initializeEnhancedFeatures()}initializeEnhancedFeatures(){this.layerManager.createLayer("frequency-overlay",1.5,{alpha:!0}),this.layerManager.createLayer("structure-overlay",2.5,{alpha:!0}),this.layerManager.createLayer("accessibility-patterns",3.5,{alpha:!0}),this.layerManager.createLayer("enhancements",5.5,{alpha:!0}),this.initializeAccessibilityPatterns(),this.startEnhancementAnimationLoop()}renderWaveform(e,t={}){super.renderWaveform(e,t),this.visualEnhancementEngine&&this.renderVisualEnhancements(e,t)}renderVisualEnhancements(e,t={}){const r=this.viewportManager.getViewportBounds(),{width:i,height:a}=this.layerManager.getDimensions();this.generateEnhancedVisualData(e,t),this.frequencyColorData&&this.visualEnhancementEngine.options.enableFrequencyColorCoding&&this.renderFrequencyColorOverlay(r,i,a),this.amplitudeColorData&&this.visualEnhancementEngine.options.enableAmplitudeColorCoding&&this.renderAmplitudeColorOverlay(r,i,a),this.structureData&&this.visualEnhancementEngine.options.enableStructureDetection&&this.renderStructureOverlay(r,i,a),this.accessibilityPatterns&&this.visualEnhancementEngine.options.enableAccessibilityMode&&this.renderAccessibilityPatterns(r,i,a),this.visualEnhancementEngine.options.enableHighContrastMode&&this.applyHighContrastMode()}generateEnhancedVisualData(e,t={}){const{frequencyData:r}=t;r&&(this.frequencyColorData=this.visualEnhancementEngine.applyFrequencyColorCoding(e,r)),this.amplitudeColorData=this.visualEnhancementEngine.applyAmplitudeColorCoding(e),this.structureData=this.visualEnhancementEngine.detectSongStructure(e,t.metadata||{}),r&&(this.accessibilityPatterns=this.visualEnhancementEngine.generateAccessibilityPatterns(r))}renderFrequencyColorOverlay(e,t,r){const i=this.layerManager.getLayer("frequency-overlay");if(!i||!this.frequencyColorData)return;const{ctx:a}=i;this.layerManager.clearLayer("frequency-overlay"),this.frequencyColorData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const i=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),s=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-i;if(s<=0)return;const n=this.createFrequencyGradient(a,i,r,t.color,t.frequencyProfile);a.globalCompositeOperation="multiply",a.fillStyle=n,a.fillRect(i,0,s,r),a.globalCompositeOperation="source-over"}),this.layerManager.markLayerClean("frequency-overlay")}createFrequencyGradient(e,t,r,i,a){const s=e.createLinearGradient(t,0,t,r),{bassEnergy:n,lowMidEnergy:o,midEnergy:c,highMidEnergy:l,trebleEnergy:h}=a,m=n+o+c+l+h;if(0===m)return s.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 0.1)`),s.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.1)`),s;let u=0;const d=n/m;d>.1&&(s.addColorStop(u,`rgba(220, 38, 127, ${d*i.a})`),u+=d);const p=o/m;p>.1&&(s.addColorStop(Math.min(u,1),`rgba(239, 68, 68, ${p*i.a})`),u+=p);const g=c/m;g>.1&&(s.addColorStop(Math.min(u,1),`rgba(245, 158, 11, ${g*i.a})`),u+=g);const f=l/m;f>.1&&(s.addColorStop(Math.min(u,1),`rgba(34, 197, 94, ${f*i.a})`),u+=f);const y=h/m;return y>.1&&s.addColorStop(1,`rgba(59, 130, 246, ${y*i.a})`),s}renderAmplitudeColorOverlay(e,t,r){const i=this.layerManager.getLayer("frequency-overlay");if(!i||!this.amplitudeColorData)return;const{ctx:a}=i;this.amplitudeColorData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const i=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),s=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-i;if(s<=0)return;const{alpha:n,brightness:o}=t.colorModifier;a.globalCompositeOperation="overlay",a.globalAlpha=n;const c=this.getAmplitudeLevelColor(t.level,o);a.fillStyle=c,a.fillRect(i,0,s,r),a.globalAlpha=1,a.globalCompositeOperation="source-over"})}getAmplitudeLevelColor(e,t){const r={silent:{r:64,g:64,b:64},quiet:{r:100,g:149,b:237},moderate:{r:34,g:197,b:94},loud:{r:245,g:158,b:11},peak:{r:239,g:68,b:68}},i=r[e]||r.moderate;return`rgba(${Math.round(i.r*t)}, ${Math.round(i.g*t)}, ${Math.round(i.b*t)}, 0.3)`}renderStructureOverlay(e,t,r){const i=this.layerManager.getLayer("structure-overlay");if(!i||!this.structureData)return;const{ctx:a}=i;this.layerManager.clearLayer("structure-overlay"),this.structureData.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const i=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),s=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-i;s<=0||(this.renderStructureSection(a,t,i,s,r),this.visualEnhancementEngine.options.structureDetection?.showLabels&&this.renderStructureLabel(a,t,i,s,r))}),this.layerManager.markLayerClean("structure-overlay")}renderStructureSection(e,t,r,i,a){const{visualPattern:s}=t,{color:n,pattern:o}=s,c=`rgba(${n.r}, ${n.g}, ${n.b}, 0.1)`;switch(o){case"solid":default:e.fillStyle=c,e.fillRect(r,0,i,a);break;case"gradient":const t=e.createLinearGradient(r,0,r+i,0);t.addColorStop(0,c),t.addColorStop(.5,`rgba(${n.r}, ${n.g}, ${n.b}, 0.2)`),t.addColorStop(1,c),e.fillStyle=t,e.fillRect(r,0,i,a);break;case"dashed":e.strokeStyle=`rgba(${n.r}, ${n.g}, ${n.b}, 0.4)`,e.lineWidth=2,e.setLineDash([8,4]),e.strokeRect(r,10,i,a-20),e.setLineDash([]);break;case"dotted":e.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, 0.3)`;for(let s=r;s<r+i;s+=12)for(let t=10;t<a-10;t+=12)e.beginPath(),e.arc(s,t,2,0,2*Math.PI),e.fill();break;case"sparse":e.fillStyle=c,e.fillRect(r,.4*a,i,.2*a)}}renderStructureLabel(e,t,r,i,a){if(i<60)return;const s=r+i/2,n=t.type.toUpperCase();e.font="bold 12px monospace",e.textAlign="center",e.textBaseline="middle";const o=e.measureText(n).width;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(s-o/2-6,17,o+12,16);const{color:c}=t.visualPattern;e.strokeStyle=`rgba(${c.r}, ${c.g}, ${c.b}, 0.8)`,e.lineWidth=1,e.strokeRect(s-o/2-6,17,o+12,16),e.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, 1)`,e.fillText(n,s,25)}renderAccessibilityPatterns(e,t,r){const i=this.layerManager.getLayer("accessibility-patterns");if(!i||!this.accessibilityPatterns)return;const{ctx:a}=i;this.layerManager.clearLayer("accessibility-patterns"),this.accessibilityPatterns.forEach(t=>{if(t.endTime<e.start||t.startTime>e.end)return;const i=this.viewportManager.timeToPixel(Math.max(t.startTime,e.start)),s=this.viewportManager.timeToPixel(Math.min(t.endTime,e.end))-i;s<=0||this.renderAccessibilityPattern(a,t,i,s,r)}),this.layerManager.markLayerClean("accessibility-patterns")}renderAccessibilityPattern(e,t,r,i,a){const{pattern:s,density:n,frequencyType:o}=t;e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=1;const c={high:4,medium:8,low:16,sparse:32}[n]||8;switch(s){case"vertical-lines":for(let t=r;t<r+i;t+=c)e.beginPath(),e.moveTo(t,0),e.lineTo(t,a),e.stroke();break;case"horizontal-lines":for(let t=0;t<a;t+=c)e.beginPath(),e.moveTo(r,t),e.lineTo(r+i,t),e.stroke();break;case"diagonal-lines":for(let t=-a;t<i+a;t+=c)e.beginPath(),e.moveTo(r+t,0),e.lineTo(r+t+a,a),e.stroke();break;case"dots":e.fillStyle="rgba(255, 255, 255, 0.6)";for(let t=r;t<r+i;t+=c)for(let r=c/2;r<a;r+=c)e.beginPath(),e.arc(t,r,1,0,2*Math.PI),e.fill();break;case"cross-hatch":for(let t=r;t<r+i;t+=c)e.beginPath(),e.moveTo(t,0),e.lineTo(t,a),e.stroke();for(let t=0;t<a;t+=c)e.beginPath(),e.moveTo(r,t),e.lineTo(r+i,t),e.stroke()}}applyHighContrastMode(){["waveform","chops","frequency-overlay","structure-overlay"].forEach(e=>{const t=this.layerManager.getLayer(e);if(t&&t.canvas){const{ctx:e}=t;e.filter="contrast(200%) brightness(150%)",e.filter="none"}})}initializeAccessibilityPatterns(){const e=["high","medium","low","sparse"];["vertical-lines","horizontal-lines","diagonal-lines","dots","cross-hatch"].forEach(t=>{e.forEach(e=>{const r=`${t}-${e}`;this.patternCache.set(r,this.generatePatternData(t,e))})})}generatePatternData(e,t){return{pattern:e,density:t,spacing:{high:4,medium:8,low:16,sparse:32}[t]||8}}startEnhancementAnimationLoop(){const e=t=>{this.animationState.time=t,this.animationState.pulsePhase=t/1e3%(2*Math.PI),this.visualEnhancementEngine.options.enhancements?.animatedElements&&this.updateAnimatedElements(),requestAnimationFrame(e)};requestAnimationFrame(e)}updateAnimatedElements(){this.animationState.pulsePhase%(Math.PI/4)<.1&&this.layerManager.markLayerDirty("enhancements")}updateVisualSettings(e){this.visualEnhancementEngine&&this.visualEnhancementEngine.updateVisualSettings(e,()=>{this.frequencyColorData=null,this.amplitudeColorData=null,this.structureData=null,this.accessibilityPatterns=null,this.layerManager.markLayerDirty("frequency-overlay"),this.layerManager.markLayerDirty("structure-overlay"),this.layerManager.markLayerDirty("accessibility-patterns")})}getVisualEnhancementEngine(){return this.visualEnhancementEngine}destroy(){super.destroy(),this.visualEnhancementEngine&&this.visualEnhancementEngine.destroy(),this.patternCache.clear()}}class o{constructor(e,t={}){this.renderer=e,this.options={smoothingFactor:.15,maxInterpolationTime:100,playheadColor:"#ef4444",playheadWidth:2,activeChopColor:"#fbbf24",activeChopOpacity:.3,showTimeDisplay:!0,animationQuality:"high",...t},this.currentTime=0,this.targetTime=0,this.isPlaying=!1,this.lastUpdateTime=0,this.interpolatedTime=0,this.animationFrameId=null,this.isAnimating=!1,this.activeChops=new Set,this.allChops=[],this.chopHighlights=new Map,this.frameCount=0,this.lastFPSCheck=0,this.currentFPS=0,this.syncHistory=[],this.maxSyncHistory=10,this.syncAccuracy=0,this.initialize()}initialize(){return this.isPlaying&&this.startAnimation(),this}updatePlaybackState(e,t){("number"!=typeof e||isNaN(e))&&(e=0);const r=performance.now(),i=r-this.lastUpdateTime;if(this.trackSyncAccuracy(e,i),this.targetTime=e,this.lastUpdateTime=r,this.currentTime=e,t!==this.isPlaying)if(this.isPlaying=t,t){this.interpolatedTime=e;try{this.startAnimation()}catch(a){}}else this.stopAnimation(),this.interpolatedTime=e;else t||(this.interpolatedTime=e);this.updateActiveChops(),this.isAnimating||this.render()}trackSyncAccuracy(e,t){if(this.syncHistory.length>0){const r=this.syncHistory[this.syncHistory.length-1].time+t/1e3,i=e,a=Math.abs(i-r);this.syncHistory.push({time:e,timestamp:performance.now(),drift:a,timeDelta:t})}else this.syncHistory.push({time:e,timestamp:performance.now(),drift:0,timeDelta:0});if(this.syncHistory.length>this.maxSyncHistory&&this.syncHistory.shift(),this.syncHistory.length>1){const e=this.syncHistory.reduce((e,t)=>e+t.drift,0);this.syncAccuracy=e/this.syncHistory.length}}startAnimation(){if(this.isAnimating)return;this.isAnimating=!0,this.interpolatedTime=this.currentTime;const e=t=>{if(this.isAnimating)try{this.updateInterpolation(t),this.render(),this.updatePerformanceMetrics(t),this.animationFrameId=requestAnimationFrame(e)}catch(r){try{this.animationFrameId=requestAnimationFrame(e)}catch(i){this.isAnimating=!1}}};try{this.animationFrameId=requestAnimationFrame(e)}catch(t){throw this.isAnimating=!1,t}}stopAnimation(){this.isAnimating=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}updateInterpolation(e){if(!this.isPlaying)return;const t=performance.now(),r=t-this.lastUpdateTime;if(r>this.options.maxInterpolationTime)return this.interpolatedTime=this.targetTime,this.currentTime=this.targetTime,this.lastUpdateTime=t,void this.updateActiveChops();const i=this.targetTime+r/1e3,a=this.options.smoothingFactor;0===this.interpolatedTime?this.interpolatedTime=this.targetTime:this.interpolatedTime+=(i-this.interpolatedTime)*a,this.currentTime=this.interpolatedTime,this.updateActiveChops()}updateActiveChops(){const e=this.interpolatedTime||this.currentTime,t=new Set;this.allChops.forEach(r=>{if(e>=r.startTime&&e<=r.endTime){const e=r.id||r.padId;t.add(e),this.activeChops.has(e)||this.chopHighlights.set(e,{startTime:performance.now(),intensity:1,chop:r,fadeOut:!1})}}),this.activeChops.forEach(e=>{if(!t.has(e)){const t=this.chopHighlights.get(e);t&&(t.fadeOut=!0,t.fadeStartTime=performance.now())}}),this.activeChops=t,this.cleanupHighlights()}cleanupHighlights(){const e=performance.now();for(const[t,r]of this.chopHighlights.entries())if(r.fadeOut){const i=(e-r.fadeStartTime)/300;i>=1?this.chopHighlights.delete(t):r.intensity=1-i}}setChops(e){this.allChops=e||[],this.updateActiveChops()}render(){if(!this.renderer)return;const e=this.renderer.getViewportManager();e&&(e.isTimeVisible(this.currentTime)?(this.renderActiveChopHighlights(),this.renderPlayhead()):this.renderer.getLayerManager().clearLayer("playhead"))}renderActiveChopHighlights(){const e=this.renderer.getLayerManager().getLayer("chops");if(!e)return;const{ctx:t}=e,{width:r,height:i}=this.renderer.getLayerManager().getDimensions(),a=this.renderer.getViewportManager();this.chopHighlights.forEach((e,s)=>{const n=e.chop;if(!n)return;if(!a.isRangeVisible(n.startTime,n.endTime))return;const o=a.timeToPixel(n.startTime),c=a.timeToPixel(n.endTime)-o;if(c<=0)return;let l=e.intensity;if(!e.fadeOut&&this.isPlaying){const t=2,r=(performance.now()-e.startTime)/1e3;l*=.7+.3*Math.sin(r*t*Math.PI*2)}t.save(),t.globalAlpha=this.options.activeChopOpacity*l,t.fillStyle=this.options.activeChopColor,t.fillRect(Math.max(0,o),0,Math.min(c,r-Math.max(0,o)),i),t.restore(),t.save(),t.globalAlpha=l,t.strokeStyle=this.options.activeChopColor,t.lineWidth=3,t.setLineDash([5,5]),t.strokeRect(Math.max(0,o),0,Math.min(c,r-Math.max(0,o)),i),t.restore()})}renderPlayhead(){const e=this.renderer.getLayerManager().getLayer("playhead");if(!e)return;const{ctx:t}=e,{width:r,height:i}=this.renderer.getLayerManager().getDimensions(),a=this.renderer.getViewportManager();this.renderer.getLayerManager().clearLayer("playhead");const s=a.timeToPixel(this.currentTime);t.save(),t.strokeStyle=this.options.playheadColor,t.lineWidth=this.options.playheadWidth,t.lineCap="round",this.isPlaying&&(t.shadowColor=this.options.playheadColor,t.shadowBlur=8,t.shadowOffsetX=0,t.shadowOffsetY=0),t.beginPath(),t.moveTo(s,0),t.lineTo(s,i),t.stroke(),t.restore(),this.renderPlayheadIndicator(t,s,r,i),this.options.showTimeDisplay&&this.renderTimeDisplay(t,s,r,i)}renderPlayheadIndicator(e,t,r,i){e.save(),e.fillStyle=this.options.playheadColor,this.isPlaying&&(e.shadowColor=this.options.playheadColor,e.shadowBlur=6),e.beginPath(),e.moveTo(t-8,0),e.lineTo(t+8,0),e.lineTo(t,12),e.closePath(),e.fill(),i>40&&(e.beginPath(),e.moveTo(t-8,i),e.lineTo(t+8,i),e.lineTo(t,i-12),e.closePath(),e.fill()),e.restore()}renderTimeDisplay(e,t,r,i){if(this.renderer.getViewportManager().getViewportBounds().pixelsPerSecond<50)return;const a=this.formatTime(this.currentTime);e.save(),e.font="bold 12px monospace",e.textAlign="center",e.textBaseline="middle";let s=t;const n=i-20,o=e.measureText(a).width;s-o/2<5?(s=o/2+5,e.textAlign="left"):s+o/2>r-5&&(s=r-5,e.textAlign="right"),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(s-o/2-4,n-8,o+8,16),e.fillStyle="#ffffff",e.fillText(a,s,n),e.restore()}formatTime(e){const t=Math.floor(e/60),r=e%60;return t>0?`${t}:${r.toFixed(2).padStart(5,"0")}`:`${r.toFixed(2)}s`}updatePerformanceMetrics(e){this.frameCount++,0===this.lastFPSCheck&&(this.lastFPSCheck=e),e-this.lastFPSCheck>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCheck=e)}getPerformanceMetrics(){return{fps:this.currentFPS,syncAccuracy:this.syncAccuracy,activeChops:this.activeChops.size,isAnimating:this.isAnimating,interpolatedTime:this.interpolatedTime,targetTime:this.targetTime}}getSyncStatus(){return{isPlaying:this.isPlaying,currentTime:this.currentTime,targetTime:this.targetTime,syncAccuracy:this.syncAccuracy,activeChops:Array.from(this.activeChops),isAnimating:this.isAnimating}}setOptions(e){this.options={...this.options,...e}}jumpToTime(e){this.currentTime=e,this.targetTime=e,this.interpolatedTime=e,this.lastUpdateTime=performance.now(),this.updateActiveChops(),this.render()}destroy(){this.stopAnimation(),this.activeChops.clear(),this.chopHighlights.clear(),this.allChops=[],this.syncHistory=[]}}class c{constructor(e={}){this.maxMemorySize=e.maxMemorySize||104857600,this.maxCacheEntries=e.maxCacheEntries||50,this.persistenceEnabled=!1!==e.persistenceEnabled,this.compressionEnabled=!1!==e.compressionEnabled,this.ttl=e.ttl||864e5,this.memoryCache=new Map,this.accessOrder=new Map,this.memorySizeUsed=0,this.persistentCache=null,this.initializePersistence(),this.metrics={hits:0,misses:0,evictions:0,compressionSavings:0,averageCompressionRatio:0,persistenceHits:0,persistenceMisses:0},this.cleanupInterval=setInterval(()=>{this.performMaintenance()},3e5)}async initializePersistence(){if(this.persistenceEnabled&&"undefined"!=typeof indexedDB)try{this.persistentCache=await this.openIndexedDB()}catch(e){this.persistenceEnabled=!1}}openIndexedDB(){return new Promise((e,t)=>{const r=indexedDB.open("WaveformCache",1);r.onerror=()=>t(r.error),r.onsuccess=()=>{const t=r.result;e(t)},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("waveforms")){const e=t.createObjectStore("waveforms",{keyPath:"key"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("size","size",{unique:!1})}}})}generateCacheKey(e,t={}){const r={source:this.getSourceIdentifier(e),sampleRate:t.sampleRate||1e3,quality:t.quality||"medium",analysisMethod:t.analysisMethod||"auto",duration:t.duration||0};return this.hashObject(r)}async get(e){const t=this.getFromMemory(e);if(t)return this.metrics.hits++,t;if(this.persistenceEnabled&&this.persistentCache){const t=await this.getFromPersistent(e);if(t)return this.metrics.persistenceHits++,this.metrics.hits++,this.setInMemory(e,t),t;this.metrics.persistenceMisses++}return this.metrics.misses++,null}async set(e,t,r={}){const i={key:e,data:t,metadata:{...r,timestamp:Date.now(),accessCount:1,size:this.calculateDataSize(t)}};if(this.compressionEnabled){const e=await this.compressData(i);if(e.size<i.metadata.size){const t=i.metadata.size-e.size;this.metrics.compressionSavings+=t,this.updateCompressionRatio(i.metadata.size,e.size),i.compressed=!0,i.data=e.data,i.metadata.size=e.size}}this.setInMemory(e,i),this.persistenceEnabled&&this.persistentCache&&await this.setInPersistent(e,i)}getFromMemory(e){const t=this.memoryCache.get(e);if(!t)return null;if(Date.now()-t.metadata.timestamp>this.ttl)return this.memoryCache.delete(e),this.accessOrder.delete(e),this.memorySizeUsed-=t.metadata.size,null;if(this.accessOrder.set(e,Date.now()),t.metadata.accessCount++,t.compressed){const e=this.decompressData(t);return{...t,data:e,compressed:!1}}return t}setInMemory(e,t){for(;this.memorySizeUsed+t.metadata.size>this.maxMemorySize||this.memoryCache.size>=this.maxCacheEntries;)this.evictLRU();if(this.memoryCache.has(e)){const t=this.memoryCache.get(e);this.memorySizeUsed-=t.metadata.size}this.memoryCache.set(e,t),this.accessOrder.set(e,Date.now()),this.memorySizeUsed+=t.metadata.size}async getFromPersistent(e){if(!this.persistentCache)return null;try{const t=this.persistentCache.transaction(["waveforms"],"readonly"),r=t.objectStore("waveforms").get(e);return new Promise((t,i)=>{r.onsuccess=()=>{const i=r.result;if(i){if(Date.now()-i.timestamp>this.ttl)return this.deleteFromPersistent(e),void t(null);if(i.compressed){const e=this.decompressData(i);t({...i,data:e,compressed:!1})}else t(i)}else t(null)},r.onerror=()=>i(r.error)})}catch(t){return null}}async setInPersistent(e,t){if(this.persistentCache)try{const r=this.persistentCache.transaction(["waveforms"],"readwrite"),i=r.objectStore("waveforms"),a={key:e,data:t.data,metadata:t.metadata,compressed:t.compressed||!1,timestamp:t.metadata.timestamp,size:t.metadata.size};return i.put(a),new Promise((e,t)=>{r.oncomplete=()=>e(),r.onerror=()=>t(r.error)})}catch(r){}}async deleteFromPersistent(e){if(this.persistentCache)try{const t=this.persistentCache.transaction(["waveforms"],"readwrite");t.objectStore("waveforms").delete(e)}catch(t){}}evictLRU(){if(0===this.accessOrder.size)return;let e=null,t=Date.now();for(const[r,i]of this.accessOrder)i<t&&(t=i,e=r);if(e){const t=this.memoryCache.get(e);t&&(this.memorySizeUsed-=t.metadata.size),this.memoryCache.delete(e),this.accessOrder.delete(e),this.metrics.evictions++}}async compressData(e){try{const t=JSON.stringify(e.data);if("undefined"!=typeof CompressionStream){const e=new CompressionStream("gzip"),r=e.writable.getWriter(),i=e.readable.getReader();r.write((new TextEncoder).encode(t)),r.close();const a=[];let s=!1;for(;!s;){const{value:e,done:t}=await i.read();s=t,e&&a.push(e)}const n=new Uint8Array(a.reduce((e,t)=>e+t.length,0));let o=0;for(const t of a)n.set(t,o),o+=t.length;return{data:n,size:n.length,originalSize:t.length}}{const e=this.simpleCompress(t);return{data:e,size:e.length,originalSize:t.length}}}catch(t){return{data:e.data,size:e.metadata.size,originalSize:e.metadata.size}}}decompressData(e){try{return e.data instanceof Uint8Array?this.simpleDecompress((new TextDecoder).decode(e.data)):"string"==typeof e.data?this.simpleDecompress(e.data):e.data}catch(t){return e.data}}simpleCompress(e){let t="",r=1,i=e[0];for(let a=1;a<e.length;a++)e[a]===i&&r<255?r++:(t+=String.fromCharCode(r)+i,i=e[a],r=1);return t+=String.fromCharCode(r)+i,t}simpleDecompress(e){try{return JSON.parse(e)}catch{let t="";for(let r=0;r<e.length;r+=2){const i=e.charCodeAt(r);t+=e[r+1].repeat(i)}return JSON.parse(t)}}calculateDataSize(e){return e instanceof ArrayBuffer?e.byteLength:e instanceof Float32Array||e instanceof Uint8Array?e.length*e.BYTES_PER_ELEMENT:"string"==typeof e?2*e.length:2*JSON.stringify(e).length}getSourceIdentifier(e){return"string"==typeof e?e:e&&e.videoId?`youtube:${e.videoId}`:e&&e.src?e.src:"unknown"}hashObject(e){const t=JSON.stringify(e,Object.keys(e).sort());let r=0;for(let i=0;i<t.length;i++){r=(r<<5)-r+t.charCodeAt(i),r&=r}return`waveform_${Math.abs(r).toString(36)}`}updateCompressionRatio(e,t){const r=t/e,i=this.metrics.hits+this.metrics.misses;this.metrics.averageCompressionRatio=(this.metrics.averageCompressionRatio*(i-1)+r)/i}async performMaintenance(){const e=Date.now(),t=[];for(const[r,i]of this.memoryCache)e-i.metadata.timestamp>this.ttl&&t.push(r);for(const r of t){const e=this.memoryCache.get(r);e&&(this.memorySizeUsed-=e.metadata.size),this.memoryCache.delete(r),this.accessOrder.delete(r)}this.persistenceEnabled&&this.persistentCache&&await this.cleanExpiredPersistent(),this.memorySizeUsed>.8*this.maxMemorySize&&this.optimizeMemoryUsage()}async cleanExpiredPersistent(){try{const e=this.persistentCache.transaction(["waveforms"],"readwrite"),t=e.objectStore("waveforms").index("timestamp"),r=Date.now()-this.ttl,i=IDBKeyRange.upperBound(r);t.openCursor(i).onsuccess=e=>{const t=e.target.result;t&&(t.delete(),t.continue())}}catch(e){}}optimizeMemoryUsage(){const e=Array.from(this.memoryCache.entries()).map(([e,t])=>({key:e,entry:t,score:t.metadata.accessCount*(Date.now()-t.metadata.timestamp)}));e.sort((e,t)=>e.score-t.score);const t=Math.floor(.25*e.length);for(let r=0;r<t;r++){const{key:t,entry:i}=e[r];this.memorySizeUsed-=i.metadata.size,this.memoryCache.delete(t),this.accessOrder.delete(t),this.metrics.evictions++}}getStats(){const e=this.metrics.hits/(this.metrics.hits+this.metrics.misses)||0,t=this.metrics.persistenceHits/this.metrics.persistenceMisses||0;return{memoryCache:{entries:this.memoryCache.size,sizeUsed:this.memorySizeUsed,maxSize:this.maxMemorySize,utilizationPercent:this.memorySizeUsed/this.maxMemorySize*100},performance:{hitRate:100*e,persistentHitRate:100*t,totalHits:this.metrics.hits,totalMisses:this.metrics.misses,evictions:this.metrics.evictions},compression:{enabled:this.compressionEnabled,totalSavings:this.metrics.compressionSavings,averageRatio:this.metrics.averageCompressionRatio},persistence:{enabled:this.persistenceEnabled,hits:this.metrics.persistenceHits,misses:this.metrics.persistenceMisses}}}async clear(){if(this.memoryCache.clear(),this.accessOrder.clear(),this.memorySizeUsed=0,this.persistenceEnabled&&this.persistentCache)try{const e=this.persistentCache.transaction(["waveforms"],"readwrite");e.objectStore("waveforms").clear()}catch(e){}this.metrics={hits:0,misses:0,evictions:0,compressionSavings:0,averageCompressionRatio:0,persistenceHits:0,persistenceMisses:0}}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clear(),this.persistentCache&&(this.persistentCache.close(),this.persistentCache=null)}}class l{constructor(e={}){this.maxMemoryThreshold=e.maxMemoryThreshold||157286400,this.warningThreshold=e.warningThreshold||104857600,this.cleanupInterval=e.cleanupInterval||3e4,this.aggressiveCleanupThreshold=e.aggressiveCleanupThreshold||209715200,this.allocatedBuffers=new Map,this.bufferPool=new Map,this.memoryUsage={current:0,peak:0,allocated:0,pooled:0},this.cleanupStrategies=new Map,this.initializeCleanupStrategies(),this.performanceMetrics={cleanupCount:0,memoryReclaimed:0,bufferReuses:0,gcTriggers:0,averageCleanupTime:0},this.cleanupTimer=setInterval(()=>{this.performAutomaticCleanup()},this.cleanupInterval),this.memoryPressureObserver=null,this.initializeMemoryPressureMonitoring()}initializeCleanupStrategies(){this.cleanupStrategies.set("buffer-pool",{priority:1,execute:()=>this.cleanupBufferPool(),description:"Clean unused buffers from pool"}),this.cleanupStrategies.set("old-allocations",{priority:2,execute:()=>this.cleanupOldAllocations(),description:"Remove old allocated buffers"}),this.cleanupStrategies.set("large-buffers",{priority:3,execute:()=>this.cleanupLargeBuffers(),description:"Clean up large unused buffers"}),this.cleanupStrategies.set("force-gc",{priority:4,execute:()=>this.forceGarbageCollection(),description:"Force garbage collection"}),this.cleanupStrategies.set("emergency-cleanup",{priority:5,execute:()=>this.emergencyCleanup(),description:"Emergency memory cleanup"})}initializeMemoryPressureMonitoring(){if("undefined"!=typeof PerformanceObserver)try{this.memoryPressureObserver=new PerformanceObserver(e=>{const t=e.getEntries();for(const r of t)"measure"===r.entryType&&r.name.includes("memory")&&this.handleMemoryPressure(r)}),this.memoryPressureObserver.observe({entryTypes:["measure"]})}catch(e){}setInterval(()=>{this.checkMemoryPressure()},5e3)}allocateBuffer(e,t="waveform",r={}){const i=this.generateBufferId(),a=this.getPooledBuffer(e,t);if(a)return this.allocatedBuffers.set(i,{buffer:a,size:e,type:t,metadata:{...r,allocatedAt:Date.now(),reused:!0}}),this.performanceMetrics.bufferReuses++,{bufferId:i,buffer:a};let s;try{switch(t){case"waveform":case"float32":default:s=new Float32Array(e);break;case"uint8":s=new Uint8Array(e);break;case"int16":s=new Int16Array(e);break;case"arraybuffer":s=new ArrayBuffer(e)}const a=s.byteLength||s.length*s.BYTES_PER_ELEMENT;return this.allocatedBuffers.set(i,{buffer:s,size:a,type:t,metadata:{...r,allocatedAt:Date.now(),reused:!1}}),this.memoryUsage.current+=a,this.memoryUsage.allocated+=a,this.memoryUsage.peak=Math.max(this.memoryUsage.peak,this.memoryUsage.current),this.memoryUsage.current>this.warningThreshold&&this.scheduleCleanup("memory-warning"),{bufferId:i,buffer:s}}catch(n){if(this.memoryUsage.current>.8*this.maxMemoryThreshold){this.emergencyCleanup();try{s=new Float32Array(e);const a=s.byteLength||s.length*s.BYTES_PER_ELEMENT;return this.allocatedBuffers.set(i,{buffer:s,size:a,type:t,metadata:{...r,allocatedAt:Date.now(),reused:!1,emergencyRetry:!0}}),this.memoryUsage.current+=a,this.memoryUsage.allocated+=a,{bufferId:i,buffer:s}}catch(o){throw new Error(`Buffer allocation failed after emergency cleanup: ${o.message}`)}}throw n}}deallocateBuffer(e,t={}){const r=this.allocatedBuffers.get(e);if(!r)return!1;const{buffer:i,size:a,type:s}=r,{poolForReuse:n=!0,reason:o="manual"}=t;return this.allocatedBuffers.delete(e),this.memoryUsage.current-=a,n&&this.shouldPoolBuffer(i,a,s)&&this.addToBufferPool(i,a,s),!0}getPooledBuffer(e,t){const r=`${t}_${e}`,i=this.bufferPool.get(r);if(i&&i.length>0){const t=i.pop();return t.fill?t.fill(0):t instanceof ArrayBuffer&&new Uint8Array(t).fill(0),this.memoryUsage.pooled-=e,t}return null}addToBufferPool(e,t,r){const i=`${r}_${t}`;this.bufferPool.has(i)||this.bufferPool.set(i,[]);const a=this.bufferPool.get(i),s=Math.max(2,Math.floor(this.maxMemoryThreshold/t/10));a.length<s&&(a.push(e),this.memoryUsage.pooled+=t)}shouldPoolBuffer(e,t,r){if(t>10485760)return!1;if(this.memoryUsage.current>this.warningThreshold)return!1;return["waveform","float32","uint8","int16"].includes(r)}performAutomaticCleanup(){const e=this.getCurrentMemoryUsage();e>this.aggressiveCleanupThreshold?this.performCleanup(["emergency-cleanup","force-gc","large-buffers"]):e>this.maxMemoryThreshold?this.performCleanup(["large-buffers","old-allocations","buffer-pool"]):e>this.warningThreshold&&this.performCleanup(["buffer-pool","old-allocations"])}async performCleanup(e=[]){const t=performance.now();this.getCurrentMemoryUsage();const r=e.map(e=>({name:e,...this.cleanupStrategies.get(e)})).filter(e=>e.execute).sort((e,t)=>e.priority-t.priority);let i=0;for(const n of r)try{const e=this.getCurrentMemoryUsage();await n.execute();const t=this.getCurrentMemoryUsage(),r=e-t;if(r>0&&(i+=r),t<this.warningThreshold)break}catch(s){}const a=performance.now()-t;return this.updateCleanupMetrics(a,i),{strategiesUsed:r.map(e=>e.name),memoryReclaimed:i,cleanupTime:a,finalMemoryUsage:this.getCurrentMemoryUsage()}}scheduleCleanup(e="scheduled",t=0){setTimeout(()=>{this.performAutomaticCleanup()},t)}cleanupBufferPool(){let e=0;for(const[t,r]of this.bufferPool){const[i,a]=t.split("_"),s=parseInt(a),n=Math.max(1,Math.floor(r.length/2)),o=r.splice(n);e+=o.length*s,this.memoryUsage.pooled-=o.length*s}return e}cleanupOldAllocations(){let e=0;const t=Date.now(),r=[];for(const[i,a]of this.allocatedBuffers){t-a.metadata.allocatedAt>6e5&&!a.metadata.pinned&&(r.push(i),e+=a.size)}for(const i of r)this.deallocateBuffer(i,{poolForReuse:!1,reason:"age-cleanup"});return e}cleanupLargeBuffers(){let e=0;const t=[],r=Array.from(this.allocatedBuffers.entries()).sort(([,e],[,t])=>t.size-e.size);for(const[i,a]of r)if(a.size>5242880&&!a.metadata.pinned&&(t.push(i),e+=a.size,e>.2*this.maxMemoryThreshold))break;for(const i of t)this.deallocateBuffer(i,{poolForReuse:!1,reason:"size-cleanup"});return e}forceGarbageCollection(){if("function"==typeof gc)try{return gc(),this.performanceMetrics.gcTriggers++,!0}catch(e){}try{const e=[];for(let t=0;t<100;t++)e.push(new Float32Array(1024))}catch(e){}return!1}emergencyCleanup(){let e=0;const t=[];for(const[r,i]of this.allocatedBuffers)i.metadata.pinned||(t.push(r),e+=i.size);for(const r of t)this.deallocateBuffer(r,{poolForReuse:!1,reason:"emergency"});return this.bufferPool.clear(),this.memoryUsage.pooled=0,this.forceGarbageCollection(),e}pinBuffer(e,t="user-request"){const r=this.allocatedBuffers.get(e);return!!r&&(r.metadata.pinned=!0,r.metadata.pinnedReason=t,r.metadata.pinnedAt=Date.now(),!0)}unpinBuffer(e){const t=this.allocatedBuffers.get(e);return!!t&&(t.metadata.pinned=!1,delete t.metadata.pinnedReason,delete t.metadata.pinnedAt,!0)}getCurrentMemoryUsage(){return"undefined"!=typeof performance&&performance.memory?performance.memory.usedJSHeapSize:this.memoryUsage.current+this.memoryUsage.pooled}checkMemoryPressure(){const e=this.getCurrentMemoryUsage();this.calculateMemoryPressure(e)>.8&&this.performAutomaticCleanup()}calculateMemoryPressure(e){return Math.min(1,e/this.maxMemoryThreshold)}handleMemoryPressure(e){this.performAutomaticCleanup()}updateCleanupMetrics(e,t){this.performanceMetrics.cleanupCount++,this.performanceMetrics.memoryReclaimed+=t;const r=this.performanceMetrics.averageCleanupTime,i=this.performanceMetrics.cleanupCount;this.performanceMetrics.averageCleanupTime=(r*(i-1)+e)/i}generateBufferId(){return`buffer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}formatBytes(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}getMemoryStats(){const e=this.getCurrentMemoryUsage(),t=this.calculateMemoryPressure(e);return{usage:{current:e,peak:this.memoryUsage.peak,allocated:this.memoryUsage.allocated,pooled:this.memoryUsage.pooled,formatted:{current:this.formatBytes(e),peak:this.formatBytes(this.memoryUsage.peak),allocated:this.formatBytes(this.memoryUsage.allocated),pooled:this.formatBytes(this.memoryUsage.pooled)}},thresholds:{warning:this.warningThreshold,max:this.maxMemoryThreshold,aggressive:this.aggressiveCleanupThreshold,formatted:{warning:this.formatBytes(this.warningThreshold),max:this.formatBytes(this.maxMemoryThreshold),aggressive:this.formatBytes(this.aggressiveCleanupThreshold)}},pressure:{level:t,status:t>.8?"high":t>.6?"medium":"low"},allocations:{count:this.allocatedBuffers.size,pooledBuffers:Array.from(this.bufferPool.values()).reduce((e,t)=>e+t.length,0),pinnedBuffers:Array.from(this.allocatedBuffers.values()).filter(e=>e.metadata.pinned).length},performance:this.performanceMetrics}}destroy(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),this.memoryPressureObserver&&(this.memoryPressureObserver.disconnect(),this.memoryPressureObserver=null),this.emergencyCleanup(),this.allocatedBuffers.clear(),this.bufferPool.clear(),this.cleanupStrategies.clear()}}class h{constructor(e={}){this.options={targetFPS:e.targetFPS||60,minFPS:e.minFPS||30,performanceWindow:e.performanceWindow||5e3,degradationThreshold:e.degradationThreshold||.7,recoveryThreshold:e.recoveryThreshold||.9,maxDegradationLevel:e.maxDegradationLevel||3,...e},this.metrics={fps:{current:0,average:0,min:1/0,max:0,samples:[]},renderTime:{current:0,average:0,min:1/0,max:0,samples:[]},memoryUsage:{current:0,peak:0,trend:"stable"},cpuUsage:{estimated:0,trend:"stable"}},this.currentQualityLevel="high",this.degradationLevel=0,this.isMonitoring=!1,this.adaptiveSettings=this.getDefaultAdaptiveSettings(),this.qualityChangeCallbacks=new Set,this.performanceWarningCallbacks=new Set,this.monitoringInterval=null,this.metricsCollectionInterval=null,this.lastFrameTime=0,this.frameCount=0,this.renderStartTime=0,this.deviceCapabilities=null,this.detectDeviceCapabilities()}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.lastFrameTime=performance.now(),this.metricsCollectionInterval=setInterval(()=>{this.collectMetrics()},1e3),this.monitoringInterval=setInterval(()=>{this.analyzePerformance()},this.options.performanceWindow))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.metricsCollectionInterval&&(clearInterval(this.metricsCollectionInterval),this.metricsCollectionInterval=null),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null))}frameRenderStart(){this.renderStartTime=performance.now()}frameRenderEnd(){const e=performance.now(),t=e-this.renderStartTime,r=e-this.lastFrameTime,i=r>0?1e3/r:0;this.updateFPSMetrics(i),this.updateRenderTimeMetrics(t),this.lastFrameTime=e,this.frameCount++,i<this.options.minFPS&&this.handleLowPerformance("fps",i),t>33&&this.handleLowPerformance("renderTime",t)}updateFPSMetrics(e){this.metrics.fps.current=e,this.metrics.fps.min=Math.min(this.metrics.fps.min,e),this.metrics.fps.max=Math.max(this.metrics.fps.max,e),this.metrics.fps.samples.push(e),this.metrics.fps.samples.length>60&&this.metrics.fps.samples.shift(),this.metrics.fps.average=this.metrics.fps.samples.reduce((e,t)=>e+t,0)/this.metrics.fps.samples.length}updateRenderTimeMetrics(e){this.metrics.renderTime.current=e,this.metrics.renderTime.min=Math.min(this.metrics.renderTime.min,e),this.metrics.renderTime.max=Math.max(this.metrics.renderTime.max,e),this.metrics.renderTime.samples.push(e),this.metrics.renderTime.samples.length>60&&this.metrics.renderTime.samples.shift(),this.metrics.renderTime.average=this.metrics.renderTime.samples.reduce((e,t)=>e+t,0)/this.metrics.renderTime.samples.length}collectMetrics(){if("undefined"!=typeof performance&&performance.memory){const e=performance.memory.usedJSHeapSize;this.metrics.memoryUsage.current=e,this.metrics.memoryUsage.peak=Math.max(this.metrics.memoryUsage.peak,e),this.updateMemoryTrend(e)}this.estimateCPUUsage()}updateMemoryTrend(e){if(!this.lastMemoryReading)return void(this.lastMemoryReading=e);const t=e-this.lastMemoryReading,r=Math.abs(t)/this.lastMemoryReading;this.metrics.memoryUsage.trend=r>.05?t>0?"increasing":"decreasing":"stable",this.lastMemoryReading=e}estimateCPUUsage(){const e=1e3/this.options.targetFPS,t=this.metrics.renderTime.average,r=Math.min(1,t/e);if(this.metrics.cpuUsage.estimated=r,!this.lastCPUReading)return void(this.lastCPUReading=r);const i=r-this.lastCPUReading;Math.abs(i)>.1?this.metrics.cpuUsage.trend=i>0?"increasing":"decreasing":this.metrics.cpuUsage.trend="stable",this.lastCPUReading=r}analyzePerformance(){const e=this.calculatePerformanceScore(),t=e<this.options.degradationThreshold,r=e>this.options.recoveryThreshold;t&&this.degradationLevel<this.options.maxDegradationLevel?this.degradeQuality():r&&this.degradationLevel>0&&this.improveQuality(),this.checkCriticalPerformance()}calculatePerformanceScore(){return.4*Math.min(1,this.metrics.fps.average/this.options.targetFPS)+.3*Math.min(1,1e3/this.options.targetFPS/this.metrics.renderTime.average)+.2*this.calculateMemoryScore()+.1*(1-this.metrics.cpuUsage.estimated)}calculateMemoryScore(){if(!this.deviceCapabilities||!this.deviceCapabilities.memoryLimit)return 1;const e=this.metrics.memoryUsage.current/this.deviceCapabilities.memoryLimit;return Math.max(0,1-e)}degradeQuality(){this.degradationLevel++;const e=this.getAdaptiveSettings(this.degradationLevel);this.applyAdaptiveSettings(e);const t=this.getQualityLevelName(this.degradationLevel);this.notifyQualityChange(t,"degraded",{reason:"performance",score:this.calculatePerformanceScore(),level:this.degradationLevel})}improveQuality(){this.degradationLevel--;const e=this.getAdaptiveSettings(this.degradationLevel);this.applyAdaptiveSettings(e);const t=this.getQualityLevelName(this.degradationLevel);this.notifyQualityChange(t,"improved",{reason:"performance-recovery",score:this.calculatePerformanceScore(),level:this.degradationLevel})}getAdaptiveSettings(e){const t=this.getDefaultAdaptiveSettings();switch(e){case 0:default:return t;case 1:return{...t,renderQuality:"medium",waveformResolution:.8,enableAntialiasing:!0,maxBatchSize:800};case 2:return{...t,renderQuality:"medium",waveformResolution:.6,enableAntialiasing:!1,maxBatchSize:600,enableViewportCulling:!0,chopRenderingDetail:"medium"};case 3:return{...t,renderQuality:"low",waveformResolution:.4,enableAntialiasing:!1,maxBatchSize:400,enableViewportCulling:!0,chopRenderingDetail:"low",disableAnimations:!0,simplifiedRendering:!0}}}getDefaultAdaptiveSettings(){return{renderQuality:"high",waveformResolution:1,enableAntialiasing:!0,maxBatchSize:1e3,enableViewportCulling:!0,chopRenderingDetail:"high",disableAnimations:!1,simplifiedRendering:!1,targetFPS:this.options.targetFPS}}applyAdaptiveSettings(e){this.adaptiveSettings={...e},this.currentQualityLevel=this.getQualityLevelName(this.degradationLevel)}getQualityLevelName(e){const t=["high","medium-high","medium","low"];return t[Math.min(e,t.length-1)]}handleLowPerformance(e,t){this.notifyPerformanceWarning({metric:e,value:t,threshold:"fps"===e?this.options.minFPS:33,timestamp:Date.now(),currentQuality:this.currentQualityLevel,degradationLevel:this.degradationLevel})}checkCriticalPerformance(){const e=[];if(this.metrics.fps.average<.5*this.options.minFPS&&e.push({type:"critical-fps",value:this.metrics.fps.average,threshold:.5*this.options.minFPS}),this.deviceCapabilities&&this.deviceCapabilities.memoryLimit){const t=this.metrics.memoryUsage.current/this.deviceCapabilities.memoryLimit;t>.9&&e.push({type:"critical-memory",value:t,threshold:.9})}this.metrics.renderTime.average>100&&e.push({type:"critical-render-time",value:this.metrics.renderTime.average,threshold:100}),e.length>0&&this.handleCriticalPerformance(e)}handleCriticalPerformance(e){this.degradationLevel=this.options.maxDegradationLevel;const t=this.getEmergencySettings();this.applyAdaptiveSettings(t),this.notifyPerformanceWarning({type:"critical",issues:e,emergencyMode:!0,timestamp:Date.now()})}getEmergencySettings(){return{renderQuality:"low",waveformResolution:.2,enableAntialiasing:!1,maxBatchSize:200,enableViewportCulling:!0,chopRenderingDetail:"minimal",disableAnimations:!0,simplifiedRendering:!0,emergencyMode:!0,targetFPS:Math.max(15,.5*this.options.minFPS)}}detectDeviceCapabilities(){this.deviceCapabilities={memoryLimit:this.detectMemoryLimit(),cpuCores:navigator.hardwareConcurrency||4,webglSupport:this.detectWebGLSupport(),performanceAPISupport:"undefined"!=typeof performance&&!!performance.memory,deviceType:this.detectDeviceType(),connectionType:this.detectConnectionType()}}detectMemoryLimit(){if("undefined"!=typeof performance&&performance.memory)return performance.memory.jsHeapSizeLimit;switch(this.detectDeviceType()){case"mobile":return 104857600;case"tablet":default:return 209715200;case"desktop":return 524288e3}}detectWebGLSupport(){try{if("undefined"==typeof document||"undefined"==typeof HTMLCanvasElement)return!1;const e=document.createElement("canvas");return!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}detectDeviceType(){const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}detectConnectionType(){return navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:null}onQualityChange(e){return this.qualityChangeCallbacks.add(e),()=>this.qualityChangeCallbacks.delete(e)}onPerformanceWarning(e){return this.performanceWarningCallbacks.add(e),()=>this.performanceWarningCallbacks.delete(e)}notifyQualityChange(e,t,r){const i={newQuality:e,changeType:t,details:r,settings:this.adaptiveSettings,timestamp:Date.now()};this.qualityChangeCallbacks.forEach(e=>{try{e(i)}catch(t){}})}notifyPerformanceWarning(e){this.performanceWarningCallbacks.forEach(t=>{try{t(e)}catch(r){}})}getMetrics(){return{...this.metrics,performanceScore:this.calculatePerformanceScore(),qualityLevel:this.currentQualityLevel,degradationLevel:this.degradationLevel,adaptiveSettings:this.adaptiveSettings,deviceCapabilities:this.deviceCapabilities}}getAdaptiveSettings(){return{...this.adaptiveSettings}}forceQualityLevel(e){const t={high:0,"medium-high":1,medium:2,low:3}[e]||0;this.degradationLevel=t;const r=this.getAdaptiveSettings(t);this.applyAdaptiveSettings(r),this.notifyQualityChange(e,"forced",{reason:"user-override",level:t})}resetQuality(){this.degradationLevel=0;const e=this.getDefaultAdaptiveSettings();this.applyAdaptiveSettings(e),this.notifyQualityChange("high","reset",{reason:"user-reset"})}destroy(){this.stopMonitoring(),this.qualityChangeCallbacks.clear(),this.performanceWarningCallbacks.clear()}}class m{constructor(e={}){this.options={enableWebWorkers:!1!==e.enableWebWorkers,enableCaching:!1!==e.enableCaching,enableMemoryManagement:!1!==e.enableMemoryManagement,enablePerformanceMonitoring:!1!==e.enablePerformanceMonitoring,workerPoolSize:e.workerPoolSize||2,...e},this.cache=null,this.memoryManager=null,this.performanceMonitor=null,this.workerPool=[],this.workerQueue=[],this.isInitialized=!1,this.activeWorkerTasks=new Map,this.taskIdCounter=0,this.metrics={workerTasks:{completed:0,failed:0,averageTime:0,queueLength:0},cachePerformance:{hits:0,misses:0,hitRate:0},memoryOptimization:{cleanupCount:0,memoryReclaimed:0,currentUsage:0},overallPerformance:{score:1,qualityLevel:"high",degradationLevel:0}},this.initialize()}async initialize(){if(!this.isInitialized)try{this.options.enableCaching&&(this.cache=new c({maxMemorySize:this.options.cacheMaxMemory||104857600,maxCacheEntries:this.options.cacheMaxEntries||50,persistenceEnabled:!1!==this.options.cachePersistence,compressionEnabled:!1!==this.options.cacheCompression}),await this.cache.initializePersistence()),this.options.enableMemoryManagement&&(this.memoryManager=new l({maxMemoryThreshold:this.options.memoryMaxThreshold||157286400,warningThreshold:this.options.memoryWarningThreshold||104857600,cleanupInterval:this.options.memoryCleanupInterval||3e4})),this.options.enablePerformanceMonitoring&&(this.performanceMonitor=new h({targetFPS:this.options.targetFPS||60,minFPS:this.options.minFPS||30,degradationThreshold:this.options.degradationThreshold||.7,recoveryThreshold:this.options.recoveryThreshold||.9}),this.setupPerformanceCallbacks(),this.performanceMonitor.startMonitoring()),this.options.enableWebWorkers&&await this.initializeWorkerPool(),this.isInitialized=!0}catch(e){throw e}}async initializeWorkerPool(){try{let t;try{t=new URL("/assets/WaveformWorker-Cx3X8jrY.js",import.meta.url)}catch(e){t="../workers/WaveformWorker.js"}for(let r=0;r<this.options.workerPoolSize;r++)try{const e=new Worker(t,{type:"module"});e.onmessage=t=>{this.handleWorkerMessage(e,t)},e.onerror=t=>{this.handleWorkerError(e,t)},this.workerPool.push({worker:e,id:r,busy:!1,currentTask:null})}catch(e){}}catch(e){}}setupPerformanceCallbacks(){this.performanceMonitor&&(this.performanceMonitor.onQualityChange(e=>{this.handleQualityChange(e)}),this.performanceMonitor.onPerformanceWarning(e=>{this.handlePerformanceWarning(e)}))}async generateOptimizedWaveform(e,t={}){const r=performance.now();try{this.performanceMonitor&&this.performanceMonitor.frameRenderStart();let i=null;if(this.cache){const r=this.cache.generateCacheKey(e,t);if(i=await this.cache.get(r),i)return this.updateCacheMetrics(!0),i;this.updateCacheMetrics(!1)}const a=this.getAdaptiveSettings(),s={...t,...a,quality:a.renderQuality||t.quality||"medium"};if(i=this.options.enableWebWorkers&&this.workerPool.length>0?await this.generateWaveformWithWorker(e,s):await this.generateWaveformDirect(e,s),this.cache&&i){const a=this.cache.generateCacheKey(e,t);await this.cache.set(a,i,{generationTime:performance.now()-r,quality:s.quality,method:this.options.enableWebWorkers?"worker":"direct"})}return this.performanceMonitor&&this.performanceMonitor.frameRenderEnd(),i}catch(i){if("low"!==t.quality)return this.generateOptimizedWaveform(e,{...t,quality:"low",fallback:!0});throw i}}async generateWaveformWithWorker(e,t){return new Promise((r,i)=>{const a={id:this.generateTaskId(),type:"ANALYZE_WAVEFORM",data:{audioBuffer:e.buffer||e,options:t},resolve:r,reject:i,startTime:performance.now()},s=this.getAvailableWorker();s?this.assignTaskToWorker(a,s):(this.workerQueue.push(a),this.updateWorkerMetrics())})}async generateWaveformDirect(e,t){const r=e.buffer||e;if(!r||!r.length)throw new Error("Invalid audio buffer");const i=t.targetSampleRate||1e3,a=t.quality||"medium";let s=null,n=null;if(this.memoryManager){const e=this.memoryManager.allocateBuffer(Math.floor(r.length*i/44100),"waveform",{source:"direct-generation",quality:a});s=e.bufferId,n=e.buffer}else n=new Float32Array(Math.floor(r.length*i/44100));try{const e=r.length/n.length;for(let t=0;t<n.length;t++){const i=Math.floor(t*e);if("high"===a){let a=0;const s=Math.max(1,Math.floor(e));for(let e=0;e<s&&i+e<r.length;e++){const t=r[i+e]||0;a+=t*t}n[t]=Math.sqrt(a/s)}else n[t]=Math.abs(r[i]||0)}return{samples:n,sampleRate:i,duration:n.length/i,channels:1,metadata:{analysisMethod:"direct-optimized",quality:a,generatedAt:Date.now(),bufferId:s}}}catch(o){throw s&&this.memoryManager&&this.memoryManager.deallocateBuffer(s,{poolForReuse:!1}),o}}getAvailableWorker(){return this.workerPool.find(e=>!e.busy)}assignTaskToWorker(e,t){t.busy=!0,t.currentTask=e,this.activeWorkerTasks.set(e.id,{task:e,workerInfo:t}),t.worker.postMessage({type:e.type,taskId:e.id,data:e.data})}handleWorkerMessage(e,t){const{type:r,taskId:i,data:a,error:s}=t.data,n=this.activeWorkerTasks.get(i);if(!n)return;const{task:o,workerInfo:c}=n;switch(r){case"RESULT":this.handleWorkerResult(o,a),this.completeWorkerTask(i,c);break;case"ERROR":this.handleWorkerError(o,s),this.completeWorkerTask(i,c);break;case"PROGRESS":this.handleWorkerProgress(o,a);break;case"PERFORMANCE_METRICS":this.handleWorkerPerformanceMetrics(a)}}handleWorkerResult(e,t){const r=performance.now()-e.startTime;this.updateWorkerTaskMetrics(r,!0),e.resolve(t)}handleWorkerError(e,t){const r=performance.now()-e.startTime;this.updateWorkerTaskMetrics(r,!1),e.reject(new Error(t||"Worker task failed"))}handleWorkerProgress(e,t){}handleWorkerPerformanceMetrics(e){this.metrics.workerTasks={...this.metrics.workerTasks,...e}}completeWorkerTask(e,t){if(t.busy=!1,t.currentTask=null,this.activeWorkerTasks.delete(e),this.workerQueue.length>0){const e=this.workerQueue.shift();this.assignTaskToWorker(e,t)}this.updateWorkerMetrics()}handleQualityChange(e){this.metrics.overallPerformance.qualityLevel=e.newQuality,this.metrics.overallPerformance.degradationLevel=e.details.level||0,"low"===e.newQuality&&this.cache&&this.cache.optimizeMemoryUsage()}handlePerformanceWarning(e){"critical"===e.type&&this.triggerEmergencyOptimizations()}triggerEmergencyOptimizations(){if(this.memoryManager&&this.memoryManager.emergencyCleanup(),this.cache&&this.cache.clear(),this.workerPool.length>1){this.workerPool.splice(1).forEach(e=>{e.worker.terminate()})}}getAdaptiveSettings(){return this.performanceMonitor?this.performanceMonitor.getAdaptiveSettings():{renderQuality:"medium",waveformResolution:1,enableAntialiasing:!0,maxBatchSize:1e3}}updateCacheMetrics(e){e?this.metrics.cachePerformance.hits++:this.metrics.cachePerformance.misses++;const t=this.metrics.cachePerformance.hits+this.metrics.cachePerformance.misses;this.metrics.cachePerformance.hitRate=this.metrics.cachePerformance.hits/t}updateWorkerTaskMetrics(e,t){if(t){this.metrics.workerTasks.completed++;const t=this.metrics.workerTasks.averageTime,r=this.metrics.workerTasks.completed;this.metrics.workerTasks.averageTime=(t*(r-1)+e)/r}else this.metrics.workerTasks.failed++}updateWorkerMetrics(){this.metrics.workerTasks.queueLength=this.workerQueue.length}generateTaskId(){return`task_${++this.taskIdCounter}_${Date.now()}`}getPerformanceMetrics(){const e={...this.metrics};return this.cache&&(e.cache=this.cache.getStats()),this.memoryManager&&(e.memory=this.memoryManager.getMemoryStats()),this.performanceMonitor&&(e.performance=this.performanceMonitor.getMetrics(),e.overallPerformance.score=e.performance.performanceScore),e}setQualityLevel(e){this.performanceMonitor&&this.performanceMonitor.forceQualityLevel(e)}async clearCaches(){this.cache&&await this.cache.clear(),this.memoryManager&&this.memoryManager.emergencyCleanup()}optimizeForLowEndDevice(){if(this.setQualityLevel("low"),this.workerPool.length>1){this.workerPool.splice(1).forEach(e=>{e.worker.terminate()})}this.cache&&(this.cache.maxMemorySize=52428800,this.cache.maxCacheEntries=25),this.memoryManager&&(this.memoryManager.maxMemoryThreshold=104857600,this.memoryManager.warningThreshold=78643200)}destroy(){this.performanceMonitor&&(this.performanceMonitor.destroy(),this.performanceMonitor=null),this.memoryManager&&(this.memoryManager.destroy(),this.memoryManager=null),this.cache&&(this.cache.destroy(),this.cache=null),this.workerPool.forEach(e=>{e.worker.terminate()}),this.workerPool=[],this.activeWorkerTasks.clear(),this.workerQueue=[],this.isInitialized=!1}}function u({audioSource:i,waveformData:a,chops:c=[],currentTime:l=0,isPlaying:h=!1,onChopCreate:u,onChopUpdate:d,onTimeSeek:p,visualSettings:g={},className:f=""}){const y=e.useRef(null),v=e.useRef(null),C=e.useRef(null),b=e.useRef(null),M=e.useRef(null),[w,T]=e.useState(!1),[S,P]=e.useState(null),[k,A]=e.useState(null),[E,x]=e.useState({}),[z,L]=e.useState("high"),D=e.useRef(null),R=e.useCallback(async()=>{if(!M.current)try{return M.current=new m({enableWebWorkers:!1!==g.enableWebWorkers,enableCaching:!1!==g.enableCaching,enableMemoryManagement:!1!==g.enableMemoryManagement,enablePerformanceMonitoring:!1!==g.enablePerformanceMonitoring,workerPoolSize:g.workerPoolSize||2,targetFPS:g.targetFPS||60,minFPS:g.minFPS||30}),await M.current.initialize(),M.current.performanceMonitor&&M.current.performanceMonitor.onQualityChange(e=>{L(e.newQuality)}),!0}catch(e){return!1}},[g]),W=e.useCallback(()=>{const e=y.current;if(!e||v.current)return!1;try{const t=M.current?.getAdaptiveSettings()||{};if(v.current=new n(e,{enableViewportCulling:!1!==t.enableViewportCulling,enableBatching:!1!==t.enableBatching,renderQuality:t.renderQuality||g.quality||"high",enableAntialiasing:!1!==t.enableAntialiasing&&!1!==g.antialiasing,maxBatchSize:t.maxBatchSize||1e3,enableFrequencyColorCoding:!1!==g.enableFrequencyColorCoding,enableAmplitudeColorCoding:!1!==g.enableAmplitudeColorCoding,enableStructureDetection:!1!==g.enableStructureDetection,enableAccessibilityMode:g.enableAccessibilityMode||!1,enableHighContrastMode:g.enableHighContrastMode||!1,colorScheme:g.colorScheme||"default"}),a?.duration){v.current.getViewportManager().setAudioDuration(a.duration)}return C.current=new s(v.current,{clickThreshold:5,hoverDelay:100,snapTolerance:10,enableHover:!0,enableClick:!0,enableDrag:!0}),C.current.setCallbacks({onChopCreate:u,onChopUpdate:d,onTimeSeek:p,onHover:(e,t,r)=>{e&&"chop-region"===e.type?A(e.chopId):A(null)}}),b.current=new o(v.current,{playheadColor:g.playheadColor||"#ef4444",playheadWidth:g.playheadWidth||2,activeChopColor:g.activeChopColor||"#fbbf24",showTimeDisplay:!1!==g.showPlayheadTime,animationQuality:g.animationQuality||"high"}),!0}catch(t){return!1}},[g,a]),I=e.useCallback(e=>{if(!v.current)return;const t=v.current.getViewportManager();void 0!==e.zoomLevel?t.setZoom(e.zoomLevel,e.centerTime):void 0!==e.centerTime&&t.panToTime(e.centerTime)},[]),F=e.useCallback(e=>v.current?v.current.getViewportManager().timeToPixel(e):0,[]),U=e.useCallback(e=>v.current?v.current.getViewportManager().pixelToTime(e):0,[]),B=e.useCallback(()=>{if(!v.current||!w)return;const e=v.current;M.current?.performanceMonitor&&M.current.performanceMonitor.frameRenderStart();const t=M.current?.getAdaptiveSettings()||{};a&&e.renderWaveform(a,{quality:t.renderQuality||g.quality||"high",topColor:g.topColor,centerColor:g.centerColor,bottomColor:g.bottomColor,strokeColor:g.strokeColor,waveformResolution:t.waveformResolution||1,enableAntialiasing:!1!==t.enableAntialiasing}),c.length>0&&e.renderChops(c,S,{highlightSelected:!0,hoveredChopId:k,activeChopId:null}),e.renderUI({showZoomIndicator:!1!==g.showZoomIndicator,textColor:g.textColor,tickColor:g.tickColor});const r={...e.getPerformanceMetrics(),optimizer:M.current?.getPerformanceMetrics()||{}};x(r),M.current?.performanceMonitor&&M.current.performanceMonitor.frameRenderEnd()},[w,a,c,S,k,l,h,g,z]),O=e.useCallback(()=>{if(!v.current)return;const e=y.current;if(!e)return;const t=e.getBoundingClientRect();v.current.resize(t.width,t.height)},[]);e.useEffect(()=>{(async()=>{await R(),W()&&T(!0)})()},[R,W]),e.useEffect(()=>{const e=new ResizeObserver(O);return y.current&&e.observe(y.current),()=>{e.disconnect()}},[O]),e.useEffect(()=>{B()},[B]),e.useEffect(()=>{C.current&&C.current.setCurrentChops(c),b.current&&b.current.setChops(c)},[c]),e.useEffect(()=>{C.current&&a&&C.current.setWaveformData(a)},[a]),e.useEffect(()=>{b.current&&b.current.updatePlaybackState(l,h)},[l,h]),e.useEffect(()=>{b.current&&b.current.setOptions({playheadColor:g.playheadColor||"#ef4444",playheadWidth:g.playheadWidth||2,activeChopColor:g.activeChopColor||"#fbbf24",showTimeDisplay:!1!==g.showPlayheadTime,animationQuality:g.animationQuality||"high"})},[g]),e.useEffect(()=>()=>{D.current&&cancelAnimationFrame(D.current),b.current&&(b.current.destroy(),b.current=null),C.current&&(C.current.destroy(),C.current=null),v.current&&(v.current.destroy(),v.current=null),M.current&&(M.current.destroy(),M.current=null)},[]);const q=e.useCallback(e=>{P(e),d&&d(e,{selected:!0})},[d]),Q=e.useCallback(()=>v.current?.getViewportManager(),[]);return e.useMemo(()=>({setZoomLevel:(e,t)=>{I({zoomLevel:e,centerTime:t})},panToTime:e=>{I({centerTime:e})},zoomIn:(e=2,t)=>{if(v.current){v.current.getViewportManager().zoomIn(e,t)}},zoomOut:(e=2,t)=>{if(v.current){v.current.getViewportManager().zoomOut(e,t)}},zoomToFit:()=>{if(v.current){v.current.getViewportManager().zoomToFit()}},getViewport:()=>v.current?v.current.getViewportManager().getState():null,getViewportManager:Q,getPerformanceMetrics:()=>({...E,playhead:b.current?.getPerformanceMetrics()||{},optimizer:M.current?.getPerformanceMetrics()||{},currentQuality:z}),getSyncStatus:()=>b.current?.getSyncStatus()||null,jumpToTime:e=>{b.current&&b.current.jumpToTime(e),p&&p(e)},setRenderQuality:e=>{v.current&&v.current.setRenderQuality(e),M.current&&M.current.setQualityLevel(e)},getPerformanceOptimizer:()=>M.current,optimizeForLowEndDevice:()=>{M.current&&M.current.optimizeForLowEndDevice()},clearCaches:async()=>{M.current&&await M.current.clearCaches()},getVisualEnhancementEngine:()=>v.current?.getVisualEnhancementEngine(),updateVisualSettings:e=>{v.current&&v.current.updateVisualSettings&&(v.current.updateVisualSettings(e),B())},getVisualSettings:()=>{const e=v.current?.getVisualEnhancementEngine();return e?e.createVisualSettings():null},timeToPixel:F,pixelToTime:U,render:B,selectChop:q}),[I,F,U,B,q,E,Q]),t.jsxs(r.div,{ref:y,className:`relative w-full h-full bg-gray-900 rounded-lg overflow-hidden ${f}`,initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:[!w&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsx("div",{className:"text-white/70 text-sm",children:"Initializing high-performance renderer..."})}),!1]})}export{u as WaveformVisualization,u as default};
