class e{constructor(e={}){this.options={enableFrequencyColorCoding:!0,enableAmplitudeColorCoding:!0,enableStructureDetection:!0,enableAccessibilityMode:!1,enableHighContrastMode:!1,colorScheme:"default",...e},this.frequencyColorSchemes={default:{bass:{r:220,g:38,b:127},lowMid:{r:239,g:68,b:68},mid:{r:245,g:158,b:11},highMid:{r:34,g:197,b:94},treble:{r:59,g:130,b:246}},"high-contrast":{bass:{r:255,g:255,b:255},lowMid:{r:255,g:255,b:0},mid:{r:255,g:0,b:255},highMid:{r:0,g:255,b:255},treble:{r:0,g:0,b:0}},"colorblind-friendly":{bass:{r:0,g:114,b:178},lowMid:{r:230,g:159,b:0},mid:{r:0,g:158,b:115},highMid:{r:204,g:121,b:167},treble:{r:86,g:180,b:233}}},this.amplitudeColorMap={silent:{alpha:.1,brightness:.3},quiet:{alpha:.3,brightness:.5},moderate:{alpha:.6,brightness:.7},loud:{alpha:.8,brightness:.9},peak:{alpha:1,brightness:1}},this.structurePatterns={verse:{color:{r:100,g:149,b:237},pattern:"solid",description:"Verse section"},chorus:{color:{r:255,g:215,b:0},pattern:"gradient",description:"Chorus section"},bridge:{color:{r:147,g:112,b:219},pattern:"dashed",description:"Bridge section"},intro:{color:{r:60,g:179,b:113},pattern:"dotted",description:"Intro section"},outro:{color:{r:205,g:92,b:92},pattern:"dotted",description:"Outro section"},break:{color:{r:255,g:140,b:0},pattern:"sparse",description:"Break/Drop section"}},this.accessibilityPatterns={bass:{pattern:"vertical-lines",density:"high"},lowMid:{pattern:"diagonal-lines",density:"medium"},mid:{pattern:"dots",density:"medium"},highMid:{pattern:"horizontal-lines",density:"low"},treble:{pattern:"cross-hatch",density:"sparse"}},this.cache=new Map}applyFrequencyColorCoding(e,t){if(!this.options.enableFrequencyColorCoding||!t)return this.getDefaultWaveformColors();const r=`freq-${e.duration}-${this.options.colorScheme}`;if(this.cache.has(r))return this.cache.get(r);const n=this.frequencyColorSchemes[this.options.colorScheme]||this.frequencyColorSchemes.default,i=[],o=Math.floor(t.length/100);for(let s=0;s<100;s++){const r=s*o,a=Math.min((s+1)*o,t.length),l=this.analyzeFrequencyContent(t.slice(r,a)),c=this.getDominantFrequencyColor(l,n);i.push({startTime:s/100*e.duration,endTime:(s+1)/100*e.duration,color:c,frequencyProfile:l})}return this.cache.set(r,i),i}applyAmplitudeColorCoding(e){if(!this.options.enableAmplitudeColorCoding)return null;const{samples:t}=e;if(!t)return null;const r=[],n=Math.floor(t.length/200);for(let i=0;i<200;i++){const o=i*n,s=Math.min((i+1)*n,t.length),a=this.calculateRMS(t.slice(o,s)),l=this.categorizeAmplitude(a);r.push({startTime:o/t.length*e.duration,endTime:s/t.length*e.duration,amplitude:a,level:l,colorModifier:this.amplitudeColorMap[l]})}return r}detectSongStructure(e,t={}){if(!this.options.enableStructureDetection)return[];const r=`structure-${e.duration}-${JSON.stringify(t)}`;if(this.cache.has(r))return this.cache.get(r);const{samples:n,duration:i}=e;if(!n||!i)return[];const o=[],s=this.analyzeEnergyProfile(n,i);return this.identifyStructuralSections(s,i,t).forEach(e=>{const t=this.structurePatterns[e.type]||this.structurePatterns.verse;o.push({...e,visualPattern:t,accessibilityLabel:t.description})}),this.cache.set(r,o),o}applyHighContrastMode(e){return this.options.enableHighContrastMode?e.map(e=>({...e,color:this.convertToHighContrast(e.color),strokeWidth:Math.max(e.strokeWidth||1,2),shadowBlur:4,shadowColor:"rgba(0, 0, 0, 0.8)"})):e}generateAccessibilityPatterns(e){if(!this.options.enableAccessibilityMode)return null;const t=[],r=Math.floor(e.length/50);for(let n=0;n<50;n++){const i=n*r,o=Math.min((n+1)*r,e.length),s=this.analyzeFrequencyContent(e.slice(i,o)),a=this.getDominantFrequency(s),l=this.accessibilityPatterns[a];t.push({startTime:n/50*(e.length/44100),endTime:(n+1)/50*(e.length/44100),pattern:l.pattern,density:l.density,frequencyType:a})}return t}createVisualSettings(){return{frequencyColorCoding:{enabled:this.options.enableFrequencyColorCoding,colorScheme:this.options.colorScheme,intensity:.8,blendMode:"normal"},amplitudeColorCoding:{enabled:this.options.enableAmplitudeColorCoding,sensitivity:.7,dynamicRange:!0},structureDetection:{enabled:this.options.enableStructureDetection,sensitivity:.6,showLabels:!0,showPatterns:!0},accessibility:{highContrastMode:this.options.enableHighContrastMode,alternativePatterns:this.options.enableAccessibilityMode,textSize:"medium",reducedMotion:!1},enhancements:{gradientFill:!0,shadowEffects:!1,animatedElements:!0,particleEffects:!1}}}updateVisualSettings(e,t){const r={...this.options};if(Object.assign(this.options,{enableFrequencyColorCoding:e.frequencyColorCoding?.enabled??this.options.enableFrequencyColorCoding,enableAmplitudeColorCoding:e.amplitudeColorCoding?.enabled??this.options.enableAmplitudeColorCoding,enableStructureDetection:e.structureDetection?.enabled??this.options.enableStructureDetection,enableHighContrastMode:e.accessibility?.highContrastMode??this.options.enableHighContrastMode,enableAccessibilityMode:e.accessibility?.alternativePatterns??this.options.enableAccessibilityMode,colorScheme:e.frequencyColorCoding?.colorScheme??this.options.colorScheme}),this.cache.clear(),t&&"function"==typeof t)try{t(this.options,r)}catch(n){Object.assign(this.options,r)}return this.options}analyzeFrequencyContent(e){return{bassEnergy:this.calculateBandEnergy(e,0,10),lowMidEnergy:this.calculateBandEnergy(e,10,20),midEnergy:this.calculateBandEnergy(e,20,80),highMidEnergy:this.calculateBandEnergy(e,80,160),trebleEnergy:this.calculateBandEnergy(e,160,255)}}calculateBandEnergy(e,t,r){let n=0;for(let i=t;i<=Math.min(r,e.length-1);i++)n+=e[i]*e[i];return Math.sqrt(n/(r-t+1))}getDominantFrequencyColor(e,t){const{bassEnergy:r,lowMidEnergy:n,midEnergy:i,highMidEnergy:o,trebleEnergy:s}=e,a={bassEnergy:r,lowMidEnergy:n,midEnergy:i,highMidEnergy:o,trebleEnergy:s},l=Object.keys(a).reduce((e,t)=>a[e]>a[t]?e:t),c={bassEnergy:t.bass,lowMidEnergy:t.lowMid,midEnergy:t.mid,highMidEnergy:t.highMid,trebleEnergy:t.treble}[l],h=a[l]/255;return{r:Math.round(c.r*h),g:Math.round(c.g*h),b:Math.round(c.b*h),a:Math.min(.8,h)}}getDominantFrequency(e){const{bassEnergy:t,lowMidEnergy:r,midEnergy:n,highMidEnergy:i,trebleEnergy:o}=e,s={bass:t,lowMid:r,mid:n,highMid:i,treble:o};return Object.keys(s).reduce((e,t)=>s[e]>s[t]?e:t)}calculateRMS(e){if(!e||0===e.length)return 0;let t=0;for(let r=0;r<e.length;r++)t+=e[r]*e[r];return Math.sqrt(t/e.length)}categorizeAmplitude(e){return e<.01?"silent":e<.1?"quiet":e<.5?"moderate":e<.8?"loud":"peak"}analyzeEnergyProfile(e,t){const r=Math.floor(e.length/100),n=[];for(let i=0;i<100;i++){const o=i*r,s=Math.min((i+1)*r,e.length),a=e.slice(o,s),l=this.calculateRMS(a),c=this.calculateSpectralCentroid(a);n.push({time:i/100*t,energy:l,spectralCentroid:c,variance:this.calculateVariance(a)})}return n}identifyStructuralSections(e,t,r){const n=[];let i=null;return e.forEach((r,o)=>{const s=this.classifySection(r,e,o);i&&i.type===s||(i&&(i.endTime=r.time,n.push(i)),i={type:s,startTime:r.time,endTime:t,confidence:.7})}),i&&n.push(i),n}classifySection(e,t,r){const{energy:n,spectralCentroid:i,variance:o}=e;return r<5?"intro":r>t.length-5?"outro":n>.7&&i>.6?"chorus":n<.3&&o<.2?"break":i<.4&&o>.5?"bridge":"verse"}calculateSpectralCentroid(e){let t=0,r=0;for(let n=0;n<e.length;n++){const i=Math.abs(e[n]);t+=n*i,r+=i}return r>0?t/r/e.length:0}calculateVariance(e){if(0===e.length)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,r=e.reduce((e,r)=>e+Math.pow(r-t,2),0)/e.length;return Math.sqrt(r)}convertToHighContrast(e){const{r:t,g:r,b:n,a:i}=e;return.299*t+.587*r+.114*n>128?{r:255,g:255,b:255,a:i||1}:{r:0,g:0,b:0,a:i||1}}getDefaultWaveformColors(){return[{startTime:0,endTime:1/0,color:{r:6,g:182,b:212,a:.8}}]}destroy(){this.cache.clear()}}export{e as VisualEnhancementEngine};
