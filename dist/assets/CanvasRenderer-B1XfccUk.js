class e{constructor(){this.layers=new Map,this.container=null,this.dimensions={width:0,height:0},this.dpr=window.devicePixelRatio||1}initialize(e){return this.container=e,this.updateDimensions(),this}updateDimensions(){if(!this.container)return!1;const e=this.container.getBoundingClientRect();return this.dimensions={width:e.width||800,height:e.height||200},this.layers.forEach(e=>{this.resizeLayer(e)}),!0}createLayer(e,t=0,i={}){if(this.layers.has(e))return this.layers.get(e);const a=document.createElement("canvas"),s=a.getContext("2d",{alpha:!1!==i.alpha,desynchronized:i.desynchronized||!1,...i.contextOptions});if(!s)throw new Error(`Failed to create 2D context for layer ${e}`);const r={name:e,canvas:a,ctx:s,zIndex:t,visible:!0,dirty:!0,options:i};return this.setupLayer(r),this.layers.set(e,r),r}setupLayer(e){const{canvas:t,zIndex:i}=e;t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex=i,t.style.pointerEvents="none",this.resizeLayer(e),this.configureContext(e),this.container&&this.container.appendChild(t)}resizeLayer(e){const{canvas:t,ctx:i}=e,{width:a,height:s}=this.dimensions;t.style.width=`${a}px`,t.style.height=`${s}px`,t.width=a*this.dpr,t.height=s*this.dpr,i&&(i.scale(this.dpr,this.dpr),this.configureContext(e)),e.dirty=!0}configureContext(e){const{ctx:t,options:i}=e;t.imageSmoothingEnabled=!1!==i.smoothing,t.textBaseline="middle",t.textAlign="left",t.fillStyle="#ffffff",t.strokeStyle="#ffffff",t.lineWidth=1,t.lineCap="round",t.lineJoin="round"}getLayer(e){return this.layers.get(e)}removeLayer(e){const t=this.layers.get(e);return!!t&&(t.canvas.parentNode&&t.canvas.parentNode.removeChild(t.canvas),this.layers.delete(e),!0)}clearLayer(e){const t=this.layers.get(e);if(!t)return!1;const{ctx:i}=t,{width:a,height:s}=this.dimensions;return i.clearRect(0,0,a,s),!0}clearAllLayers(){this.layers.forEach((e,t)=>{this.clearLayer(t)})}setLayerVisibility(e,t){const i=this.layers.get(e);return!!i&&(i.visible=t,i.canvas.style.display=t?"block":"none",!0)}setLayerZIndex(e,t){const i=this.layers.get(e);return!!i&&(i.zIndex=t,i.canvas.style.zIndex=t,!0)}markLayerDirty(e){const t=this.layers.get(e);t&&(t.dirty=!0)}markAllLayersDirty(){this.layers.forEach(e=>{e.dirty=!0})}isLayerDirty(e){const t=this.layers.get(e);return!!t&&t.dirty}markLayerClean(e){const t=this.layers.get(e);t&&(t.dirty=!1)}getLayerNames(){return Array.from(this.layers.keys())}getLayersSorted(){return Array.from(this.layers.values()).sort((e,t)=>e.zIndex-t.zIndex)}enableLayerInteraction(e){const t=this.layers.get(e);t&&(t.canvas.style.pointerEvents="auto")}disableLayerInteraction(e){const t=this.layers.get(e);t&&(t.canvas.style.pointerEvents="none")}destroy(){this.layers.forEach((e,t)=>{this.removeLayer(t)}),this.layers.clear(),this.container=null}getDimensions(){return{...this.dimensions}}getDevicePixelRatio(){return this.dpr}}class t{constructor(e={}){this.state={zoomLevel:1,centerTime:0,visibleTimeRange:{start:0,end:0},pixelsPerSecond:100,canvasDimensions:{width:800,height:200},audioDuration:0,minZoom:.1,maxZoom:100,...e},this.listeners=new Set,this.updateVisibleRange()}addListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>e(this.state))}setCanvasDimensions(e,t){this.state.canvasDimensions={width:e,height:t},this.updateVisibleRange(),this.notifyListeners()}setAudioDuration(e){this.state.audioDuration=e,this.state.centerTime>e&&(this.state.centerTime=e/2),this.updateVisibleRange(),this.notifyListeners()}updateVisibleRange(){const{zoomLevel:e,centerTime:t,canvasDimensions:i,audioDuration:a}=this.state,s=100*e,r=i.width/s,n=r/2;let o=t-n,l=t+n;a>0?o<0?(o=0,l=Math.min(r,a)):l>a&&(l=a,o=Math.max(0,a-r)):o=Math.max(0,o),this.state.visibleTimeRange={start:o,end:l},this.state.pixelsPerSecond=s}setZoom(e,t=null){return e=Math.max(this.state.minZoom,Math.min(this.state.maxZoom,e)),this.state.zoomLevel=e,null!==t&&(this.state.centerTime=t),this.updateVisibleRange(),this.notifyListeners(),this.state}zoomIn(e=2,t=null){return this.setZoom(this.state.zoomLevel*e,t)}zoomOut(e=2,t=null){return this.setZoom(this.state.zoomLevel/e,t)}zoomToFit(){if(this.state.audioDuration<=0)return this.state;const{canvasDimensions:e,audioDuration:t}=this.state,i=e.width/t,a=Math.max(this.state.minZoom,i/100);return this.setZoom(a,t/2)}panToTime(e){return e=this.state.audioDuration>0?Math.max(0,Math.min(this.state.audioDuration,e)):Math.max(0,e),this.state.centerTime=e,this.updateVisibleRange(),this.notifyListeners(),this.state}panBy(e){return this.panToTime(this.state.centerTime+e)}panByPixels(e){const{pixelsPerSecond:t}=this.state,i=e/t;return this.panBy(i)}timeToPixel(e){const{visibleTimeRange:t,canvasDimensions:i}=this.state,a=t.end-t.start;if(a<=0)return 0;return(e-t.start)/a*i.width}pixelToTime(e){const{visibleTimeRange:t,canvasDimensions:i}=this.state,a=t.end-t.start;if(i.width<=0)return t.start;const s=e/i.width;return t.start+s*a}isTimeVisible(e){const{visibleTimeRange:t}=this.state;return e>=t.start&&e<=t.end}isRangeVisible(e,t){const{visibleTimeRange:i}=this.state;return!(t<i.start||e>i.end)}getViewportBounds(){return{...this.state.visibleTimeRange,duration:this.state.visibleTimeRange.end-this.state.visibleTimeRange.start,pixelsPerSecond:this.state.pixelsPerSecond}}getState(){return{...this.state}}reset(){return this.state.zoomLevel=1,this.state.centerTime=this.state.audioDuration/2,this.updateVisibleRange(),this.notifyListeners(),this.state}setLimits({minZoom:e,maxZoom:t}){return void 0!==e&&(this.state.minZoom=Math.max(.01,e)),void 0!==t&&(this.state.maxZoom=Math.min(1e3,t)),this.state.zoomLevel<this.state.minZoom?this.setZoom(this.state.minZoom):this.state.zoomLevel>this.state.maxZoom&&this.setZoom(this.state.maxZoom),this.state}calculateZoomForRange(e,t,i=.1){const a=t-e;if(a<=0)return this.state.zoomLevel;const s=a*(1+2*i),{canvasDimensions:r}=this.state;return r.width/s/100}zoomToRange(e,t,i=.1){const a=(e+t)/2,s=this.calculateZoomForRange(e,t,i);return this.setZoom(s,a)}getDetailLevel(){const{zoomLevel:e,pixelsPerSecond:t}=this.state;return t>=1e3?"sample":t>=400?"high":t>=100?"medium":t>=25?"low":"overview"}getRenderingConfig(){const e=this.getDetailLevel(),{pixelsPerSecond:t,visibleTimeRange:i}=this.state,a={detailLevel:e,pixelsPerSecond:t,visibleDuration:i.end-i.start,showSamplePoints:!1,showZeroCrossings:!1,showGrid:!1,waveformResolution:1,antialiasing:!0};switch(e){case"sample":a.showSamplePoints=!0,a.showZeroCrossings=!0,a.showGrid=!0,a.waveformResolution=1,a.antialiasing=!1;break;case"high":a.showZeroCrossings=!0,a.showGrid=!0,a.waveformResolution=2,a.antialiasing=!0;break;case"medium":a.showGrid=t>=150,a.waveformResolution=4,a.antialiasing=!0;break;case"low":a.waveformResolution=8,a.antialiasing=!0;break;case"overview":a.waveformResolution=16,a.antialiasing=!0}return a}getZoomPresets(){const{audioDuration:e,canvasDimensions:t}=this.state;return[{name:"Fit All",zoomLevel:this.calculateZoomForRange(0,e,.05),description:"Show entire audio file"},{name:"1:1",zoomLevel:1,description:"Default zoom level"},{name:"2x",zoomLevel:2,description:"Double zoom"},{name:"5x",zoomLevel:5,description:"5x zoom for detailed editing"},{name:"10x",zoomLevel:10,description:"10x zoom for precise editing"},{name:"Sample",zoomLevel:Math.max(10,t.width/(44100*e)*100),description:"Sample-level detail"}].filter(e=>e.zoomLevel>=this.state.minZoom&&e.zoomLevel<=this.state.maxZoom)}getNavigationInfo(){const{visibleTimeRange:e,audioDuration:t,zoomLevel:i}=this.state,a=e.end-e.start;return{visiblePercentage:t>0?a/t*100:100,startPercentage:t>0?e.start/t*100:0,endPercentage:t>0?e.end/t*100:100,zoomLevel:i,detailLevel:this.getDetailLevel(),canZoomIn:i<this.state.maxZoom,canZoomOut:i>this.state.minZoom,canPanLeft:e.start>0,canPanRight:e.end<t}}smartZoom(e,t=null){const i=t||this.state.centerTime,a=this.state.zoomLevel*e,s=Math.max(this.state.minZoom,Math.min(this.state.maxZoom,a)),r=s!==a;return this.setZoom(s,i),{newZoomLevel:s,hitLimit:r,limitType:s===this.state.maxZoom?"max":"min"}}getOptimalZoomForSelection(e,t,i=.8){const a=t-e,{canvasDimensions:s}=this.state;return s.width*i/a/100}}class i{constructor(i,a={}){this.container=i,this.options={enableViewportCulling:!0,enableBatching:!0,maxBatchSize:1e3,renderQuality:"high",enableAntialiasing:!0,...a},this.layerManager=new e,this.viewportManager=new t,this.performanceMetrics={frameCount:0,lastFrameTime:0,averageFPS:0,renderTime:0,culledElements:0},this.isRendering=!1,this.renderQueue=[],this.animationFrameId=null,this.drawingCache=new Map,this.pathCache=new Map,this.initialize()}initialize(){return this.layerManager.initialize(this.container),this.createStandardLayers(),this.viewportManager.addListener(e=>{this.handleViewportChange(e)}),this}createStandardLayers(){[{name:"background",zIndex:1,options:{alpha:!1,desynchronized:!0}},{name:"waveform",zIndex:2,options:{alpha:!0,desynchronized:!0}},{name:"chops",zIndex:3,options:{alpha:!0,desynchronized:!1}},{name:"playhead",zIndex:4,options:{alpha:!0,desynchronized:!0}},{name:"interaction",zIndex:5,options:{alpha:!0,desynchronized:!1}},{name:"ui",zIndex:6,options:{alpha:!0,desynchronized:!0}}].forEach(({name:e,zIndex:t,options:i})=>{this.layerManager.createLayer(e,t,i)}),this.layerManager.enableLayerInteraction("interaction")}handleViewportChange(e){this.layerManager.markLayerDirty("waveform"),this.layerManager.markLayerDirty("chops"),this.layerManager.markLayerDirty("playhead"),this.layerManager.markLayerDirty("ui"),this.scheduleRender()}renderWaveform(e,t={}){const i=this.layerManager.getLayer("waveform");if(!i||!e)return;const a=performance.now(),s=this.viewportManager.getViewportBounds(),{ctx:r}=i,{width:n,height:o}=this.layerManager.getDimensions();this.layerManager.clearLayer("waveform");const l=this.viewportManager.getRenderingConfig(),h={...t,...l,quality:t.quality||l.detailLevel},c=this.cullWaveformData(e,s,l.waveformResolution);if(0===c.length)return void this.updatePerformanceMetrics("waveform",a,0);const d=this.selectOptimalRenderMethod(c,s,l);switch(this.configureWaveformContext(r,h),l.showGrid&&this.renderGrid(r,s,n,o),d){case"sample":this.renderWaveformSamples(r,c,s,n,o,h);break;case"peaks":default:this.renderWaveformPeaks(r,c,s,n,o,h);break;case"bars":this.renderWaveformBars(r,c,s,n,o,h);break;case"line":this.renderWaveformLine(r,c,s,n,o,h)}l.showZeroCrossings&&this.renderZeroCrossings(r,c,s,n,o),this.updatePerformanceMetrics("waveform",a,c.length),this.layerManager.markLayerClean("waveform")}cullWaveformData(e,t,i=1){if(!this.options.enableViewportCulling)return e.samples||[];const{samples:a,sampleRate:s}=e;if(!a||!s)return[];const r=Math.floor(t.start*s),n=Math.ceil(t.end*s),o=Math.ceil(.1*s),l=Math.max(0,r-o),h=Math.min(a.length,n+o);let c=a.slice(l,h);if(i>1&&c.length>i){const e=[];for(let t=0;t<c.length;t+=i){let a=0,s=0;for(let e=t;e<Math.min(t+i,c.length);e++)a+=c[e]*c[e],s++;e.push(Math.sqrt(a/s)*Math.sign(c[t]))}c=e}return this.performanceMetrics.culledElements=a.length-c.length,{samples:c,startIndex:l,endIndex:h,sampleRate:s/i}}selectOptimalRenderMethod(e,t,i={}){const{samples:a}=e;if(!a||0===a.length)return"peaks";const{width:s}=this.layerManager.getDimensions();if(s<=0)return"peaks";const r=a.length/s,{detailLevel:n}=i;switch(n){case"sample":return"sample";case"high":return r<2?"line":"bars";case"medium":return r<5?"bars":"peaks";case"low":case"overview":return"peaks";default:return r<1?"sample":r<2?"line":r<10?"bars":"peaks"}}configureWaveformContext(e,t){switch(t.quality||this.options.renderQuality){case"low":e.imageSmoothingEnabled=!1,e.lineWidth=1;break;case"medium":e.imageSmoothingEnabled=!0,e.lineWidth=1.5;break;case"high":e.imageSmoothingEnabled=this.options.enableAntialiasing,e.lineWidth=2}const i=e.createLinearGradient(0,0,0,this.layerManager.getDimensions().height);i.addColorStop(0,t.topColor||"rgba(6, 182, 212, 0.8)"),i.addColorStop(.5,t.centerColor||"rgba(6, 182, 212, 0.4)"),i.addColorStop(1,t.bottomColor||"rgba(6, 182, 212, 0.8)"),e.fillStyle=i,e.strokeStyle=t.strokeColor||"rgba(6, 182, 212, 1)"}renderWaveformPeaks(e,t,i,a,s){const{samples:r}=t;if(!r||0===r.length||a<=0)return;const n=s/2,o=r.length/a;e.beginPath();for(let l=0;l<a;l++){const t=Math.floor(l*o),i=Math.floor((l+1)*o);let a=0,s=0;for(let e=t;e<Math.min(i,r.length);e++){const t=r[e]||0;a=Math.min(a,t),s=Math.max(s,t)}const h=n-a*n,c=n-s*n;e.moveTo(l,h),e.lineTo(l,c)}e.stroke()}renderWaveformBars(e,t,i,a,s){const{samples:r}=t;if(!r||0===r.length)return;const n=s/2,o=Math.max(1,a/r.length);for(let l=0;l<r.length;l++){const t=r[l]||0,i=l*o,a=Math.abs(t)*n;t>=0?e.fillRect(i,n-a,o,a):e.fillRect(i,n,o,a)}}renderWaveformLine(e,t,i,a,s){const{samples:r}=t;if(!r||0===r.length)return;const n=s/2,o=a/r.length;e.beginPath();for(let l=0;l<r.length;l++){const t=l*o,i=n-(r[l]||0)*n;0===l?e.moveTo(t,i):e.lineTo(t,i)}e.stroke(),e.lineTo(a,n),e.lineTo(0,n),e.closePath(),e.globalAlpha=.3,e.fill(),e.globalAlpha=1}renderWaveformSamples(e,t,i,a,s,r={}){const{samples:n}=t;if(!n||0===n.length)return;const o=s/2,l=a/n.length;e.fillStyle=r.strokeColor||"rgba(6, 182, 212, 1)";for(let h=0;h<n.length;h++){const t=h*l,i=o-(n[h]||0)*o;if(e.beginPath(),e.arc(t,i,2,0,2*Math.PI),e.fill(),l>4&&h>0){const a=o-(n[h-1]||0)*o;e.strokeStyle=r.strokeColor||"rgba(6, 182, 212, 0.6)",e.lineWidth=1,e.beginPath(),e.moveTo((h-1)*l,a),e.lineTo(t,i),e.stroke()}}}renderGrid(e,t,i,a){const{start:s,end:r}=t,n=r-s;let o=1;o=n>300?60:n>60?10:n>10?1:n>1?.1:.01,e.strokeStyle="rgba(255, 255, 255, 0.1)",e.lineWidth=1,e.setLineDash&&e.setLineDash([2,4]);for(let l=Math.ceil(s/o)*o;l<=r;l+=o){const t=(l-s)/n*i;e.beginPath(),e.moveTo(t,0),e.lineTo(t,a),e.stroke()}e.setLineDash&&e.setLineDash([]),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(0,a/2),e.lineTo(i,a/2),e.stroke()}renderZeroCrossings(e,t,i,a,s){const{samples:r}=t;if(!r||0===r.length)return;const n=s/2,o=a/r.length;e.strokeStyle="rgba(255, 165, 0, 0.8)",e.lineWidth=1;for(let l=1;l<r.length;l++){const t=r[l-1]||0,i=r[l]||0;if(t>=0&&i<0||t<0&&i>=0){const t=l*o;e.beginPath(),e.moveTo(t,n-10),e.lineTo(t,n+10),e.stroke(),e.fillStyle="rgba(255, 165, 0, 1)",e.beginPath(),e.arc(t,n,2,0,2*Math.PI),e.fill()}}}renderChops(e,t=null,i={}){const a=this.layerManager.getLayer("chops");if(!a||!e.length)return;const s=performance.now(),r=this.viewportManager.getViewportBounds(),{ctx:n}=a,{width:o,height:l}=this.layerManager.getDimensions();this.layerManager.clearLayer("chops");const h=this.cullChops(e,r);0!==h.length?(h.forEach((a,s)=>{this.renderSingleChop(n,a,r,o,l,{isSelected:a.id===t,isHovered:a.id===i.hoveredChopId,isActive:a.id===i.activeChopId,allChops:e,...i})}),this.updatePerformanceMetrics("chops",s,h.length),this.layerManager.markLayerClean("chops")):this.updatePerformanceMetrics("chops",s,0)}cullChops(e,t){return this.options.enableViewportCulling?e.filter(e=>!(e.endTime<t.start||e.startTime>t.end)):e}renderSingleChop(e,t,i,a,s,r={}){const n=this.viewportManager.timeToPixel(t.startTime),o=this.viewportManager.timeToPixel(t.endTime),l=Math.max(0,n),h=Math.min(a,o)-l;if(h<=0)return;const c=t.color||this.generateChopColor(t.id),d=r.isSelected,m=r.isHovered,g=r.isActive,p=d?.6:m?.4:.25,u=d?1:m?.8:.6,f=e.createLinearGradient(l,0,l,s);if(g){const e=.1*Math.sin(Date.now()/300);f.addColorStop(0,this.hexToRgba(c,p+e)),f.addColorStop(.5,this.hexToRgba(c,.7*p+e)),f.addColorStop(1,this.hexToRgba(c,p+e))}else f.addColorStop(0,this.hexToRgba(c,p)),f.addColorStop(.5,this.hexToRgba(c,.7*p)),f.addColorStop(1,this.hexToRgba(c,p));e.fillStyle=f,e.fillRect(l,0,h,s),this.renderChopBoundaries(e,t,n,o,a,s,{color:c,isSelected:d,isHovered:m,isActive:g,borderAlpha:u}),this.renderChopRelationships(e,t,n,o,a,s,r),this.renderChopLabel(e,t,l,h,s,{color:c,isSelected:d,isHovered:m,isActive:g}),h>80&&this.renderDurationIndicator(e,t,l,h,s,c)}renderChopBoundaries(e,t,i,a,s,r,n){const{color:o,isSelected:l,isHovered:h,isActive:c,borderAlpha:d}=n,m=l?4:h?3:2,g=l?6:h?4:0;g>0&&(e.shadowColor=this.hexToRgba(o,.6),e.shadowBlur=g),e.strokeStyle=this.hexToRgba(o,d),e.lineWidth=m,e.beginPath(),i>=0&&i<=s&&(e.moveTo(i,0),e.lineTo(i,r),this.renderBoundaryIndicator(e,i,15,"start",o,l)),a>=0&&a<=s&&(e.moveTo(a,0),e.lineTo(a,r),this.renderBoundaryIndicator(e,a,15,"end",o,l)),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,c&&this.renderActiveChopAnimation(e,i,a,s,r,o)}renderBoundaryIndicator(e,t,i,a,s,r){const n=r?8:6,o="start"===a?1:-1;e.fillStyle=this.hexToRgba(s,.9),e.beginPath(),e.moveTo(t,i),e.lineTo(t+o*n,i-n),e.lineTo(t+o*n,i+n),e.closePath(),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.8)",e.lineWidth=1,e.stroke()}renderActiveChopAnimation(e,t,i,a,s,r){const n=.3+.2*Math.sin(Date.now()/200);e.strokeStyle=this.hexToRgba(r,n),e.lineWidth=6,e.setLineDash([8,4]),e.lineDashOffset=Date.now()/50%12,e.beginPath(),t>=0&&t<=a&&(e.moveTo(t,0),e.lineTo(t,s)),i>=0&&i<=a&&(e.moveTo(i,0),e.lineTo(i,s)),e.stroke(),e.setLineDash([]),e.lineDashOffset=0}renderChopRelationships(e,t,i,a,s,r,n){const o=n.allChops||[];this.analyzeChopRelationships(t,o).forEach(t=>{this.renderRelationshipIndicator(e,t,i,a,s,r)})}analyzeChopRelationships(e,t){const i=[];return t.forEach(t=>{t.id!==e.id&&(e.endTime<=t.startTime||e.startTime>=t.endTime?Math.abs(e.endTime-t.startTime)<=.05?i.push({type:"adjacent-after",chop:t,gap:t.startTime-e.endTime}):Math.abs(t.endTime-e.startTime)<=.05&&i.push({type:"adjacent-before",chop:t,gap:e.startTime-t.endTime}):i.push({type:"overlap",chop:t,severity:this.calculateOverlapSeverity(e,t)}))}),i}calculateOverlapSeverity(e,t){const i=Math.max(e.startTime,t.startTime),a=Math.min(e.endTime,t.endTime)-i,s=e.endTime-e.startTime,r=t.endTime-t.startTime;return a/Math.min(s,r)}renderRelationshipIndicator(e,t,i,a,s,r){const n=this.viewportManager.timeToPixel(t.chop.startTime),o=this.viewportManager.timeToPixel(t.chop.endTime);switch(t.type){case"overlap":this.renderOverlapIndicator(e,i,a,n,o,r,t.severity);break;case"adjacent-after":case"adjacent-before":this.renderAdjacencyIndicator(e,i,a,n,o,r,t.type)}}renderOverlapIndicator(e,t,i,a,s,r,n){const o=Math.max(t,a),l=Math.min(i,s);if(l<=o)return;const h=n>.5?"rgba(239, 68, 68, 0.6)":"rgba(245, 158, 11, 0.6)";e.fillStyle=h,e.fillRect(o,r-8,l-o,8),e.strokeStyle=n>.5?"rgba(239, 68, 68, 0.8)":"rgba(245, 158, 11, 0.8)",e.lineWidth=1,e.setLineDash([3,3]);for(let c=o;c<l;c+=6)e.beginPath(),e.moveTo(c,r-8),e.lineTo(c,r),e.stroke();e.setLineDash([])}renderAdjacencyIndicator(e,t,i,a,s,r,n){const o="adjacent-after"===n?i:t,l="adjacent-after"===n?a:s;e.strokeStyle="rgba(34, 197, 94, 0.6)",e.lineWidth=2,e.setLineDash([4,2]),e.beginPath(),e.moveTo(o,r-20),e.lineTo(l,r-20),e.stroke(),e.fillStyle="rgba(34, 197, 94, 0.8)",e.beginPath(),e.arc(o,r-20,3,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l,r-20,3,0,2*Math.PI),e.fill(),e.setLineDash([])}renderChopLabel(e,t,i,a,s,r){const{color:n,isSelected:o,isHovered:l,isActive:h}=r;if(a<30)return;const c=i+a/2,d=s/2,m=t.padId||t.name||t.id.slice(0,3),g=o?14:12,p=o?"bold":"normal";e.font=`${p} ${g}px monospace`,e.textAlign="center",e.textBaseline="middle";const u=e.measureText(m).width,f=u+8,y=g+8;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(c-f/2,d-y/2,f,y),e.strokeStyle=this.hexToRgba(n,.8),e.lineWidth=1,e.strokeRect(c-f/2,d-y/2,f,y),e.fillStyle=h?"#ffffff":this.hexToRgba(n,1),e.fillText(m,c,d),h&&(e.fillStyle="rgba(34, 197, 94, 0.8)",e.beginPath(),e.arc(c+u/2+8,d,3,0,2*Math.PI),e.fill())}renderDurationIndicator(e,t,i,a,s,r){const n=t.endTime-t.startTime,o=n<1?`${(1e3*n).toFixed(0)}ms`:`${n.toFixed(2)}s`;e.font="10px monospace",e.textAlign="center",e.fillStyle=this.hexToRgba(r,.8);const l=i+a/2;e.fillText(o,l,s-10)}hexToRgba(e,t){if(e.startsWith("hsl"))return e.replace("hsl","hsla").replace(")",`, ${t})`);const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(i){return`rgba(${parseInt(i[1],16)}, ${parseInt(i[2],16)}, ${parseInt(i[3],16)}, ${t})`}return e}generateChopColor(e){if(this.drawingCache.has(`color_${e}`))return this.drawingCache.get(`color_${e}`);let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a)&4294967295;const i=`hsl(${Math.abs(t)%360}, 70%, 50%)`;return this.drawingCache.set(`color_${e}`,i),i}renderPlayhead(e,t=!1,i={}){const a=this.layerManager.getLayer("playhead");if(!a)return;const s=this.viewportManager.getViewportBounds(),{ctx:r}=a,{width:n,height:o}=this.layerManager.getDimensions();if(this.layerManager.clearLayer("playhead"),!this.viewportManager.isTimeVisible(e))return void this.layerManager.markLayerClean("playhead");const l=this.viewportManager.timeToPixel(e);r.strokeStyle=i.color||"#ef4444",r.lineWidth=i.width||2,r.beginPath(),r.moveTo(l,0),r.lineTo(l,o),r.stroke(),r.fillStyle=i.color||"#ef4444";const h=i.indicatorSize||6;if(r.beginPath(),r.moveTo(l-h,0),r.lineTo(l+h,0),r.lineTo(l,2*h),r.closePath(),r.fill(),s.pixelsPerSecond>200&&!1!==i.showTime){r.fillStyle="#ffffff",r.font="10px monospace",r.textAlign="center",r.strokeStyle="#000000",r.lineWidth=3;const t=`${e.toFixed(2)}s`;r.strokeText(t,l,o-10),r.fillText(t,l,o-10)}this.layerManager.markLayerClean("playhead")}renderUI(e={}){const t=this.layerManager.getLayer("ui");if(!t)return;const i=this.viewportManager.getViewportBounds(),{ctx:a}=t,{width:s,height:r}=this.layerManager.getDimensions();this.layerManager.clearLayer("ui"),this.renderTimeScale(a,i,s,r,e),!1!==e.showZoomIndicator&&this.renderZoomIndicator(a,s,r,e),this.layerManager.markLayerClean("ui")}renderTimeScale(e,t,i,a,s){e.fillStyle=s.textColor||"rgba(255, 255, 255, 0.7)",e.font=s.font||"10px monospace",e.textAlign="center";const r=t.end-t.start;let n;n=r>300?60:r>60?10:r>10?1:r>1?.1:.01;for(let o=Math.ceil(t.start/n)*n;o<=t.end;o+=n){const t=this.viewportManager.timeToPixel(o);if(t>=0&&t<=i){e.strokeStyle=s.tickColor||"rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(t,a-10),e.lineTo(t,a),e.stroke();const i=n>=1?`${o.toFixed(0)}s`:`${o.toFixed(2)}s`;e.fillText(i,t,a-15)}}}renderZoomIndicator(e,t,i,a){const s=this.viewportManager.getState().zoomLevel;e.fillStyle=a.zoomIndicatorColor||"rgba(255, 255, 255, 0.8)",e.font=a.zoomIndicatorFont||"bold 12px monospace",e.textAlign="right";const r=`${s.toFixed(1)}x`;e.fillText(r,t-10,20)}scheduleRender(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>{this.performRender(),this.animationFrameId=null}))}performRender(){if(this.isRendering)return;this.isRendering=!0;const e=performance.now();try{for(;this.renderQueue.length>0;){this.renderQueue.shift()()}this.updateFPSMetrics(e)}finally{this.isRendering=!1}}queueRender(e){this.renderQueue.push(e),this.scheduleRender()}updatePerformanceMetrics(e,t,i){const a=performance.now();this.performanceMetrics.renderTime=a-t,this.performanceMetrics[e]||(this.performanceMetrics[e]={totalTime:0,callCount:0,averageTime:0});const s=this.performanceMetrics[e];s.totalTime+=this.performanceMetrics.renderTime,s.callCount++,s.averageTime=s.totalTime/s.callCount}updateFPSMetrics(e){const t=performance.now(),i=t-this.performanceMetrics.lastFrameTime;if(i>0&&this.performanceMetrics.lastFrameTime>0){const e=1e3/i;this.performanceMetrics.frameCount++;const t=.1;0===this.performanceMetrics.averageFPS?this.performanceMetrics.averageFPS=e:this.performanceMetrics.averageFPS=this.performanceMetrics.averageFPS*(1-t)+e*t}this.performanceMetrics.lastFrameTime=t}getPerformanceMetrics(){return{...this.performanceMetrics}}resetPerformanceMetrics(){this.performanceMetrics={frameCount:0,lastFrameTime:performance.now(),averageFPS:0,renderTime:0,culledElements:0}}setRenderQuality(e){this.options.renderQuality=e,this.layerManager.markAllLayersDirty(),this.scheduleRender()}setViewportCulling(e){this.options.enableViewportCulling=e,this.layerManager.markAllLayersDirty(),this.scheduleRender()}resize(e,t){this.layerManager.updateDimensions(),this.viewportManager.setCanvasDimensions(e,t),this.scheduleRender()}getLayerManager(){return this.layerManager}getViewportManager(){return this.viewportManager}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.renderQueue=[],this.drawingCache.clear(),this.pathCache.clear(),this.layerManager.destroy(),this.isRendering=!1}}export{i as CanvasRenderer,i as default};
