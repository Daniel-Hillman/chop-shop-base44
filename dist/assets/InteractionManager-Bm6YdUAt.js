class e{constructor(e={}){this.options={minDistance:32,amplitudeThreshold:.01,analysisWindow:64,maxSearchDistance:.1,...e},this.zeroCrossingCache=new Map}findZeroCrossings(e,t){const a=this.generateCacheKey(e,t);if(this.zeroCrossingCache.has(a))return this.zeroCrossingCache.get(a);const i=[],{minDistance:n,amplitudeThreshold:s,analysisWindow:o}=this.options;let r=-n;for(let h=1;h<e.length;h++){const a=e[h-1],l=e[h];if((a<=0&&l>0||a>=0&&l<0)&&h-r>=n){const n=this.analyzeZeroCrossingQuality(e,h,o,s);n.isSignificant&&(i.push({sampleIndex:h,time:h/t,quality:n.score,amplitude:Math.abs(l),slope:Math.abs(l-a)}),r=h)}}return this.zeroCrossingCache.set(a,i),i}findNearestZeroCrossing(e,t,a,i=null){const n=i||this.options.maxSearchDistance,s=this.findZeroCrossings(e,t);if(0===s.length)return null;let o=null,r=1/0;for(const h of s){const e=Math.abs(h.time-a);e<=n&&e<r&&(r=e,o=h)}return o}findOptimalCutPoints(e,t,a,i){const n=Math.floor(a*t),s=Math.floor(i*t),o=this.findNearestZeroCrossing(e,t,a),r=this.findNearestZeroCrossing(e,t,i),h={originalStart:a,originalEnd:i,optimizedStart:a,optimizedEnd:i,startImprovement:0,endImprovement:0,quality:"original"};if(o){const t=this.calculateCutQualityImprovement(e,n,o.sampleIndex);t>.1&&(h.optimizedStart=o.time,h.startImprovement=t)}if(r){const t=this.calculateCutQualityImprovement(e,s,r.sampleIndex);t>.1&&(h.optimizedEnd=r.time,h.endImprovement=t)}if(h.startImprovement>0||h.endImprovement>0){const e=(h.startImprovement+h.endImprovement)/2;h.quality=e>.7?"excellent":e>.4?"good":"improved"}return h}analyzeZeroCrossingQuality(e,t,a,i){const n=Math.floor(a/2),s=Math.max(0,t-n),o=Math.min(e.length-1,t+n);let r=0,h=0;for(let m=s;m<=o;m++)r+=e[m]*e[m],h++;const l=Math.sqrt(r/h),c=e[t-1]||0,d=e[t+1]||0,p=Math.abs(d-c);return{isSignificant:l>=i&&p>.001,score:(Math.min(l/i,1)+Math.min(10*p,1))/2,rmsAmplitude:l,slope:p,windowStart:s,windowEnd:o}}calculateCutQualityImprovement(e,t,a){if(t<0||t>=e.length||a<0||a>=e.length)return 0;const i=Math.abs(e[t]),n=Math.max(0,i-.01);return Math.min(2*n,1)}getZeroCrossingsInRange(e,t,a,i){return this.findZeroCrossings(e,t).filter(e=>e.time>=a&&e.time<=i)}generateCacheKey(e,t){return`${e.length}_${t}_${e.reduce((e,t,a)=>a%1e3==0?e+Math.abs(t):e,0).toFixed(6)}`}clearCache(){this.zeroCrossingCache.clear()}getCacheStats(){return{size:this.zeroCrossingCache.size,keys:Array.from(this.zeroCrossingCache.keys())}}updateOptions(e){this.options={...this.options,...e},this.clearCache()}}class t{constructor(t={}){this.options={snapTolerance:10,snapToleranceTime:.05,enableZeroCrossingSnap:!0,enableChopBoundarySnap:!0,enableGridSnap:!1,enableBeatSnap:!1,snapPriorities:{zeroCrossing:3,chopBoundary:2,grid:1,beat:1},showSnapIndicators:!0,snapIndicatorColor:"rgba(255, 165, 0, 0.8)",snapIndicatorWidth:2,zeroCrossingOptions:{minDistance:32,amplitudeThreshold:.01,analysisWindow:64,maxSearchDistance:.1},...t},this.zeroCrossingDetector=new e(this.options.zeroCrossingOptions),this.snapTargets=[],this.waveformData=null,this.chops=[]}setWaveformData(e){this.waveformData=e,e?.samples&&e?.sampleRate&&this.zeroCrossingDetector.findZeroCrossings(e.samples,e.sampleRate)}setChops(e){this.chops=e||[]}findSnapTarget(e,t=null,a=null){const i=this.findAllSnapTargets(e,t,a);return 0===i.length?null:(i.sort((e,t)=>e.priority!==t.priority?t.priority-e.priority:e.distance-t.distance),i[0])}findAllSnapTargets(e,t=null,a=null){const i=[],n=this.calculateSnapTolerance(t);if(this.options.enableZeroCrossingSnap&&this.waveformData){const t=this.findZeroCrossingSnapTarget(e,n);t&&i.push(t)}if(this.options.enableChopBoundarySnap){const t=this.findChopBoundarySnapTargets(e,n,a);i.push(...t)}if(this.options.enableGridSnap){const t=this.findGridSnapTarget(e,n);t&&i.push(t)}return i}findZeroCrossingSnapTarget(e,t){if(!this.waveformData?.samples||!this.waveformData?.sampleRate)return null;const a=this.zeroCrossingDetector.findNearestZeroCrossing(this.waveformData.samples,this.waveformData.sampleRate,e,t);if(!a)return null;const i=Math.abs(a.time-e);return{type:"zero-crossing",time:a.time,distance:i,priority:this.options.snapPriorities.zeroCrossing,quality:a.quality,data:a}}findChopBoundarySnapTargets(e,t,a=null){const i=[];for(const n of this.chops){if(n.id===a)continue;const s=Math.abs(n.startTime-e);s<=t&&i.push({type:"chop-boundary",subType:"start",time:n.startTime,distance:s,priority:this.options.snapPriorities.chopBoundary,chopId:n.id,data:n});const o=Math.abs(n.endTime-e);o<=t&&i.push({type:"chop-boundary",subType:"end",time:n.endTime,distance:o,priority:this.options.snapPriorities.chopBoundary,chopId:n.id,data:n})}return i}findGridSnapTarget(e,t){const a=1*Math.round(e/1),i=Math.abs(a-e);return i<=t?{type:"grid",time:a,distance:i,priority:this.options.snapPriorities.grid,interval:1}:null}applySnapping(e,t=null,a=null){const i=this.findSnapTarget(e,t,a);return i?{originalTime:e,snappedTime:i.time,wasSnapped:!0,snapTarget:i,snapDistance:i.distance}:{originalTime:e,snappedTime:e,wasSnapped:!1,snapTarget:null,snapDistance:0}}getSnapIndicators(e,t=null,a=null){if(!this.options.showSnapIndicators)return[];const i=this.findAllSnapTargets(e,t,a),n=this.calculateSnapTolerance(t);return i.filter(e=>e.distance<=n).map(e=>({type:e.type,time:e.time,priority:e.priority,color:this.getSnapIndicatorColor(e.type),width:this.options.snapIndicatorWidth,style:this.getSnapIndicatorStyle(e.type),label:this.getSnapIndicatorLabel(e)}))}getSnapIndicatorColor(e){return{"zero-crossing":"rgba(34, 197, 94, 0.8)","chop-boundary":"rgba(59, 130, 246, 0.8)",grid:"rgba(156, 163, 175, 0.6)",beat:"rgba(245, 101, 101, 0.8)"}[e]||this.options.snapIndicatorColor}getSnapIndicatorStyle(e){return{"zero-crossing":"solid","chop-boundary":"dashed",grid:"dotted",beat:"solid"}[e]||"solid"}getSnapIndicatorLabel(e){switch(e.type){case"zero-crossing":return`Zero crossing (${e.time.toFixed(3)}s)`;case"chop-boundary":return`Chop ${e.subType} (${e.time.toFixed(3)}s)`;case"grid":return`Grid (${e.time.toFixed(1)}s)`;case"beat":return`Beat (${e.time.toFixed(3)}s)`;default:return`Snap (${e.time.toFixed(3)}s)`}}calculateSnapTolerance(e){return e&&e>0?this.options.snapTolerance/e:this.options.snapToleranceTime}updateOptions(e){this.options={...this.options,...e},e.zeroCrossingOptions&&this.zeroCrossingDetector.updateOptions(e.zeroCrossingOptions)}getOptions(){return{...this.options}}setSnapTypes(e){Object.keys(e).forEach(t=>{const a=`enable${t.charAt(0).toUpperCase()+t.slice(1)}Snap`;this.options.hasOwnProperty(a)&&(this.options[a]=e[t])})}getSnapStatistics(){const e={zeroCrossings:0,chopBoundaries:2*this.chops.length,cacheStats:this.zeroCrossingDetector.getCacheStats()};if(this.waveformData?.samples&&this.waveformData?.sampleRate){const t=this.zeroCrossingDetector.findZeroCrossings(this.waveformData.samples,this.waveformData.sampleRate);e.zeroCrossings=t.length}return e}clearCaches(){this.zeroCrossingDetector.clearCache()}}class a{constructor(e,a={}){this.canvasRenderer=e,this.options={clickThreshold:5,hoverDelay:100,snapTolerance:10,enableHover:!0,enableClick:!0,enableDrag:!0,enableSmartSnapping:!0,enableVisualFeedback:!0,enableConflictPrevention:!0,dragSensitivity:1,snapToleranceTime:.05,enableZeroCrossingSnap:!0,enableChopBoundarySnap:!0,showSnapIndicators:!0,...a},this.smartSnapping=new t({snapTolerance:this.options.snapTolerance,snapToleranceTime:this.options.snapToleranceTime,enableZeroCrossingSnap:this.options.enableZeroCrossingSnap,enableChopBoundarySnap:this.options.enableChopBoundarySnap,showSnapIndicators:this.options.showSnapIndicators}),this.isMouseDown=!1,this.isDragging=!1,this.mouseDownPosition={x:0,y:0},this.currentMousePosition={x:0,y:0},this.hoverTimeout=null,this.hoveredElement=null,this.dragState={type:null,startTime:0,endTime:0,chopId:null,boundaryType:null},this.callbacks={onChopCreate:null,onChopUpdate:null,onTimeSeek:null,onHover:null},this.waveformData=null,this.currentSnapResult=null,this.currentChops=[],this.initialize()}initialize(){const e=this.canvasRenderer.getLayerManager().getLayer("interaction");if(!e)return;const t=e.canvas;t.addEventListener("mousedown",this.handleMouseDown.bind(this)),t.addEventListener("mousemove",this.handleMouseMove.bind(this)),t.addEventListener("mouseup",this.handleMouseUp.bind(this)),t.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),t.addEventListener("wheel",this.handleWheel.bind(this)),t.addEventListener("touchstart",this.handleTouchStart.bind(this)),t.addEventListener("touchmove",this.handleTouchMove.bind(this)),t.addEventListener("touchend",this.handleTouchEnd.bind(this)),t.addEventListener("contextmenu",e=>e.preventDefault()),t.tabIndex=0,t.addEventListener("keydown",this.handleKeyDown.bind(this)),t.addEventListener("keyup",this.handleKeyUp.bind(this)),t.style.cursor="crosshair",this.keyState={shift:!1,ctrl:!1,alt:!1}}setCallbacks(e){this.callbacks={...this.callbacks,...e}}setWaveformData(e){this.waveformData=e,this.smartSnapping.setWaveformData(e)}setCurrentChops(e){this.currentChops=e||[],this.smartSnapping.setChops(e)}getCurrentChops(){return this.currentChops||[]}handleMouseDown(e){if(!this.options.enableClick&&!this.options.enableDrag)return;e.preventDefault();const t=e.target.getBoundingClientRect(),a=e.clientX-t.left,i=e.clientY-t.top;this.isMouseDown=!0,this.mouseDownPosition={x:a,y:i},this.currentMousePosition={x:a,y:i},this.clearHover();const n=this.getElementAtPosition(a,i);n?this.handleElementClick(n,a,i,e):this.initializeChopCreation(a,i)}handleMouseMove(e){const t=e.target.getBoundingClientRect(),a=e.clientX-t.left,i=e.clientY-t.top;this.currentMousePosition={x:a,y:i},this.isMouseDown?this.handleDragMove(a,i):this.options.enableHover&&this.handleHoverMove(a,i)}handleMouseUp(e){if(!this.isMouseDown)return;e.preventDefault();const t=e.target.getBoundingClientRect(),a=e.clientX-t.left,i=e.clientY-t.top;this.isDragging?this.finalizeDrag(a,i):this.handleClick(a,i),this.resetInteractionState()}handleMouseLeave(e){this.clearHover(),this.resetInteractionState()}handleWheel(e){e.preventDefault();const t=e.target.getBoundingClientRect(),a=e.clientX-t.left,i=this.canvasRenderer.getViewportManager(),n=i.pixelToTime(a);let s=1.25;e.shiftKey&&(s=1.1),e.ctrlKey&&(s=2),e.deltaY>0?this.smoothZoom(i,1/s,n):this.smoothZoom(i,s,n)}smoothZoom(e,t,a){const i=e.getState().zoomLevel,n=i*t,{minZoom:s,maxZoom:o}=e.getState(),r=Math.max(s,Math.min(o,n));r!==i&&this.animateZoom(e,i,r,a,150)}animateZoom(e,t,a,i,n){const s=performance.now(),o=r=>{const h=r-s,l=Math.min(h/n,1),c=1-Math.pow(1-l,3),d=t+(a-t)*c;e.setZoom(d,i),l<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}getElementAtPosition(e,t){const a=this.canvasRenderer.getViewportManager(),i=a.pixelToTime(e),n=this.getCurrentChops();for(const s of n){const t=a.timeToPixel(s.startTime),n=a.timeToPixel(s.endTime);if(Math.abs(e-t)<=this.options.snapTolerance)return{type:"chop-boundary",chopId:s.id,boundaryType:"start",time:s.startTime,pixel:t};if(Math.abs(e-n)<=this.options.snapTolerance)return{type:"chop-boundary",chopId:s.id,boundaryType:"end",time:s.endTime,pixel:n};if(i>=s.startTime&&i<=s.endTime)return{type:"chop-region",chopId:s.id,chop:s,time:i,pixel:e}}return null}handleElementClick(e,t,a,i){switch(e.type){case"chop-boundary":this.initializeBoundaryDrag(e,t,a);break;case"chop-region":i.shiftKey?this.selectChop(e.chopId):this.seekToTime(e.time)}}initializeChopCreation(e,t){const a=this.canvasRenderer.getViewportManager().pixelToTime(e);this.dragState={type:"create-chop",startTime:a,endTime:a,chopId:null,boundaryType:null}}initializeBoundaryDrag(e,t,a){this.dragState={type:"move-boundary",startTime:e.time,endTime:e.time,chopId:e.chopId,boundaryType:e.boundaryType}}handleDragMove(e,t){const a=Math.sqrt(Math.pow(e-this.mouseDownPosition.x,2)+Math.pow(t-this.mouseDownPosition.y,2));!this.isDragging&&a>this.options.clickThreshold&&(this.isDragging=!0,this.startDrag()),this.isDragging&&this.updateDrag(e,t)}startDrag(){const e=this.canvasRenderer.getLayerManager().getLayer("interaction").canvas;switch(this.dragState.type){case"create-chop":e.style.cursor="col-resize";break;case"move-boundary":e.style.cursor="ew-resize";break;default:e.style.cursor="grabbing"}}updateDrag(e,t){const a=this.canvasRenderer.getViewportManager().pixelToTime(e);switch(this.dragState.type){case"create-chop":this.dragState.endTime=a,this.renderDragPreview();break;case"move-boundary":this.updateBoundaryDrag(a)}}updateBoundaryDrag(e){const t=this.getCurrentChops().find(e=>e.id===this.dragState.chopId);if(!t)return;const a=this.applySmartSnapping(e);if("start"===this.dragState.boundaryType){this.dragState.startTime=Math.min(a,t.endTime-.01);const e=this.findConflictingChop(this.dragState.startTime,t.endTime,t.id);e&&(this.dragState.startTime=Math.max(this.dragState.startTime,e.endTime))}else{this.dragState.endTime=Math.max(a,t.startTime+.01);const e=this.findConflictingChop(t.startTime,this.dragState.endTime,t.id);e&&(this.dragState.endTime=Math.min(this.dragState.endTime,e.startTime))}this.renderDragPreview()}applySmartSnapping(e){if(!this.options.enableSmartSnapping)return e;const t=this.canvasRenderer.getViewportManager(),a=t.getViewportBounds()?.pixelsPerSecond||80,i=this.smartSnapping.applySnapping(e,a,this.dragState.chopId);return this.currentSnapResult=i,i.snappedTime}findConflictingChop(e,t,a){const i=this.getCurrentChops();for(const n of i)if(n.id!==a&&!(t<=n.startTime||e>=n.endTime))return n;return null}renderDragPreview(){const e=this.canvasRenderer.getLayerManager(),t=e.getLayer("interaction");if(!t)return;const{ctx:a}=t,{width:i,height:n}=e.getDimensions(),s=this.canvasRenderer.getViewportManager();switch(e.clearLayer("interaction"),this.dragState.type){case"create-chop":this.renderChopCreationPreview(a,s,i,n);break;case"move-boundary":this.renderBoundaryMovePreview(a,s,i,n)}}renderChopCreationPreview(e,t,a,i){const n=t.timeToPixel(this.dragState.startTime),s=t.timeToPixel(this.dragState.endTime),o=Math.min(n,s),r=Math.max(n,s),h=r-o;if(h>1){const t=e.createLinearGradient(o,0,r,0);t.addColorStop(0,"rgba(59, 130, 246, 0.4)"),t.addColorStop(.5,"rgba(59, 130, 246, 0.2)"),t.addColorStop(1,"rgba(59, 130, 246, 0.4)"),e.fillStyle=t,e.fillRect(o,0,h,i);const a=Date.now()%1e3/1e3*10;e.strokeStyle="rgba(59, 130, 246, 0.9)",e.lineWidth=2,e.setLineDash([8,4]),e.lineDashOffset=a,e.beginPath(),e.moveTo(o,0),e.lineTo(o,i),e.moveTo(r,0),e.lineTo(r,i),e.stroke(),e.setLineDash([]),e.lineDashOffset=0,this.renderDragHandles(e,o,r,i)}this.renderEnhancedTimingInfo(e,o,r,i)}renderBoundaryMovePreview(e,t,a,i){const n=this.getCurrentChops().find(e=>e.id===this.dragState.chopId);if(!n)return;let s=n.startTime,o=n.endTime;"start"===this.dragState.boundaryType?s=this.dragState.startTime:o=this.dragState.endTime;const r=t.timeToPixel(s),h=t.timeToPixel(o),l=.2+.1*Math.sin(Date.now()/200);e.fillStyle=`rgba(34, 197, 94, ${l})`,e.fillRect(r,0,h-r,i);const c="start"===this.dragState.boundaryType?h:r;e.strokeStyle="rgba(34, 197, 94, 0.6)",e.lineWidth=1,e.beginPath(),e.moveTo(c,0),e.lineTo(c,i),e.stroke();const d="start"===this.dragState.boundaryType?r:h;e.shadowColor="rgba(34, 197, 94, 0.8)",e.shadowBlur=8,e.strokeStyle="rgba(34, 197, 94, 1)",e.lineWidth=3,e.beginPath(),e.moveTo(d,0),e.lineTo(d,i),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0,this.renderDragHandle(e,d,i/2,"active"),this.renderSnapIndicators(e,t,a,i),this.renderEnhancedTimingInfo(e,r,h,i)}renderDragHandles(e,t,a,i){this.renderDragHandle(e,t,i/2,"start"),this.renderDragHandle(e,a,i/2,"end")}renderDragHandle(e,t,a,i){const n="active"===i?"rgba(34, 197, 94, 1)":"rgba(59, 130, 246, 1)";e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(t-4,a-4,8,8),e.strokeStyle=n,e.lineWidth=2,e.strokeRect(t-4,a-4,8,8),e.strokeStyle=n,e.lineWidth=1,e.beginPath(),e.moveTo(t-2,a-3),e.lineTo(t-2,a+3),e.moveTo(t,a-3),e.lineTo(t,a+3),e.moveTo(t+2,a-3),e.lineTo(t+2,a+3),e.stroke()}renderSnapIndicators(e,t,a,i){if(!this.options.enableSmartSnapping||!this.options.showSnapIndicators)return;const n="start"===this.dragState.boundaryType?this.dragState.startTime:this.dragState.endTime,s=t.getViewportBounds()?.pixelsPerSecond||80;if(this.smartSnapping.getSnapIndicators(n,s,this.dragState.chopId).forEach(a=>{const n=t.timeToPixel(a.time);switch(e.strokeStyle=a.color,e.lineWidth=a.width,a.style){case"dashed":e.setLineDash([6,4]);break;case"dotted":e.setLineDash([2,2]);break;default:e.setLineDash([])}e.beginPath(),e.moveTo(n,0),e.lineTo(n,i),e.stroke(),this.renderSnapIcon(e,n,i,a),e.setLineDash([])}),this.currentSnapResult?.wasSnapped){const a=t.timeToPixel(this.currentSnapResult.snappedTime);e.shadowColor="rgba(255, 165, 0, 0.6)",e.shadowBlur=8,e.strokeStyle="rgba(255, 165, 0, 1)",e.lineWidth=3,e.beginPath(),e.moveTo(a,0),e.lineTo(a,i),e.stroke(),e.shadowColor="transparent",e.shadowBlur=0}}renderSnapIcon(e,t,a,i){const n=a-20;switch(e.fillStyle=i.color,i.type){case"zero-crossing":e.beginPath(),e.arc(t,n,4,0,2*Math.PI),e.fill(),e.strokeStyle="white",e.lineWidth=1,e.beginPath(),e.moveTo(t-3,n),e.quadraticCurveTo(t-1,n-2,t+1,n),e.quadraticCurveTo(t+3,n+2,t+3,n),e.stroke();break;case"chop-boundary":e.fillRect(t-4,n-4,8,8),e.fillStyle="white","start"===i.subType?(e.beginPath(),e.moveTo(t-2,n),e.lineTo(t+1,n-2),e.lineTo(t+1,n+2),e.fill()):(e.beginPath(),e.moveTo(t+2,n),e.lineTo(t-1,n-2),e.lineTo(t-1,n+2),e.fill());break;case"grid":e.fillRect(t-1,n-4,2,8),e.fillRect(t-4,n-1,8,2);break;default:e.fillRect(t-4,n-4,8,8)}}renderEnhancedTimingInfo(e,t,a,i){const n=Math.min(this.dragState.startTime,this.dragState.endTime),s=Math.max(this.dragState.startTime,this.dragState.endTime),o=(t+a)/2,r=`${(s-n).toFixed(3)}s`,h=`${n.toFixed(3)}s`,l=`${s.toFixed(3)}s`;e.font="11px monospace";const c=e.measureText(r).width,d=e.measureText(h).width,p=e.measureText(l).width,m=Math.max(c,d,p)+12;let u=o-m/2,g=i-54-10;const{width:T}=this.canvasRenderer.getLayerManager().getDimensions();u<5&&(u=5),u+m>T-5&&(u=T-m-5),g<5&&(g=Math.min(t,a)+20),this.drawRoundedRect(e,u,g,m,54,4),e.fillStyle="rgba(0, 0, 0, 0.9)",e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1,e.stroke(),e.fillStyle="white",e.textAlign="center";const y=u+m/2;e.fillText(r,y,g+6+14),e.fillStyle="rgba(255, 255, 255, 0.7)",e.font="10px monospace",e.fillText(`Start: ${h}`,y,g+6+28),e.fillText(`End: ${l}`,y,g+6+42)}drawRoundedRect(e,t,a,i,n,s){e.beginPath(),e.moveTo(t+s,a),e.lineTo(t+i-s,a),e.quadraticCurveTo(t+i,a,t+i,a+s),e.lineTo(t+i,a+n-s),e.quadraticCurveTo(t+i,a+n,t+i-s,a+n),e.lineTo(t+s,a+n),e.quadraticCurveTo(t,a+n,t,a+n-s),e.lineTo(t,a+s),e.quadraticCurveTo(t,a,t+s,a),e.closePath()}handleClick(e,t){if(!this.options.enableClick)return;const a=this.canvasRenderer.getViewportManager().pixelToTime(e);this.createChopAtTime(a)}finalizeDrag(e,t){switch(this.dragState.type){case"create-chop":this.finalizeChopCreation();break;case"move-boundary":this.finalizeBoundaryMove()}this.canvasRenderer.getLayerManager().clearLayer("interaction")}finalizeChopCreation(){let e=Math.min(this.dragState.startTime,this.dragState.endTime),t=Math.max(this.dragState.startTime,this.dragState.endTime);if(t-e>.01){if(this.options.enableConflictPrevention){const a=this.findConflictingChop(e,t,null);a&&(e<a.startTime?t=Math.min(t,a.startTime):e=Math.max(e,a.endTime))}t-e>.01&&this.createChop(e,t)}}finalizeBoundaryMove(){if(!this.getCurrentChops().find(e=>e.id===this.dragState.chopId))return;const e={};"start"===this.dragState.boundaryType?e.startTime=this.dragState.startTime:e.endTime=this.dragState.endTime,this.updateChop(this.dragState.chopId,e)}handleHoverMove(e,t){this.hoverTimeout&&clearTimeout(this.hoverTimeout),this.hoverTimeout=setTimeout(()=>{this.showHoverInfo(e,t)},this.options.hoverDelay)}showHoverInfo(e,t){const a=this.getElementAtPosition(e,t),i=this.canvasRenderer.getViewportManager().pixelToTime(e);a?this.showElementHover(a,e,t):this.showTimeHover(i,e,t)}showElementHover(e,t,a){const i=this.canvasRenderer.getLayerManager(),n=i.getLayer("interaction");if(!n)return;const{ctx:s}=n,{height:o}=i.getDimensions();i.clearLayer("interaction");let r=null;switch(e.type){case"chop-boundary":r=this.createBoundaryTooltipData(e);break;case"chop-region":r=this.createChopTooltipData(e)}r&&(this.renderEnhancedTooltip(s,r,t,a),this.hoveredElement=e,this.callbacks.onHover&&this.callbacks.onHover(e,t,a));const h=n.canvas;switch(e.type){case"chop-boundary":h.style.cursor="ew-resize";break;case"chop-region":h.style.cursor="pointer";break;default:h.style.cursor="crosshair"}}createBoundaryTooltipData(e){const t=this.getCurrentChops().find(t=>t.id===e.chopId);if(!t)return null;const a=t.endTime-t.startTime;return{title:`${"start"===e.boundaryType?"Start":"End"} Boundary`,color:"rgba(34, 197, 94, 0.9)",lines:[`Time: ${e.time.toFixed(3)}s`,`Chop: ${t.padId||t.name||t.id.slice(0,8)}`,`Duration: ${a.toFixed(3)}s`,`Range: ${t.startTime.toFixed(3)}s - ${t.endTime.toFixed(3)}s`],actions:["Drag to adjust boundary","Shift+Click to select chop"]}}createChopTooltipData(e){const t=e.chop,a=t.endTime-t.startTime,i=e.time-t.startTime,n=i/a*100,s=this.analyzeChopRelationships(t),o={title:`Chop ${t.padId||t.name||t.id.slice(0,8)}`,color:t.color||"rgba(59, 130, 246, 0.9)",lines:[`Duration: ${a.toFixed(3)}s`,`Start: ${t.startTime.toFixed(3)}s`,`End: ${t.endTime.toFixed(3)}s`,`Position: ${i.toFixed(3)}s (${n.toFixed(1)}%)`],actions:["Click to seek to position","Shift+Click to select","Drag boundaries to adjust"]};return s.length>0&&(o.lines.push(""),o.lines.push("Relationships:"),s.forEach(e=>{switch(e.type){case"overlap":const t=e.severity>.5?"Major":"Minor";o.lines.push(`⚠ ${t} overlap with ${e.chop.padId||e.chop.id.slice(0,3)}`);break;case"adjacent-after":o.lines.push(`→ Adjacent to ${e.chop.padId||e.chop.id.slice(0,3)}`);break;case"adjacent-before":o.lines.push(`← Adjacent from ${e.chop.padId||e.chop.id.slice(0,3)}`)}})),o}analyzeChopRelationships(e){const t=this.getCurrentChops(),a=[];return t.forEach(t=>{if(t.id!==e.id)if(e.endTime<=t.startTime||e.startTime>=t.endTime)Math.abs(e.endTime-t.startTime)<=.05?a.push({type:"adjacent-after",chop:t,gap:t.startTime-e.endTime}):Math.abs(t.endTime-e.startTime)<=.05&&a.push({type:"adjacent-before",chop:t,gap:e.startTime-t.endTime});else{const i=Math.max(e.startTime,t.startTime),n=Math.min(e.endTime,t.endTime)-i,s=e.endTime-e.startTime,o=t.endTime-t.startTime,r=Math.min(s,o);a.push({type:"overlap",chop:t,severity:n/r})}}),a}showTimeHover(e,t,a){const i=this.canvasRenderer.getLayerManager(),n=i.getLayer("interaction");if(!n)return;const{ctx:s}=n;i.clearLayer("interaction");const o=`${e.toFixed(3)}s`;this.renderHoverTooltip(s,o,t,a,"rgba(255, 255, 255, 0.9)"),n.canvas.style.cursor="crosshair"}renderEnhancedTooltip(e,t,a,i){const n=10;e.font="11px monospace";let s=0;e.font="bold 12px monospace";const o=e.measureText(t.title).width;s=Math.max(s,o),e.font="11px monospace",t.lines.forEach(t=>{if(t.trim()){const a=e.measureText(t).width;s=Math.max(s,a)}}),e.font="10px monospace",t.actions&&t.actions.forEach(t=>{const a=e.measureText(t).width;s=Math.max(s,a)});const r=s+20,h=t.lines.filter(e=>e.trim()).length,l=t.actions?t.actions.length:0,c=t.actions&&l>0?6:0,d=16+14*h+c+12*l+20,{width:p,height:m}=this.canvasRenderer.getLayerManager().getDimensions();let u=a+15,g=i-d-10;u+r>p-10&&(u=a-r-15),u<10&&(u=10),g<10&&(g=i+20),g+d>m-10&&(g=m-d-10),this.drawTooltipBackground(e,u,g,r,d,t.color);let T=g+n+16-2;e.font="bold 12px monospace",e.fillStyle=t.color,e.textAlign="left",e.fillText(t.title,u+n,T),T+=4,e.font="11px monospace",e.fillStyle="rgba(255, 255, 255, 0.9)",t.lines.forEach(t=>{t.trim()&&(T+=14,t.includes("⚠")?e.fillStyle="rgba(245, 158, 11, 0.9)":t.includes("→")||t.includes("←")?e.fillStyle="rgba(34, 197, 94, 0.9)":t.includes("Relationships:")?e.fillStyle="rgba(156, 163, 175, 0.9)":e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillText(t,u+n,T))}),t.actions&&l>0&&(T+=c,e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(u+n,T-2),e.lineTo(u+r-n,T-2),e.stroke()),t.actions&&(e.font="10px monospace",e.fillStyle="rgba(156, 163, 175, 0.8)",t.actions.forEach(t=>{T+=12,e.fillText(`• ${t}`,u+n,T)}))}drawTooltipBackground(e,t,a,i,n,s){e.shadowColor="rgba(0, 0, 0, 0.3)",e.shadowBlur=8,e.shadowOffsetX=2,e.shadowOffsetY=2,e.fillStyle="rgba(0, 0, 0, 0.92)",this.drawRoundedRect(e,t,a,i,n,6),e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle=s,e.lineWidth=2,this.drawRoundedRect(e,t,a,i,n,6),e.stroke(),e.strokeStyle=`${s}40`,e.lineWidth=1,this.drawRoundedRect(e,t+1,a+1,i-2,n-2,5),e.stroke()}renderHoverTooltip(e,t,a,i,n){const s={title:t,color:n,lines:[],actions:null};this.renderEnhancedTooltip(e,s,a,i)}clearHover(){if(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.hoveredElement){const e=this.canvasRenderer.getLayerManager();e.clearLayer("interaction");const t=e.getLayer("interaction");t&&(t.canvas.style.cursor="crosshair"),this.hoveredElement=null}}resetInteractionState(){this.isMouseDown=!1,this.isDragging=!1,this.dragState={type:null,startTime:0,endTime:0,chopId:null,boundaryType:null};const e=this.canvasRenderer.getLayerManager().getLayer("interaction");e&&(e.canvas.style.cursor="crosshair")}handleTouchStart(e){e.preventDefault();const t=e.touches[0],a={type:"mousedown",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{},target:e.target};this.handleMouseDown(a)}handleTouchMove(e){e.preventDefault();const t=e.touches[0],a={type:"mousemove",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{},target:e.target};this.handleMouseMove(a)}handleTouchEnd(e){e.preventDefault();const t={type:"mouseup",clientX:this.currentMousePosition.x,clientY:this.currentMousePosition.y,preventDefault:()=>{},target:e.target};this.handleMouseUp(t)}handleKeyDown(e){this.keyState.shift=e.shiftKey,this.keyState.ctrl=e.ctrlKey,this.keyState.alt=e.altKey;const t=this.canvasRenderer.getViewportManager(),a=t.getState();switch(e.code){case"Equal":case"NumpadAdd":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.smoothZoom(t,1.5,a.centerTime));break;case"Minus":case"NumpadSubtract":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.smoothZoom(t,1/1.5,a.centerTime));break;case"Digit0":case"Numpad0":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.animateZoomToFit(t));break;case"ArrowLeft":e.preventDefault(),this.handleKeyboardPan(t,"left",e.shiftKey);break;case"ArrowRight":e.preventDefault(),this.handleKeyboardPan(t,"right",e.shiftKey);break;case"Home":e.preventDefault(),this.animatePanToTime(t,0);break;case"End":e.preventDefault(),this.animatePanToTime(t,a.audioDuration);break;case"Digit1":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.animateZoomToLevel(t,1,a.centerTime));break;case"Digit2":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.animateZoomToLevel(t,2,a.centerTime));break;case"Digit5":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.animateZoomToLevel(t,5,a.centerTime));break;case"PageUp":e.preventDefault(),this.handleKeyboardPan(t,"left",!0);break;case"PageDown":e.preventDefault(),this.handleKeyboardPan(t,"right",!0)}}handleKeyUp(e){this.keyState.shift=e.shiftKey,this.keyState.ctrl=e.ctrlKey,this.keyState.alt=e.altKey}handleKeyboardPan(e,t,a=!1){const i=e.getState(),n=i.visibleTimeRange.end-i.visibleTimeRange.start;let s=.1*n;a&&(s=.5*n);const o="left"===t?i.centerTime-s:i.centerTime+s;this.animatePanToTime(e,o)}animatePanToTime(e,t,a=200){const i=performance.now(),n=e.getState().centerTime,s=o=>{const r=o-i,h=Math.min(r/a,1),l=1-Math.pow(1-h,3),c=n+(t-n)*l;e.panToTime(c),h<1&&requestAnimationFrame(s)};requestAnimationFrame(s)}animateZoomToLevel(e,t,a,i=200){const n=performance.now(),s=e.getState().zoomLevel,o=r=>{const h=r-n,l=Math.min(h/i,1),c=1-Math.pow(1-l,3),d=s+(t-s)*c;e.setZoom(d,a),l<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}animateZoomToFit(e,t=300){const a=e.getState(),i=a.audioDuration/2,{canvasDimensions:n,audioDuration:s}=a,o=n.width/s,r=Math.max(a.minZoom,o/100),h=performance.now(),l=a.zoomLevel,c=a.centerTime,d=a=>{const n=a-h,s=Math.min(n/t,1),o=1-Math.pow(1-s,3),p=l+(r-l)*o,m=c+(i-c)*o;e.setZoom(p,m),s<1&&requestAnimationFrame(d)};requestAnimationFrame(d)}createChopAtTime(e){if(this.callbacks.onChopCreate){const t=.1,a=Math.max(0,e-t/2),i=a+t;this.callbacks.onChopCreate(a,i)}}createChop(e,t){this.callbacks.onChopCreate&&this.callbacks.onChopCreate(e,t)}updateChop(e,t){this.callbacks.onChopUpdate&&this.callbacks.onChopUpdate(e,t)}seekToTime(e){this.callbacks.onTimeSeek&&this.callbacks.onTimeSeek(e)}selectChop(e){this.callbacks.onChopUpdate&&this.callbacks.onChopUpdate(e,{selected:!0})}getCurrentChops(){return this.currentChops||[]}setCurrentChops(e){this.currentChops=e}pixelToTime(e){return this.canvasRenderer.getViewportManager().pixelToTime(e)}timeToPixel(e){return this.canvasRenderer.getViewportManager().timeToPixel(e)}setInteractionEnabled(e,t){switch(e){case"click":this.options.enableClick=t;break;case"drag":this.options.enableDrag=t;break;case"hover":this.options.enableHover=t,t||this.clearHover()}}destroy(){this.clearHover(),this.resetInteractionState();const e=this.canvasRenderer.getLayerManager().getLayer("interaction");if(e){const t=e.canvas;t.removeEventListener("mousedown",this.handleMouseDown),t.removeEventListener("mousemove",this.handleMouseMove),t.removeEventListener("mouseup",this.handleMouseUp),t.removeEventListener("mouseleave",this.handleMouseLeave),t.removeEventListener("wheel",this.handleWheel),t.removeEventListener("touchstart",this.handleTouchStart),t.removeEventListener("touchmove",this.handleTouchMove),t.removeEventListener("touchend",this.handleTouchEnd)}}}export{a as InteractionManager,a as default};
